sap.ui.define(["sap/ui/core/mvc/Controller","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/merge","sap/base/util/deepExtend","sap/ui/Device"],function(C,l,F,m,d,D){"use strict";var L=new F("listTemplates.controller.SmartChartController").getLogger();var v={};var V={};var E=false;var c=C.extend("sap.suite.ui.generic.template.listTemplates.controller.SmartChartController",{setState:function(s){this.triggeredByTableSort=false;this.tableSortSelection;this._selectFilterByMeasure=false;this.oState=s;s.oSmartChart.attachInitialized(this._onSmartChartInit,this);s.oSmartChart.attachBeforeRebindChart(this._onBeforeRebindChart,this);s.oSmartChart.attachDataReceived(this._onDataReceived,this);},_onBeforeRebindChart:function(o){if(this.triggeredByTableSort&&this.tableSortSelection){var a=this.oState.oSmartChart.fetchVariant();if(this.tableSortSelection.length>0){a.sort={};a.sort.sortItems=[];for(var i=0;i<(this.tableSortSelection.length);i++){o.mParameters.bindingParams.sorter.push(this.tableSortSelection[i]);a.sort.sortItems.push({columnKey:this.tableSortSelection[i].sPath,operation:this.tableSortSelection[i].bDescending?"Descending":"Ascending"});}}else{o.mParameters.bindingParams.sorter=this.tableSortSelection;if(a.sort){delete a.sort;}}this.oState.oSmartChart.applyVariant(a);this.triggeredByTableSort=false;}if(this.oState.oSmartFilterbar&&this.oState.oSmartFilterbar.getAnalyticBindingPath&&this.oState.oSmartFilterbar.getConsiderAnalyticalParameters()){try{var A=this.oState.oSmartFilterbar.getAnalyticBindingPath();if(A){this.oState.oSmartChart.setChartBindingPath(A);}}catch(e){L.warning("Mandatory parameters have no values");}}this.oState.oController.onBeforeRebindChartExtension(o);this.oState.oTemplateUtils.oCommonUtils.onBeforeRebindTableOrChart(o,{addExtensionFilters:this.oState.oController.templateBaseExtension.addFilters,isMandatoryFiltersRequired:false,isFieldControlRequired:false},this.oState.oSmartFilterbar);l.handleErrorsOnTableOrChart(this.oState.oTemplateUtils,o);},_onDataReceived:function(e){if(!this.oState.oSmartChart.getToolbar().getEnabled()){this.oState.oContentArea.enableToolbar();}this.oState.oTemplateUtils.oCommonUtils.setEnabledToolbarButtons(e.getSource());this.oState.oTemplateUtils.oComponentUtils.hidePlaceholder();},_onSmartChartInit:function(e){var s=this.oState;var o=m({},e);s.oSmartChart.getChartAsync().then(function(a){this.oChart=a;if(D.browser.safari){s.oSmartChart.setHeight("50vH");}else{s.oSmartChart.setHeight("100%");}a.setHeight("100%");this._chartInfo={};this._chartInfo.drillStack=this.oChart.getDrillStack();s.oSmartChart.attachShowOverlay(function(f){s.oSmartChart.getToolbar().setEnabled(!f.getParameter("overlay").show);},this);this.oState.oTemplateUtils.oCommonUtils.setEnabledToolbarButtons(o.getSource());this.oState.oTemplateUtils.oCommonUtils.checkToolbarIntentsSupported(o.getSource());this.oChart.attachSelectData(this._onChartSelectData,this);this.oChart.attachDeselectData(this._onChartDeselectData,this);this.oState.oSmartChart.attachChartDataChanged(this._onPersonalisationDimeasureChange,this);if(this.oState._pendingChartToolbarInit&&this.oState.oSmartTable){if(!this.oState.oSmartFilterableKPI&&!this.oState.oMultipleViewsHandler.getMode()){this.oState.oSmartChart.getToolbar().insertContent(this.oState.alr_viewSwitchButtonOnChart,this.oState.oSmartChart.getToolbar().getContent().length);}}delete this.oState._pendingChartToolbarInit;this._changeValueAxisTitleVisibility();var b=this.oState.oController.getOwnerComponent();var S=b&&b.getChartSettings()&&b.getChartSettings().showDataLabel;E=b&&b.getChartSettings().enableStableColors;v={"legendGroup":{"layout":{"position":"bottom"}},"categoryAxis":{"layout":{"maxHeight":0.5}}};V={"plotArea":{"dataLabel":{"visible":false}}};if(S){V.plotArea.dataLabel.visible=true;Object.assign(v,V);}if(E){this.applyStableColoringToChart();}else{this.oChart.setVizProperties(v);}this.oState.oSmartChart.attachSelectionDetailsActionPress(function(f){var g=f.getSource();var h=f.getParameter("itemContexts")&&f.getParameter("itemContexts")[0];s.oTemplateUtils.oCommonUtils.fnProcessDataLossOrDraftDiscardConfirmation(function(){if(!h){L.error("Binding context for the selected chart item is missing");return;}if(g.data("CrossNavigation")){s.oTemplateUtils.oCommonEventHandlers.onEditNavigateIntent(g,h,s.oSmartFilterbar,s.oSmartChart.oChart);return;}s.oTemplateUtils.oCommonUtils.navigateFromListItem(h);},Function.prototype);});L.info("Smart Chart Annotation initialized");}.bind(this));},_onChartSelectData:function(e){this.oState.oController.getOwnerComponent().getModel("_templPriv").setProperty('/alp/_ignoreChartSelections',(e.getId()==="chartDataChanged"));var a=this.oChart;this._chartInfo.drillStack=a.getDrillStack();var o=a._getVizFrame().vizSelection();if(o){this._chartInfo.vizSelection=o;this._chartInfo.chartSelectionBehavior=this.oChart.getSelectionBehavior();this._chartInfo.chartSelection=this.oState.oTemplateUtils.oCommonUtils.getSelectionPoints(a,this._chartInfo.chartSelectionBehavior);var s=this._chartInfo.chartSelection.dataPoints;this._lastSelected=this._getLastSel(s,this._lastSelectedList);this._lastSelectedList=s;}this._updateTable();this.oState.oTemplateUtils.oCommonUtils.setEnabledToolbarButtons(e.getSource(),this._chartInfo.chartSelectionBehavior,this._chartInfo.chartSelection);this.oState.oIappStateHandler.fnStoreCurrentAppStateAndAdjustURL();},_onPersonalisationDimeasureChange:function(e){if(E){this.applyStableColoringToChart();}this._changeValueAxisTitleVisibility();},applyStableColoringToChart:function(){var o=this.oState.oController.getOwnerComponent();var r=[];var a=o.getChartSettings().dimensionSettings;var b=Object.keys(a);var e={};for(var i=0;i<b.length;i++){var f=b[i];var g=Object.keys(a[b[i]]);if(this.oChart.getVisibleDimensions().indexOf(f)>-1){for(var j=0;j<g.length;j++){var R={properties:{},dataContext:{},displayName:""};var s=g[j];R.dataContext[f]=s;R.displayName=s;if(a[f][g[j]].color){R.properties["color"]=a[f][g[j]].color;}r.push(R);}}if(f==="default"){e["others"]={"properties":{color:a[f].color}};}}V.plotArea.dataPointStyle=V.plotArea.dataPointStyle||{};V.plotArea.dataPointStyle=e;V.plotArea.dataPointStyle["rules"]=r;Object.assign(v,V);this.oChart.setVizProperties(v);},_getLastSel:function(n,o){var b=this.oChart;var e=this.oState.detailController&&this.oState.detailController._getSelParamsFromDPList(n);var f=this.oState.detailController&&this.oState.detailController._getSelParamsFromDPList(o);if(e){for(var i=0;i<e.length;i++){var g=e[i];var h=false;for(var j=0;j<f.length;j++){var k=f[j];h=true;for(var a in k){if(a.indexOf("__")!=-1){continue;}if(g[a]!=k[a]){h=false;break;}}if(h){break;}}if(!h){var p=b.getVisibleDimensions();var q={};for(var j=0;j<p.length;j++){var r=p[j];q[r]=g[r];}return q;}}}return null;},_onChartDeselectData:function(e){var a=this;this._lastSelected=null;var o=d({},e);setTimeout(function(){var f=a.oChart;if(f.getSelectedDataPoints().count==0){a._updateTable();}else if(f.getSelectionMode()=="MULTIPLE"){a._onChartSelectData(o);}},1);var b=e.getParameter("oSource");if(b&&b instanceof sap.m.Link&&b.getParent()instanceof sap.m.Breadcrumbs){a._onChartDrilledUp(e);}this.oState.oTemplateUtils.oCommonUtils.setEnabledToolbarButtons(e.getSource());this.oState.oTemplateUtils.oCommonUtils.setEnabledFooterButtons(e.getSource());},_onChartDrilledUp:function(e){this._updateTable();},_onChartDrilledDown:function(e){this._updateTable();},_updateTable:function(){var a=this.oChart;if(!a){return;}var b=[];var o=this._chartInfo.vizSelection;o=o||a._getVizFrame().vizSelection();if(o&&o.length){b=this._chartInfo.chartSelection.dataPoints;}if(!b||b.length==0){this._lastSelected=null;}if(this.oState.detailController){this.oState.detailController.applyParamsToTable();}},_changeValueAxisTitleVisibility:function(e){if(this.oChart.getChartType().indexOf("dual_")==0){this.oChart.setVizProperties({"valueAxis":{"title":{"visible":true}}});}else{this.oChart.setVizProperties({"valueAxis":{"title":{"visible":false}}});}}});return c;});
