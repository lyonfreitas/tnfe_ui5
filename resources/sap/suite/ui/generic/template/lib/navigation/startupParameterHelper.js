sap.ui.define(["sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/each","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper","sap/base/util/deepExtend"],function(e,a,b,M,F,c,o,d,f,D,t,C,g){"use strict";var s="lib.navigation.startupParameterHelper";var l=new f(s).getLogger();function h(i,Q){return{mode:i&&Q&&(Q!==i)?"inconsistent":Q||i||"display",force:!!Q};}function p(i,Q,R,S){var U=r(Q,R,"Edm.DateTime");j(U,S);var V=i.oAppComponent.getModel("_templPrivGlobal");V.setProperty("/generic/forceFullscreenCreate",true);}function T(i,Q){if(a(Q)){return;}i.forEach(function(R){var S=Q[R.name];if(S){var U=S[0];U=U.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!U.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){U=U.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}S[0]=U;}});}function j(i,Q){if(a(Q)){return;}i.forEach(function(R){var S=Q[R.name];if(S&&typeof S[0]==="string"&&R["type"]==="Edm.DateTime"&&R["sap:display-format"]==="Date"){var U=new Date(S[0]);S[0]=U;}});}function r(i,Q,R){var S=i.getMetaModel();var U=S.getODataEntitySet(Q);var V=U&&U.entityType;var W=S.getODataEntityType(V);var X=(W&&W.property)||[];var Y=[];X.forEach(function(Z){if(R===Z.type){Y.push(Z);}});return Y;}function k(i,Q,R){if(a(R)){return;}var S=r(i,Q,"Edm.Guid");T(S,R);}function m(i){var Q=i.oAppComponent.getInboundParameters();return Q?Object.keys(Q).filter(function(R){return Q[R].useForCreate;}):[];}function P(Q,R){var S;var U=m(Q);for(var i=0;i<U.length;i++){var V=U[i];var W=R[V];if(W&&W.length===1){S=S||Object.create(null);S[V]=W[0];}}return S;}function n(i,Q,R){var S=i.getODataEntityType(i.getODataEntitySet(Q).entityType);S.property.forEach(function(U){if(U["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var V=U["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||U["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var W=U.name;if(R[V]&&!R[W]){R[W]=R[V];}if(R[W]&&!R[V]){R[V]=R[W];}}});}function q(i,Q){return!(i.page.navigation&&i.page.navigation[Q.mode]);}function u(i,Q){return!!i&&i.every(function(R){var S=R.name||R.PropertyPath;var U=Q[S]||[];return U.length===1;});}function v(i){var S=D.splitCanonicalPath(i);return S.key;}function w(i,Q,R,S,U){if(R.noKey){return{treeNode:R,navigationPossible:true,keyValue:""};}var V=Q.getODataEntitySet(R.entitySet);if(!V){return null;}var W=Q.getODataEntityType(V.entityType);var X=W["com.sap.vocabularies.Common.v1.SemanticKey"];if(u(X,S)){return{treeNode:R,key:X,isSemantic:true};}return U&&W.key.propertyRef&&u(W.key.propertyRef,S)&&{treeNode:R,navigationPossible:true,keyValue:v(i.createKey(R.entitySet,S))};}function x(i,Q,R,S,U,V,W){S.children.forEach(function(X){var Y=R.mEntityTree[X];if(Y.page.component.settings&&Y.page.component.settings.allowDeepLinking&&q(Y,V)){var Z=w(i,Q,Y,U,false);if(Z){W[Y.sRouteName]=Z;x(i,Q,R,Y,U,V,W);}}});}function y(i,Q,R,S,U){var V=Object.create(null);V.root={treeNode:Q.mRoutingTree.root,navigationPossible:true,keyValue:""};var W=Q.mEntityTree[R];if(W&&!(W.page.component.settings&&W.page.component.settings.allowDeepLinking===false)&&q(W,U)){var X=i.getMetaModel();var Y=w(i,X,W,S,true);if(Y){V[W.sRouteName]=Y;if(U.mode==="display"){x(i,X,Q,W,S,U,V);}}}return V;}function z(i,Q){var R=Q.key.map(function(U){var V=U.PropertyPath;var W=i[V][0];return new F(V,c.EQ,W);});if(Q.treeNode.isDraft){var S=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});R.push(S);}return new F(R,true);}function A(Q,R,S){var U=S.treeNode.entitySet;var V="/"+U;try{var W=new o.Model(o.Model.ReferenceByModel(Q));var X=W.findQueryResultByName(U);var Y=new o.QueryResultRequest(X);var Z=X&&X.getParameterization();var $=false;if(Z){Y.setParameterizationRequest(new o.ParameterizationRequest(Z));var _=Z.getAllParameterNames();b(_,function(){if(R.hasOwnProperty(this)){$=true;Y.getParameterizationRequest().setParameterValue(this,R[this][0]);}});for(var i=0;i<_.length;i++){if(_[i].startsWith("P_")){var a1=_[i].substr(2);if(R.hasOwnProperty(a1)){$=true;Y.getParameterizationRequest().setParameterValue(_[i],R[a1][0]);}}}if($){V=Y.getURIToQueryResultEntitySet();}}}catch(b1){l.info(b1.name+":"+b1.message);}return V;}function B(R){if(!(R&&R.results)){return null;}var i;R.results.some(function(Q){i=Q;return Q.IsActiveEntity;});return i;}function E(i,Q,R){var S=z(Q,R);var U=A(i,Q,R);return new Promise(function(V){i.read(U,{filters:[S],success:function(W){var X=B(W);var Y=X&&i.getKey(X);var Z=Y&&v(Y);V(Z);},error:function(){V();}});});}function N(Q,R,S,U){var V=Object.keys(S).filter(function(i){return!S[i].navigationPossible;});var W=V.map(function(i){var X=S[i];return E(R,U,X);});return Promise.all(W).then(function(X){for(var i=0;i<V.length;i++){var Y=S[V[i]];Y.keyValue=X[i];}var Z=function(d1){var Y=S[d1];if(Y.navigationPossible===undefined){Y.navigationPossible=!!Y.keyValue&&Z(Y.treeNode.parentRoute);}return Y.navigationPossible;};var $;b(S,function(d1){if(Z(d1)){var e1=S[d1].treeNode;$=(!$||$.level<e1.level)?e1:$;}});var _=[];for(var a1=$;a1;a1=a1.level&&Q.mRoutingTree[a1.parentRoute]){_[a1.level]=S[a1.sRouteName].keyValue;}var b1=Object.create(null);if(Q.oFlexibleColumnLayoutHandler){Q.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation($,b1);}var c1={treeNode:$,keys:_,appStates:b1};return Q.oNavigationControllerProxy.navigateToIdentity(c1,true,1).then(Function.prototype);});}function G(i){var Q=i.oAppComponent.getInboundParameters();return Q?Object.keys(Q).filter(function(R){return Q[R].useForTargetResolution;}):[];}function H(Q,R,S){if(R==="create"&&Q.mRoutingTree.root.page.component.settings&&Q.mRoutingTree.root.page.component.settings.creationEntitySet){return Promise.resolve(Q.mRoutingTree.root.page.component.settings.creationEntitySet);}var U=G(Q);if(U.length){for(var V in Q.mRoutingTree){var W=Q.mRoutingTree[V].page.component.settings;if(W&&W.targetResolution){var X=W.targetResolution;for(var Y in X){for(var i=0;i<U.length;i++){if(U[i]===Y&&(X[Y]===(S[Y]&&S[Y][0]))){return Promise.resolve(Q.mRoutingTree[V].entitySet);}}}}}}return Q.myIntentPromise?Q.myIntentPromise.then(function(Z){var $=Q.mRoutingTree.root.children;for(var i=0;i<$.length;i++){var V=$[i];if(Q.mEntityTree[V].semanticObject===Z.semanticObject){return V;}}return Q.mRoutingTree.root.entitySet;}):Promise.resolve(Q.mRoutingTree.root.entitySet);}function I(i,Q,R,S){Q=g({},Q);p(i,R,S,Q);var U=P(i,Q);var V=i.oAppComponent.getTransactionController().getDraftController();var W=V.getDraftContext().isDraftEnabled(S);if(W){var X=i.mEntityTree[S]||i.mRoutingTree.root;i.oNavigationControllerProxy.prepareHostView(X);var Y=i.oNavigationControllerProxy.oRouter.getTargets();Y.display(X.sRouteName);return X.componentCreated.then(function($){var _=i.componentRegistry[$.getId()];return _.viewRegistered.then(function(){var a1=null;var b1=_.oController;var c1=i.oAppComponent.getApplicationController();var d1=!!(i.mRoutingTree.root.page.component.settings&&i.mRoutingTree.root.page.component.settings.useNewActionForCreate);var e1={sRootExpand:a1,oController:b1,oApplicationController:c1,bUseNewActionForCreate:d1};var f1=C.create(V,S,"/"+S,R,i.oApplicationProxy,U,e1);return f1.then(function(g1){var Z=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var X=i.mEntityTree[S];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(X,Z);}return i.oNavigationControllerProxy.navigateToSubContext(g1,true,4,null,Z).then(Function.prototype);},function(g1){return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:g1.messageText,description:"",icon:"sap-icon://message-error"};});});});}var Z=Object.create(null);if(i.oFlexibleColumnLayoutHandler){i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(i.mEntityTree[S],Z);}return i.oNavigationControllerProxy.navigateForNonDraftCreate(S,U,null,Z).then(Function.prototype);}function J(Q,R,S,U){R=g({},R);p(Q,S,U,R);return new Promise(function(V){var W=function(c1){V({title:Q.getText("ST_ERROR"),text:(c1&&c1.messageText)||Q.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),icon:"sap-icon://message-error",description:""});};var X=S.getMetaModel().getODataEntitySet(U);var Y=X["com.sap.vocabularies.Common.v1.DraftRoot"];if(Y&&Y.NewAction){var Z=S.getMetaModel().getODataFunctionImport(Y.NewAction.String.split("/")[1]);var $={};if(Z){var _=Z.parameter?Z.parameter.length:0;for(var i=0;i<_;i++){var a1=Z.parameter[i];var b1=a1.mode==="In"&&R[a1.name]&&R[a1.name][0];if(b1){$[a1.name]=b1;}}S.callFunction("/"+Z.name,{success:function(c1,d1){var e1=new d(S);var f1=e1.getContextFromResponse(c1);if(f1){Q.oNavigationControllerProxy.navigateToSubContext(f1,true,4).then(V.bind(null,null));}else{W();}},error:W,method:"POST",urlParameters:$});return;}}W();});}function K(i,Q,R,S,U){var V=e({},Q);n(S.getMetaModel(),R,V);var W=y(S,i,R,V,U);var X;for(var Y in W){if(Y!=="root"){X=W[Y];break;}}if(X){var Z=i.oAppComponent.getTransactionController();var $=X.isSemantic?"":"/"+S.createKey(R,V);var _=X.isSemantic&&X.key;var a1=C.edit(Z,R,$,S,i,i.oNavigationControllerProxy.fnInitializationResolve,_,V);return a1.then(function(b1){var c1=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var d1=i.mEntityTree[R];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(d1,c1);}return i.oNavigationControllerProxy.navigateToSubContext(b1.context,true,2,null,c1).then(Function.prototype);},function(b1){if(b1.lockedByUser){if(U.force){return{title:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:i.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[b1.lockedByUser]),icon:"sap-icon://message-error"};}return N(i,S,W,V);}if(b1.draftAdminReadResponse){return null;}return new Promise(function(c1){var d1=i.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");M.warning(d1,{onClose:function(){N(i,S,W,V).then(c1);}});});});}return Promise.resolve();}function L(i,Q,R,S,U){var V=e({},Q);n(S.getMetaModel(),R,V);var W=y(S,i,R,V,U);return N(i,S,W,V);}function O(i,Q){var R=Q&&Q.route&&Q.route.length===1&&Q.route[0];if(R){i.oNavigationControllerProxy.navigate(R,true);return Promise.resolve();}var S=Q&&Q.preferredMode&&Q.preferredMode[0];var U=Q&&Q.mode&&Q.mode[0];var V=h(S,U);var W=H(i,V.mode,Q);return W.then(function(X){var Y=i.oAppComponent.getModel();k(Y,X,Q);switch(V.mode){case"create":return I(i,Q,Y,X);case"createWithContext":return J(i,Q,Y,X);case"edit":return K(i,Q,X,Y,V);case"display":return L(i,Q,X,Y,V);}return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:i.getText("ST_GENERIC_ERROR_TITLE"),description:i.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[U,S]),icon:"sap-icon://message-error",replaceURL:true};});}var k=t.testableStatic(k,"startupParameterHelper_fnTransformStartupParameters");var H=t.testableStatic(H,"startupParameterHelper_fnDetermineEntitySetForStartup");return{parametersToNavigation:O};});
