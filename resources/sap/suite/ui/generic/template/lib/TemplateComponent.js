sap.ui.define(["sap/ui/core/library","sap/ui/core/Component","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/Device","sap/suite/ui/generic/template/lib/reuseComponentHelper","sap/ui/core/CustomData","sap/suite/ui/generic/template/lib/StableIdDefinition","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/js/AnnotationHelper","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/core/mvc/View"],function(c,C,U,J,R,D,r,a,S,b,F,A,e,d,f,g){"use strict";var s="lib.TemplateComponent";var l=new F(s).getLogger();var V=c.mvc.ViewType;function E(v){var I=new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"});var w=[];var M=v.getAppComponent().getModel("i18n|"+v.getMetadata().getComponentName()+"|"+v.getEntitySet());if(M){w.push(M);}var x=v.getModel("i18n");if(x){w.push(x);}var y=v.getModel("@i18n");if(y){w.push(y);}var z=true;for(var B="i18n";z;){B=B+"||Parent";z=v.getModel(B);if(z){w.push(z);}}for(var i=w.length-1;i>=0;i--){I.enhance(w[i].getResourceBundle());}v.setModel(I,"i18n");}function h(i,M){var v=i.oComponent.getAppComponent().getManifestEntry("sap.ui5");var w=v.extends&&v.extends.extensions&&v.extends.extensions["sap.ui.controllerExtensions"];var x=i.methods.oComponentData.templateName;var y=w&&w[x]&&w[x]["sap.ui.generic.app"];var z=i.oComponent.getEntitySet();var B=y&&y[z]&&y[z].Actions;var H={};var I=G(i.oComponent);if(B){if(I){j(H,B,I);}else{k(H,B);}}else{var K=y&&y[z]&&y[z]["Sections"];for(var L in K){B=K[L]["Actions"];if(B){k(H,B);}}}i.oComponent.getModel("_templPriv").setProperty("/generic/listCommons/breakoutActionsEnabled",H);}function G(i){var v;var w=i.getAppComponent().getConfig();var x=w&&w.pages[0]&&w.pages[0].component&&w.pages[0].component.settings;if(x&&x.quickVariantSelectionX){v=x.quickVariantSelectionX.variants;}return v;}function j(B,v,w){var x;for(var y in v){x=true;if(v[y].requiresSelection){x=false;}for(var i in w){var z=v[y].id;var H=w[i];var I=A.getSuffixFromIconTabFilterKey(H);if(I){z=z.concat(I);}B[z]={enabled:x};}}}function k(B,i){var v;for(var w in i){v=true;if(i[w].requiresSelection){v=false;}B[i[w].id]={enabled:v};}}function m(i){if(i.oComponent.getAppComponent().getMetadata().getComponentName()===""||i.methods.oComponentData.templateName===""||i.oComponent.getEntitySet()===""){}return i.oComponent.getAppComponent().getMetadata().getComponentName()+"::"+i.methods.oComponentData.templateName+"::"+i.oComponent.getEntitySet();}function n(i,v){if(i.level===0){return[];}var w=v[i.parentRoute];var x=n(w,v);x.push(w);return x;}function o(i,v,M,w){var x=v.oComponent;var y=v.oAppComponent;var z=v.oTemplateContract.mRoutingTree[v.route];var B=x.getEntitySet();var H=v.utils.isDraftEnabled();var I=y.getTransactionController().getDraftController();var K=I.getDraftContext();var L=y.getModel();var N=function(B){return K.isDraftEnabled(B);};var O=e({},z.page.component.settings);delete O.appComponent;delete O.entitySet;delete O.navigationProperty;O.subPages=z.page.pages;O.routeConfig=v.routeConfig;return new J({entitySet:B,entityType:i,treeNode:z,treeNodeAncestors:n(z,v.oTemplateContract.mRoutingTree),routingSpec:v.routingSpec,"sap-ui-debug":window["sap-ui-debug"],isDraftEnabled:H,checkIsDraftEnabled:N,settings:O,manifest:y.getInternalManifest(),metaModel:M,templateSpecific:w&&w(M,O,D,B,K,L),appComponentName:y.getMetadata().getComponentName(),stableId:{definition:S,aParameter:[],getStableId:b.getStableId},variables:[]});}function p(i,v){var w=i.oComponent,x=i.createViewController,y=i.methods&&i.methods.getTemplateSpecificParameters,M=i.oAppComponent.getModel(),z,B,H,I,K,N=i.routingSpec&&i.routingSpec.noOData;if(N){z=new J({entitySet:{},entityType:{}});I=z.createBindingContext("/entitySet");K=z.createBindingContext("/entityType");}else{z=M&&M.getMetaModel();B=M&&w.getEntitySet();var L=B&&z.getODataEntitySet(B);H=L&&L.entityType;if(!H){return{loaded:function(){return Promise.reject(new g(s,"Unknown entityset "+B));}};}I=z.createBindingContext(z.getODataEntitySet(B,true));K=z.createBindingContext(z.getODataEntityType(H,true));}E(w);h(i,M);var O=m(i);var Q=sap.ui.getCore().byId(O);if(Q){l.warning("View with ID: "+O+" already exists - old view is getting destroyed now!");try{Q.destroy();}catch(W){l.warning("Error destroying view: "+W);}Q=null;}var X=new J(D);X.setDefaultBindingMode("OneWay");i.oParameterModel=o(H,i,z,y);w.runAsOwner(function(){var Y=i.preprocessorsData;var Z={async:true,preprocessors:{xml:{bindingContexts:{entitySet:I,entityType:K},models:{device:X,appSettings:i.oTemplateContract.appSettings,entitySet:z,entityType:z,parameter:i.oParameterModel},preprocessorsData:Y}},id:O,type:V.XML,viewName:i.methods.oComponentData.templateName,height:"100%",cache:{keys:v,additionalData:[Y]}};var $={key:"sap-ui-custom-settings",value:{"sap.ui.dt":{"designtime":i.methods.oComponentData.designtimePath}}};Z.customData=[new a($)];Z.controller=x();Q=sap.ui.view(Z);});return Q;}function q(i,v,w){var x=i.oController.extensionAPI;var y=e({},x);if(x.getNavigationController){var N=e({},x.getNavigationController());var z=N.navigateInternal;N.navigateInternal=function(B,H){var I=H&&H.routeName;if(I){i.utils.navigateRoute(I,B,v,H&&H.replaceInHistory);}else{z(B,H);}};y.getNavigationController=function(){return N;};}y.getCommunicationObject=function(L){return L===1?w.communicationObject:i.utils.getCommunicationObject(L);};(i.methods.enhanceExtensionAPI4Reuse||Function.prototype)(y,w);return y;}function P(i,v,w,x,y){x.extensionAPI=q(i,w,x);r.transferEmbeddedComponentProxy(i,v,w,x,y);var z=i.oController.byId(x.containerId);var B=z&&z.getSettings();var H=y.getMetadata().getAllProperties();for(var I in B){if((I==="uiMode"||I==="semanticObject"||I.startsWith("st"))&&!H[I]){delete B[I];}}y.applySettings(B);z.setComponent(y);}function t(i,v,w){return w.componentUsage?i.createComponent({usage:w.componentUsage,id:v}):i.runAsOwner(function(){return C.create({name:w.componentName,id:v});});}function u(i){var v=i.oTemplateContract.mRoutingTree[i.route];i.reuseComponentsReady=new Promise(function(w,x){var y=Object.create(null);var z=w.bind(null,y);var L=function(B,H){l.error("Failed to load reuse component for key "+B,H instanceof Error?H.message:"","sap.suite.ui.generic.template.lib.TemplateComponent");};i.viewRegistered.then(function(){var B=[];for(var H in v.embeddedComponents){var I=v.embeddedComponents[H];var K=I.sectionId&&i.oController.byId(I.sectionId);if(K&&K.isStashed()){delete v.embeddedComponents[H];}else{var M=i.oController.createId(I.containerId+"Content");var N=t(i.oAppComponent,M,I);B.push(N);N.catch(L.bind(null,H));N.then(P.bind(null,i,y,H,I));}}Promise.all(B).then(z,function(O){var Q=i.oAppComponent.getNavigationController();Q.navigateToMessagePage({text:i.oTemplateContract.getText("ST_ERROR"),description:O instanceof Error?O.message:""});x();});});});v.willBeDisplayed.then(i.oTemplateContract.oBusyHelper.setBusy.bind(null,i.reuseComponentsReady,undefined,undefined,true));}var T=U.extend("sap.suite.ui.generic.template.lib.TemplateComponent",{metadata:{properties:{entitySet:{type:"string",defaultValue:null},navigationProperty:{type:"string",defaultValue:null},appComponent:{type:"object",defaultValue:null},isRefreshRequired:{type:"boolean",defaultValue:false},isLeaf:{type:"boolean"}},library:"sap.suite.ui.generic.template"},init:function(){(U.prototype.init||Function.prototype).apply(this);var i=new J({editable:false,enabled:false});this.setModel(i,"ui");var v=this.getComponentData();var w=v.registryEntry;var x=w.oTemplateContract.mRoutingTree[w.route];var y=Object.create(null);for(var K in x.embeddedComponents){y[K]={hidden:!!x.embeddedComponents[K].definition.hiddenByDefault};}var z=new J({generic:{isActive:false,listCommons:{},viewLevel:w.viewLevel,controlProperties:{},supportedIntents:{},embeddedComponents:y}});z.setDefaultBindingMode("TwoWay");this.setModel(z,"_templPriv");u(w);},getExtensionComponent:function(){return this.getAppComponent();},getManifestEntry:function(K){var v=U.prototype.getManifestEntry.apply(this,arguments);if(/^\/sap\.ui5\/componentUsages(\/.+)?$/.test(K)){v=d({},v,U.prototype.getManifestEntry.apply(this.getAppComponent(),arguments));}return v;},getComponentContainer:function(){return this.oContainer;},onBeforeRendering:function(i){if(i){var v=i.oComponent.getComponentContainer();var w=i.oAppComponent;var M=!i.createViewStarted&&v&&v.getModel();if(M){var x=f.getCacheKeyPartsAsyc(M);i.createViewStarted=true;p(i,x).loaded().then(function(y){if(i.utils.isDraftEnabled()){var z=i.utils.getRootExpand();if(z){var B=i.oComponent.getEntitySet();f.writeToLocalStorageAsync(w.getId(),B,x,z);}}i.oComponent.setAggregation("rootControl",y);i.fnViewRegisteredResolve();v.invalidate();},function(y){i.fnViewRegisteredResolve(y||{});});}}},getRouter:function(){if(this.getAppComponent()){return this.getAppComponent().getRouter();}return U.prototype.getRouter.apply(this,arguments);}});return T;});
