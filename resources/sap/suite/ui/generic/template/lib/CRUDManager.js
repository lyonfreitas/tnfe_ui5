sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/model/Context","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/genericUtilities/controlHelper"],function(B,M,A,a,C,b,t,e,c,F,d,f,D,g){"use strict";var s="lib.CRUDManager";var r=Promise.reject();r.catch(Function.prototype);function h(o,k,v){var H=o.getHeaders();var i=e({},H);if(v===undefined){delete i[k];}else{i[k]=v;}o.setHeaders(i);}function m(o){return Object.keys(o).map(function(k){return o[k];});}function j(i){if(i){return i.map(function(k,n){return n;});}}function l(o,n,S,p,q){function u(i,k,X,Y){if(X){a.handleError(i,o,S,X,Y);}return(k||Function.prototype)(X);}var E;function v(i){return new Promise(function(k,X){var Y=o.getOwnerComponent();var Z=Y.getBindingContext();var $=Y.getModel();$.read(Z.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(_){if(!_.DraftAdministrativeData){if(i){return u(a.operations.editEntity,X,i);}return k({});}if(_.DraftAdministrativeData.InProcessByUser){var a1=_.DraftAdministrativeData.InProcessByUserDescription||_.DraftAdministrativeData.InProcessByUser;var b1=Promise.resolve(i||n.getMainComponentUtils().then(function(c1){var d1=c1.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",a1]);return new F(d1);}));return b1.then(function(i){u(a.operations.editEntity,X,i,i);});}return k({draftAdministrativeData:_.DraftAdministrativeData});},error:u.bind(null,a.operations.editEntity,X)});});}function w(){var i=o.getView().getModel().getMetaModel();var k=i.getODataEntityContainer();var X=k["Org.OData.Capabilities.V1.BatchSupport"];if(X&&X.ReferencesAcrossChangeSetsSupported&&X.ReferencesAcrossChangeSetsSupported.Bool){return X.ReferencesAcrossChangeSetsSupported.Bool==="true";}return false;}function x(){return new Promise(function(i){if(w()){n.getMainComponentUtils().then(function(k){i(k.getRootExpand());});}else{i(null);}});}function y(i,k,X){var Y=i.bindingContext;if(X&&X.draftAdministrativeData){return Promise.resolve(X);}return x().then(function(Z){return new Promise(function($,_){S.oTransactionController.editEntity(Y,!k,Z).then(function(a1){var b1;b1=i.view;var c1=function(){Y.getModel().invalidateEntry(Y);b1.detachEvent("modelContextChange",c1);};if(b1){b1.attachEvent("modelContextChange",c1);}return $({context:a1.context});},function(a1){if(a1&&a1.response&&a1.response.statusCode==="409"&&!k){a.removeTransientMessages();return v(a1).then($,_);}else{u(a.operations.editEntity,_,a1,a1);}});});});}E=function(i){var k=n.isDraftEnabled();var X,Y;if(k){var Z=n.getViewLevel();var $;if(Z>0){$=n.getMainComponentDetails();var _=S.oApplication.checkContextData($.bindingContext);if(!_){S.oApplication.registerContext($.bindingContext,1,$.entitySet,S.oApplication.getCurrentKeys(1));}Y=n.getTargetKeyFromLevel(2);}if(!i){var a1=S.oDraftController.getDraftContext();var b1=a1.hasPreserveChanges($.bindingContext);if(!b1){X=v().then(y.bind(null,$,true));}}X=X||y($,i,{});S.oApplication.editingStarted($.bindingContext,X);}else{var c1=o.getView().getBindingContext();X=Promise.resolve({context:c1});}var d1=Promise.all([X,Y]);return d1.then(function(e1){var f1={};var g1=Object.keys(e1[0])[0];f1[g1]=e1[0][g1];f1.targetSiblingKey=e1[1];return f1;});};function z(i){if(q.isBusy()){return r;}var k=E(i);q.setBusy(k);return k;}function G(i,k,X){var Y=new Promise(function(Z,$){var _=function(){var c1=M.getEntitySetFromContext(X);var d1=S.oDraftController.getDraftContext();var e1=d1.isDraftRoot(c1);var f1=n.getViewLevel();var g1=f1>=2?p.getText("ITEM_DELETED"):p.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&e1){g1=p.getText(k?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}a.showSuccessMessageIfRequired(g1,S);};var a1=function(c1){if(c1.length===0){_();Z();}else{a.handleError(a.operations.deleteEntity,o,S,c1[0].oError,null);$();}};var b1=I({pathes:[X.getPath()],withWarningDialog:true});b1.then(a1,$);});return Y;}function H(){var i=new Promise(function(k,X){var Y=o.getView().getBindingContext();var Z=S.oDraftController.isActiveEntity(Y);var $=S.oDraftController.hasActiveEntity(Y);var _=$&&!Z?S.oApplication.getDraftSiblingPromise(Y):Promise.resolve();_.then(function(a1){var b1=G(Z,$,Y);b1.then(k,X);if(!Z){var c1=function(){return{context:a1};};var d1=b1.then(c1);S.oApplication.cancellationStarted(Y,d1,"deleteAction");}},X);});return i;}function P(k,X,Y){var Z={mFailed:Object.create(null),mSuccess:Object.create(null),mWarning:Object.create(null),aMessagesForUserDecision:[]};for(var i=0;i<k.length;i++){var $=k[i];var _=X[i];var a1=a.parseError(_);var b1=parseInt(a1.httpStatusCode,10);var c1=_&&_.response&&_.response.headers;if((b1>=200&&b1<300)||b1===304){Z.mSuccess[$]=_;}else if(b1===412&&c1&&c1["preference-applied"]){Z.mWarning[$]=_;}else{Z.mFailed[$]=_;}}if(!c(Z.mWarning)&&Y){Z.aMessagesForUserDecision=a.getTransientMessages();a.removeTransientMessages();}return Z;}function I(i){var X=new Promise(function(Y,Z){var $=Object.create(null);var _=Object.create(null);var a1=function(b1,j1,k1){_[b1]={resolve:j1,reject:k1};};for(var k=0;k<i.pathes.length;k++){var b1=i.pathes[k];$[b1]=new Promise(a1.bind(null,b1));}S.oApplication.prepareDeletion($,i.suppressRefreshAllComponents);var c1=Object.create(null);var d1=Object.create(null);var e1;var f1=function(j1){if(!c(c1)){S.oApplication.markCurrentDraftAsModified();}for(var b1 in _){var k1=_[b1];k1[c1[b1]?"resolve":"reject"]();}if(j1){return Z();}var l1=i.pathes.map(function(b1){return{sPath:b1,oError:d1[b1]||e1[b1],isWarning:!!e1[b1]};}).filter(function(m1){return!!m1.oError;});Y(l1);};var g1=function(j1){if(j1.length>0){var k1=n.getCRUDActionHandler();var l1={messagesForUserDecison:j1};k1.handleCRUDScenario(4,h1.bind(null,Object.keys(e1),false,false),f1.bind(null,true),"Delete",l1);return;}f1();};var h1=function(j1,k1,i1){if(i.suppressRefreshAllComponents&&i.smartTable){S.oPresentationControlHandlerFactory.getPresentationControlHandler(i.smartTable).refresh("Changes");}var l1=function(n1){var o1=P(j1,n1,i1,i.onlyOneDraftPlusActive);d1=e(d1,o1.mFailed);c1=e(c1,o1.mSuccess);e1=o1.mWarning;g1(o1.aMessagesForUserDecision);};var m1=S.oTransactionController.deleteEntities(j1,{bIsStrict:k1}).then(l1,l1);q.setBusy(m1);};var i1=i.withWarningDialog&&(i.pathes.length===1||i.onlyOneDraftPlusActive);h1(i.pathes,true,i1);});return X;}function J(i){var k=S.oDraftController.hasActiveEntity(i);var X=k?S.oApplication.getDraftSiblingPromise(i):Promise.resolve();return X.then(function(Y){var Z=function(){return{context:Y};};var $=S.oTransactionController.deleteEntity(i);var _=$.then(Z);S.oApplication.cancellationStarted(i,_,"discardAction");return $;});}function K(i){var k=S.oTransactionController.updateMultipleEntities(i);q.setBusy(k);return k;}function L(i,k,X){var Y=k.getMessageModel();var Z=Y.bindList("/",null,null,[i]);var $=Z.getCurrentContexts().map(function(_){return _.getObject();});if(X){$=$.filter(function(_){return!a.isMessageETagMessage(_);});}return $;}function N(i,k,X){if(q.isBusy()){k();return;}var Y,Z,$=Object.create(null),Z;Y=sap.ui.getCore().getMessageManager();var _=X?X:S.oTemplateCapabilities.oMessageButtonHelper&&S.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(false);Z=L(_,Y,true);Z=Z.map(function(d1){$[d1.getId()]=d1;return d1;});var a1=o.getView().getModel();var b1=function(){var d1=n.getCRUDActionHandler();d1.handleCRUDScenario(4,c1.bind(null,false),k,"Activate");};var c1=function(d1){if(d1){h(a1,"Prefer","handling=strict");}else{h(a1,"Prefer","handling=lenient");}var e1=S.oTransactionController.triggerSubmitChanges().then(function(f1){h(a1,"Prefer");Y.removeMessages(Z);i(f1.context);},function(f1){var g1=false;h(a1,"Prefer");var h1=[];var i1=L(_,Y,true);var j1=i1.map(function(k1){if(!$[k1.getId()]){k1.persistent=false;k1.technical=false;g1=g1||k1.technicalDetails.statusCode==="412"&&k1.technicalDetails.headers["preference-applied"]==="handling=strict";h1.push(k1);}return k1;});if(h1.length){Y.removeMessages(j1);Y.addMessages(h1);if(g1&&d1){b1();return;}if(!X){S.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();}}k();});q.setBusy(e1);};c1(true);}function O(i){var k=i;var X=new Promise(function(Y,Z){S.oApplication.performAfterSideEffectExecution(N.bind(null,Y,Z,k));});return X;}function Q(i,k){if(q.isBusy()){return r;}var X=new Promise(function(Y,Z){var $=i?i:o.getView().getBindingContext();var _=k?k:S.oTemplateCapabilities.oMessageButtonHelper&&S.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var a1=sap.ui.getCore().getMessageManager();var b1=false;var c1=function(){b1=true;var d1=function(){var f1=L(_,a1);var g1=S.oDraftController.activateDraftEntity($,true);S.oApplication.activationStarted($,g1);g1.then(function(h1){Y(h1);},function(h1){var i1=L(_,a1).filter(function(l1){return l1.type==="Error";});if(i1.length){var j1=i1[0];var k1=f1.some(function(l1){return j1===l1;});if(!k1){a.removeTransientMessages();}}a.handleError(a.operations.activateDraftEntity,o,S,h1,null);Z();});q.setBusy(g1);};var e1=n.getCRUDActionHandler();e1.handleCRUDScenario(4,d1,Z,"Activate");};S.oApplication.getDraftSiblingPromise($).then(function(d1){if(d1){o.getOwnerComponent().getModel().invalidateEntry(d1);}var e1=L(_,a1);var f1=w()?n.getRootExpand():null;var g1=S.oDraftController.activateDraftEntity($,false,f1);q.setBusy(g1);S.oApplication.activationStarted($,g1);g1.then(function(h1){a1.removeMessages(e1);Y(h1);},function(h1){var i1=L(_,a1);if(i1.length){var j1=i1[0];var k1=e1.some(function(l1){return j1===l1;});if(!k1){a.removeTransientMessages();}}if(!i){a.handleError(a.operations.activateDraftEntity,o,S,h1,null,{"412":c1});if(!b1){Z();}}});});});return X;}function R(i){return new A(i);}function T(i,k){if(!n.isDraftEnabled()){var X,Y;var Z=p.getOwnerControl(i);Z=g.isSmartTable(Z)?Z:Z.getParent();var $=Z.getEntitySet();if(Z.getBindingContext()&&(Z.getBindingContext().getPath()!==$)){X=Z.getBindingContext();Y=Z.getTableBindingPath();}else{var _=Z.getModel();var a1="/"+$;X=new d(_,a1);}return S.oTransactionController.getDefaultValues(X,k,Y);}else{return k;}}function U(i,k,X,Y){if(q.isBusy()){Y();return;}var Z=[];var $=[];var _=[];var a1=false;var b1;var c1=[];var d1=i.functionImportPath;var e1=i.contexts||[];var f1=i.sourceControlHandler;if(e1.length===0&&f1){var g1=f1.getModel();var h1="/";var i1=f1.getEntitySet();var j1=h1.concat(i1);e1.push(new d(g1,j1));}var k1=i.label;var l1=i.operationGrouping;var m1=i.skipProperties;var n1=function(){if(e1[0]){var s1=e1[0].oModel;if(s1&&s1.hasPendingChanges()){s1.resetChanges();}}};var o1=function(s1){n1();Y(s1);};var p1=function(s1,t1){if(s1.length>0){var u1=n.getCRUDActionHandler();var v1;if(e1.length===0){v1=r1.bind(null,false,false,e1);}else{var w1=e1.filter(function(x1,y1){return c1.includes(""+y1);});v1=r1.bind(null,false,false,w1);}var i={messagesForUserDecison:s1,actionName:k1};u1.handleCRUDScenario(4,v1,t1,"BOPFAction",i);return;}t1();};var q1=e1.length<=1;var r1=function(s1,q1,t1){if(!s1){n1();}var u1=R({controller:o,contexts:t1,applicationController:S.oApplicationController,operationGrouping:l1});u1.call(d1,k1,n.isDraftEnabled(),m1,s1,b1).then(function(x1){var y1={};y1.actionLabel=k1;q.setBusy(x1.executionPromise,null,y1);x1.executionPromise.then(v1,v1);},o1);var v1=function(x1){var y1=Array.isArray(x1)?x1:[x1];var z1=j(y1);var A1=y1.map(function(C1){var D1=C1.error||C1.response;if(D1){D1.actionContext=C1.actionContext;}return D1;});b1=y1[0].userEnteredAdditionalParams;var B1=P(z1,A1,q1);$=$.concat(m(B1.mFailed));Z=Z.concat(m(B1.mSuccess));c1=Object.keys(B1.mWarning);_=m(B1.mWarning);p1(B1.aMessagesForUserDecision,w1.bind(null,y1));};var w1=function(x1){var y1=$.concat(Z.concat(_));if(y1.length>1){var z1=_.length>0;var A1=$.concat(_);var B1=y1.length;var C1=A1.length;if(C1>0){var D1;if(B1===C1){D1=p.getText("ST_GENERIC_NOT_PROCESSED_RECORDS_PLURAL");}else{D1=p.getText("ST_GENERIC_NOT_PROCESSED_RECORDS",[C1,B1]);}if(z1){D1=D1+'\n';if(C1===1){D1=D1+p.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_SINGULAR");}else{D1=D1+p.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_PLURAL");}}q.getUnbusy().then(function(){if($.length>1){f.error(D1);}else{f.warning(D1);}});}}var E1,F1;a1=a1||u1.getExecutedSuccessfully();if(a1){var G1;if(Z.length===1&&_.length===0&&$.length===0){E1=Z[0];G1=x1[0].actionContext;}F1=E1&&E1.context;var H1;if(F1&&F1.getObject()){H1=S.oApplication.registerContext(F1);}if(F1&&F1!==G1&&F1.getPath()!=="/undefined"){S.oApplication.navigateToDetailContextIfPossible(F1,false,H1.bIsDraft?2*(1+H1.bIsCreate):1,H1);}var I1=f1&&f1.getBindingInfo();var J1=I1&&I1.binding;if(J1&&J1.oEntityType){f1.setEnabledToolbarButtons();if(n.getViewLevel()===0){f1.setEnabledFooterButtons();}}X(y1);}else{n1();Y(y1);}};};r1(true,q1,e1);}function V(i,k){var X=new Promise(function(Y,Z){S.oApplication.performAfterSideEffectExecution(U.bind(null,i,k,Y,Z));});return X;}function W(i,k){if(!i){throw new F(s,"Unknown Table");}var X="";var Y="";var Z;var $=o.getOwnerComponent();var _=$.getAppComponent();if($.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){Z=($.getCreationEntitySet&&$.getCreationEntitySet())||(i.getEntitySet&&i.getEntitySet());}else{Z=($.getCreationEntitySet&&$.getCreationEntitySet())||$.getEntitySet();}var a1=o.getView();var b1=a1.getModel();var c1=a1.getBindingContext();if(c1){Y=S.oPresentationControlHandlerFactory.getPresentationControlHandler(p.getOwnerPresentationControl(i)).getBindingInfo().path;var d1=b1.getMetaModel();var e1=d1.getODataEntitySet(Z);var f1=d1.getODataEntityType(e1.entityType);var g1=d1.getODataAssociationSetEnd(f1,Y);if(g1){Z=g1.entitySet;}Y="/"+Y;X=$.getComponentContainer().getElementBinding().getPath()+Y;}else{X="/"+Z;}return new Promise(function(h1,i1){var j1=b.getCacheKeyPartsAsyc(b1);Promise.all(j1).then(function(k1){function l1(r1){S.oApplication.getBusyHelper().setBusy(r1);}var m1;if(w()){var n1=b.getCacheKey(_.getId(),Z,k1);m1=b.readFromLocalStorage(n1);}else{m1=null;}var o1=n.getSettings();var p1={sRootExpand:m1,oController:o,oApplicationController:S.oApplicationController,bUseNewActionForCreate:o1&&o1.useNewActionForCreate,fnSetBusy:l1};var q1=C.create(S.oDraftController,Z,X,b1,S.oApplication,k,p1);q1.catch(u.bind(null,a.operations.addEntry,function(r1){i1();if(r1){throw r1;}}));q1.then(function(r1){S.oApplication.markCurrentDraftAsModified();var k1=n.getCurrentKeys();k1.push(D.analyseContext(r1).key);var s1=k1.length-1;S.oApplication.registerContext(r1,s1,Z,k1);h1(r1);});n.preloadComponent(Z);});});}var u=t.testable(u,"handleError");var R=t.testable(R,"getActionUtil");return{editEntity:z,deleteEntity:H,deleteEntities:I,saveEntity:O,activateDraftEntity:Q,discardDraft:J,callAction:V,addEntry:W,updateMultipleEntities:K,getDefaultValues:T};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(o,i,S,k,n){e(this,l(o,i,S,k,n));}});});
