sap.ui.define(["sap/base/Log","./SceneContext","./CallbackHandler","./Command","./TotaraUtils","../IncludeUsageIdType","../helpers/WorkerScriptLoader"],function(L,S,C,a,T,I,W){"use strict";var b=T.mark;var c=function(){this._performanceTimingMsg=[];this._isPostable=true;this._suppressSendRequests=false;this._loadingFinishedSent=false;this.currentSceneInfo={};this.contextMap=new Map();this.tokenContextMap=new Map();this._skipLowLODRendering=true;this._maxUrlLength=2048;this._maxActiveRequests=4;this._meshesBatchSize=1024;this._materialsBatchSize=128;this._geometriesBatchSize=1024;this._geometriesMaxBatchDataSize=10*1024*1024;this._geomMeshesBatchSize=1024;this._parametricsBatchSize=1024;this._geomMeshesMaxBatchDataSize=10*1024*1024;this._annotationsBatchSize=128;this._tracksBatchSize=128;this._sequencesBatchSize=128;this._voxelThreshold=0.03;this.onErrorCallbacks=new C();this.onImageFinishedCallbacks=new C();this.onImageDetailsFinishedCallbacks=new C();this.onMaterialFinishedCallbacks=new C();this.onAnnotationFinishedCallbacks=new C();this.onSetGeometryCallbacks=new C();this.onSetSequenceCallbacks=new C();this.onSetTrackCallbacks=new C();this.onViewGroupUpdatedCallbacks=new C();this.onLoadingFinishedCallbacks=new C();};c.prototype.running=function(){return this._worker!==null&&this._worker!==undefined;};c.prototype.run=function(){if(!this._worker){this._worker=W.loadScript("sap/ui/vk/totara/TotaraLoaderWorker.js");var t=this;this._worker.onmessage=function(f){var h=f.data;h.jsonContent=h.jsonContent||{};if(h.jsonString){var j=JSON.parse(h.jsonString);delete h.jsonString;h.jsonContent=Object.assign(j,h.jsonContent);}var i=t.processCommand(h.name,h.jsonContent,h.binaryContent,h.isInitial);if(i){t.sendRequest(i.requestQueue);}};this._worker.onerror=function(f){};}return Promise.resolve("TotaraLoader is ready");};c.prototype.getUrl=function(){return this._url;};c.prototype.setUrl=function(u){this._url=u;if(!this._url.endsWith("/")){this._url+="/";}return this;};c.prototype.getCorrelationId=function(){return this._correlationId;};c.prototype.setCorrelationId=function(f){this._correlationId=f;return this;};c.prototype.getSkipLowLODRendering=function(){return this._skipLowLODRendering;};c.prototype.setSkipLowLODRendering=function(s){this._skipLowLODRendering=s;return this;};c.prototype.getMaxUrlLength=function(){return this._maxUrlLength;};c.prototype.setMaxUrlLength=function(m){this._maxUrlLength=m;return this;};c.prototype.getMaxActiveRequests=function(){return this._maxActiveRequests;};c.prototype.setMaxActiveRequests=function(m){this._maxActiveRequests=m;this.postMessage({method:a.setMaxActiveRequests,maxActiveRequests:m});};c.prototype.getMeshesBatchSize=function(){return this._meshesBatchSize;};c.prototype.setMeshesBatchSize=function(m){this._meshesBatchSize=m;return this;};c.prototype.getMaterialsBatchSize=function(){return this._materialsBatchSize;};c.prototype.setMaterialsBatchSize=function(m){this._materialsBatchSize=m;return this;};c.prototype.getGeometriesBatchSize=function(){return this._geometriesBatchSize;};c.prototype.setGeometriesBatchSize=function(f){this._geometriesBatchSize=f;return this;};c.prototype.getGeometriesMaxBatchDataSize=function(){return this._geometriesMaxBatchDataSize;};c.prototype.setGeometriesMaxBatchDataSize=function(f){this._geometriesMaxBatchDataSize=f;return this;};c.prototype.getGeomMeshesBatchSize=function(){return this._geomMeshesBatchSize;};c.prototype.setGeomMeshesBatchSize=function(f){this._geomMeshesBatchSize=f;return this;};c.prototype.getParametricsBatchSize=function(){return this._parametricsBatchSize;};c.prototype.setParametricsBatchSize=function(p){this._parametricsBatchSize=p;return this;};c.prototype.getGeomMeshesMaxBatchDataSize=function(){return this._geomMeshesMaxBatchDataSize;};c.prototype.setGeomMeshesMaxBatchDataSize=function(f){this._geomMeshesMaxBatchDataSize=f;return this;};c.prototype.getAnnotationsBatchSize=function(){return this._annotationsBatchSize;};c.prototype.setAnnotationsBatchSize=function(f){this._annotationsBatchSize=f;return this;};c.prototype.getTracksBatchSize=function(){return this._tracksBatchSize;};c.prototype.setTracksBatchSize=function(t){this._tracksBatchSize=t;return this;};c.prototype.getSequencesBatchSize=function(){return this._sequencesBatchSize;};c.prototype.setSequencesBatchSize=function(s){this._sequencesBatchSize=s;return this;};c.prototype.getVoxelThreshold=function(){return this._voxelThreshold;};c.prototype.setVoxelThreshold=function(v){this._voxelThreshold=v;if(this.sceneBuilder){this.sceneBuilder.setVoxelThreshold(v);}return this;};c.prototype.setSceneBuilder=function(s){this.sceneBuilder=s;this.sceneBuilder.setVoxelThreshold(this.getVoxelThreshold());};c.prototype.dispose=function(){this.contextMap.forEach(function(f){f.dispose();});this.contextMap.clear();this.tokenContextMap.clear();this.postMessage({method:"close"});this._worker=undefined;this.currentSceneInfo=null;this.sceneBuilder.cleanup();this.sceneBuilder=null;this.onErrorCallbacks=null;this.onMaterialFinishedCallbacks=null;this.onImageFinishedCallbacks=null;this.onImageDetailsFinishedCallbacks=null;this.onSetGeometryCallbacks=null;this.onSetTrackCallbacks=null;this.onSetSequenceCallbacks=null;this.onAnnotationFinishedCallbacks=null;};c.prototype.cleanup=function(){this.currentSceneInfo={};this.contextMap.clear();this.tokenContextMap.clear();this.sceneBuilder.cleanup();};c.prototype.getSceneBuilder=function(){return this.sceneBuilder;};c.prototype.getContext=function(s){return this.contextMap.get(s);};c.prototype.createContext=function(s,p){var f=new S(s,p,this);this.contextMap.set(s,f);this.tokenContextMap.set(f.requestQueue.token,f);if(f.onActiveCamera){f.onActiveCameraCallbacks.attach(f.onActiveCamera);delete f.onActiveCamera;}if(f.onInitialSceneFinished){f.onInitialSceneFinishedCallbacks.attach(f.onInitialSceneFinished);delete f.onInitialSceneFinished;}if(f.onPartialRetrievalFinished){f.onPartialRetrievalFinishedCallbacks.attach(f.onPartialRetrievalFinished);delete f.onPartialRetrievalFinished;}if(f.onViewFinished){f.onViewFinishedCallbacks.attach(f.onViewFinished);delete f.onViewFinished;}if(f.onSceneCompleted){f.onSceneCompletedCallbacks.attach(f.onSceneCompleted);delete f.onSceneCompleted;}if(f.onProgressChanged){f.setOnProgressChanged(f.onProgressChanged);delete f.onProgressChanged;}if(f.onLoadingFinished){this.onLoadingFinishedCallbacks.detachAll();this.onLoadingFinishedCallbacks.attach(f.onLoadingFinished);delete f.onLoadingFinished;}if(f.onContentChangesProgress){f.onContentChangesProgressCallbacks.attach(f.onContentChangesProgress);delete f.onContentChangesProgress;}if(f.onInitialViewCompleted){f.onInitialViewCompletedCallbacks.attach(f.onInitialViewCompleted);delete f.onInitialViewCompleted;}return f;};c.prototype.isLoadingFinished=function(){var f=this.contextMap.values();var h=f.next();while(!h.done){if(!h.value.isLoadingFinished()){return false;}h=f.next();}return true;};c.prototype.decrementResourceCountersForDeletedTreeNode=function(f,n){if(f){this.sceneBuilder.decrementResourceCountersForDeletedTreeNode(n,f.sceneId);}};function l(f,n){if(f.progressLogger){f.progressLogger.logPerformance(n,f.token);}}c.prototype.request=function(s,f,h){if(!f.root){throw"Context must include root where loaded objects are attached to";}var i=this.createContext(s,f);i.token=i.requestQueue.token;this.currentSceneInfo.id=s;i.retrievalType=S.RetrievalType.Initial;i.authorizationHandler=h;i.initialRequestTime=Date.now();if(i.enableLogger){T.createLogger(s,i,this);}var m;if(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge){m=Math.min(2*1024,this.getMaxUrlLength());}else if(sap.ui.Device.browser.mobile){m=Math.min(8*1024,this.getMaxUrlLength());}else{m=Math.min(64*1024,this.getMaxUrlLength());}var j=e(this.getUrl()+"streaming-http",this.getUrl(),s,this.getCorrelationId(),m);var r=i.requestQueue;r.meshes.setBatchSizeInfo(j[a.getMesh]);r.materials.setBatchSizeInfo(j[a.getMaterial]);r.geometries.setBatchSizeInfo(j[a.getGeometry]);r.geomMeshes.setBatchSizeInfo(j[a.getGeomMesh]);r.annotations.setBatchSizeInfo(j[a.getAnnotation]);r.tracks.setBatchSizeInfo(j[a.getTrack]);r.sequences.setBatchSizeInfo(j[a.getSequence]);r.parametric.setBatchSizeInfo(j[a.getParametric]);var t=this;(h&&h(this.getUrl())||Promise.resolve()).then(function(k){l(i,"modelRequested");b("modelRequested");t.postMessage({method:"useAccessTokenResponse",accessTokenResponse:k});t.postMessage({method:"initializeConnection",url:t.getUrl(),cid:t.getCorrelationId(),maxActiveRequests:t.getMaxActiveRequests()});t.postMessage({method:a.getScene,sceneId:s});});};c.prototype.postMessage=function(m){if(this._worker){this._worker.postMessage(m);}};c.prototype.processSetSceneCommand=function(j){var f=this.getContext(j.veid);if(f){f.defaultViewId=j.defaultViewId;f.defaultViewGroupId=j.defaultViewGroupId;f.sceneThumbnailId=j.imageId;f.dimension=j.dimension;f.defaultRootEntityId=j.defaultRootEntityId;if(f.defaultViewGroupId){f.currentViewGroupId=f.defaultViewGroupId;}var v;if(f.activateView){v=f.activateView;}else if(f.defaultViewId){v=f.defaultViewId;}if(v){f.initialViewId=f.currentViewId=v;f.initialViewDecided=true;}this.postMessage({method:a.getView,parameters:{sceneId:f.sceneId,viewId:v,query:T.configureSceneViewQuery(f)},pushViewGroups:f.pushViewGroups,isInitial:true});}};c.prototype.update=function(s,f,v){this.currentSceneInfo.id=s;var h=this.getContext(s);if(!h){return Promise.reject("no context for ${sceneVeId}");}var t=this;return new Promise(function(r,i){h.nodeSidsForPartialTree=new Set(f);h.retrievalType=S.RetrievalType.Partial;var j=function(){h.onPartialRetrievalFinishedCallbacks.detach(j);l(h,"updateFinished(mesh)");var k=[];var m=[];h.replacedNodes.forEach(function(p,q){m.push(p);k.push(q);});var n=k;var o=m;r({sceneVeId:s,sids:f,replacedNodeRefs:n,replacementNodeRefs:o});};h.onPartialRetrievalFinishedCallbacks.attach(j);l(h,"updateRequested");t.postMessage({method:a.getView,parameters:{sceneId:s,viewId:v,query:Object.assign(T.configureSceneViewQuery(h),{breadcrumbs:true}),sids:f},isPartialTree:true});});};c.prototype.requestViewGroup=function(s,v,i){if(!v){return Promise.reject("invalid arg: viewGroupId undefined");}var f=this.getContext(s);if(!f){return Promise.reject("no context for ${sceneVeId}");}if(i!==undefined){f.includeAnimation=i;}var t=this;var p=new Promise(function(r,h){var j=t.sceneBuilder.getViewGroup(v,s);if(j&&j.length){r(j);return;}var k=function(){f.onViewGroupFinishedCallbacks.detach(k);l(f,"onViewGroupFinished");var m=t.sceneBuilder.getViewGroup(v,s);if(m&&m.length){r(m);}else{h("no view ground data");}};f.onViewGroupFinishedCallbacks.attach(k);f.currentViewGroupId=v;t.postMessage({method:"getViewGroups",parameters:{sceneId:s,viewGroupId:v}});});return p;};c.prototype.requestView=function(s,v,f,p,i){this.currentSceneInfo.id=s;if(v!=="static"){return Promise.reject("invalid arg: supported type - static");}if(!f){return Promise.reject("invalid arg: viewId undefined");}var h=this.getContext(s);if(!h){return Promise.reject("no context for ${sceneVeId}");}h.currentViewId=f;var q;var m;if(p&&p.length>0){m=a.getViewAnimations;q={$expand:[]};h.playbackIds=p;}else{m=a.getView;q=T.configureSceneViewQuery(h);}this.hasAnimation=false;var t=this;var j=new Promise(function(r,k){h.onSetPlaybackCallbacks.detachAll();var n=function(x){h.onSetPlaybackCallbacks.detach(n);l(h,"onSetPlayback");if(x){r(x);}else{k("no view data");}};h.onSetPlaybackCallbacks.attach(n);h.onViewFinishedCallbacks.detachAll();var o=function(x){h.onViewFinishedCallbacks.detach(o);l(h,"onViewFinished");if(!t.hasAnimation){if(x){r(x);}else{k("no view data");}}else{h.currentView=x;}};h.onViewFinishedCallbacks.attach(o);t.onSetSequenceCallbacks.detachAll();var u=function(){t.onSetSequenceCallbacks.detach(u);l(h,"onSetSequence");if(h.currentView){r(h.currentView);}};t.onSetSequenceCallbacks.attach(u);t.onSetTrackCallbacks.detachAll();var w=function(x){t.onSetTrackCallbacks.detach(w);l(h,"onSetTrack");if(h.currentView){r(h.currentView);}};t.onSetTrackCallbacks.attach(w);l(h,"viewRequested");t.postMessage({method:m,parameters:{sceneId:h.sceneId,viewId:f,query:q}});});return j;};c.prototype.requestMaterial=function(s,r){if(!r){return Promise.reject("invalid arg: requestedMaterial undefined");}var f=this.getContext(s);if(!f){return Promise.reject("no context for ${sceneVeId}");}var t=this;var p=new Promise(function(h,i){var j="";if(typeof r=="string"){j=r;}else if(typeof r=="object"){if(typeof r.getMaterialRef==="function"){h(r.getMaterialRef());return;}else if(r.id){j=r.id;}else if(r.veId){j=r.veId;}else{i("invalid arg: invalid requestedMaterial object");return;}}else{i("invalid arg: requestedMaterial must be an object or a string");return;}var k=f.sceneBuilder.getMaterial(j);if(k){h(k);return;}f.requestQueue.materials.push(j);var n=function(q){if(j!==q.materialId){return;}var m=t.sceneBuilder.getMaterial(j);if(m&&!m.userData.imageIdsToAddAsTexture){t.sceneBuilder.detachImageAddedToMaterial(n);h(m);}};var o=function(q){if(j!=q){return;}t.onMaterialFinishedCallbacks.detach(o);var m=t.sceneBuilder.getMaterial(j);if(!m){t.sceneBuilder.detachImageAddedToMaterial(n);i("no material data");}if(m.userData.imageIdsToAddAsTexture){return;}t.sceneBuilder.detachImageAddedToMaterial(n);h(m);};t.onMaterialFinishedCallbacks.attach(o);t.sceneBuilder.attachImageAddedToMaterial(n);t.sendRequest(f.requestQueue);});return p;};c.prototype.requestAnnotation=function(s,f){if(!f){return Promise.reject("invalid arg: annotationId undefined");}var h=this.getContext(s);if(!h){return Promise.reject("no context for ${sceneVeId}");}var t=this;var p=new Promise(function(r,i){var j=function(m){return h.sceneBuilder.getAnnotation?h.sceneBuilder.getAnnotation(m):null;};var k=j(f);if(k){r(k);return;}h.requestQueue.annotations.push(f);var n;var o;var q=function(v){t.onAnnotationFinishedCallbacks.detach(n);var w=j(f);var m=t.sceneBuilder._getMaterial(w.label.materialId);if(m&&m.userData.imageDetailsToLoad&&!m.userData.imageDetailsToLoad.size){t.onImageDetailsFinishedCallbacks.detach(q);if(m.userData.imageIdsToLoad&&m.userData.imageIdsToLoad.size){return;}r(w);}};var u=function(v){t.onAnnotationFinishedCallbacks.detach(n);var w=j(f);var m=t.sceneBuilder._getMaterial(w.label.materialId);if(m&&m.userData.imageIdsToLoad&&!m.userData.imageIdsToLoad.size){t.onImageFinishedCallbacks.detach(u);if(m.userData.imageDetailsToLoad&&m.userData.imageDetailsToLoad.size){return;}r(w);}};o=function(v){t.onAnnotationFinishedCallbacks.detach(n);var w=j(f);if(w.label.materialId!=v){return;}t.onMaterialFinishedCallbacks.detach(o);if(!t.sceneBuilder.checkMaterialExists(v,false)){t.onImageFinishedCallbacks.detach(u);i("no material data");}var m=t.sceneBuilder._getMaterial(v);if((m.userData.imageIdsToLoad&&m.userData.imageIdsToLoad.size)||(m.userData.imageDetailsToLoad&&m.userData.imageDetailsToLoad.size)){return;}t.onImageFinishedCallbacks.detach(u);t.onImageDetailsFinishedCallbacks.detach(q);r(w);};n=function(m){if(f!==m){return;}t.onAnnotationFinishedCallbacks.detach(n);var v=t.sceneBuilder.getAnnotation?t.sceneBuilder.getAnnotation(f):null;if(!v){t.onMaterialFinishedCallbacks.detach(o);t.onImageFinishedCallbacks.detach(u);t.onImageDetailsFinishedCallbacks.detach(q);i("no annotation data");}t.onMaterialFinishedCallbacks.detach(o);t.onImageFinishedCallbacks.detach(u);t.onImageDetailsFinishedCallbacks.detach(q);r(v);};t.onAnnotationFinishedCallbacks.attach(n);t.onMaterialFinishedCallbacks.attach(o);t.onImageFinishedCallbacks.attach(u);t.onImageDetailsFinishedCallbacks.attach(q);t.sendRequest(h.requestQueue);});return p;};c.prototype.setSuppressSendRequests=function(s){this._suppressSendRequests=s;};c.prototype.sendRequest=function(r){if(!this._worker||this._suppressSendRequests){return false;}var s=false;while(!r.isEmpty()){var n=r.generateRequestCommand();this.postMessage(n);s=true;}return s;};c.prototype.timestamp=function(j){};c.prototype.performanceTiming=function(j){};c.prototype.checkError=function(j){if(!j){return true;}var r=j.result==="failure";if(r){if(j.message){j.error=j.message;delete j.message;}else{j.error="Unknown error";}}return r;};c.prototype.reportError=function(f,h){this.onErrorCallbacks.execute({error:h,context:f});};c.prototype.processContextCommand=function(f,n,j,h,i){if(!f){var k=n+" error: unknown context - "+JSON.stringify(j);this.contextMap.forEach(function(f){f[n].call(f,j,h);});return{error:k};}var r;try{r=f[n].call(f,j,h,i);}catch(m){r={error:m};}return r;};c.prototype.processCommand=function(n,j,f,i){if(this.checkError(j)){if(n===a.setTree){if(j.events&&j.events.length){var h=j.events[0];if(h.values&&h.values.id){this.contextMap.delete(h.values.id);}}}this.onErrorCallbacks.execute(j);return null;}var k=null;if(j.sceneId!==undefined){k=this.getContext(j.sceneId);}else if(j.token!==undefined){k=this.tokenContextMap.get(j.token);}if(k){this.currentSceneInfo.id=k.sceneId;}this.setPerformance(n,j,k?k.sceneId:null);var r;switch(n){case a.setScene:this.processSetSceneCommand(j);break;case a.setTree:case a.setTreeNode:case a.notifyFinishedTree:case a.setView:case a.setViewNode:case a.setViewGroup:case a.notifyFinishedView:case a.setCamera:case a.setMesh:case a.setMaterial:case a.setGeometry:case a.setImage:case a.setAnnotation:case a.setLineStyle:case a.setFillStyle:case a.setTextStyle:case a.setParametric:case a.setPlayback:case a.setHighlightStyle:case a.setSequence:case a.setTrack:case a.suppressSendRequests:case a.unsuppressSendRequests:r=this.processContextCommand(k,n,j,f,i);break;case a.notifyError:r={error:j.errorText};break;case a.timestamp:r=this.timestamp(j);break;case a.performanceTiming:r=this.performanceTiming(j);break;default:r={error:"Unknown command: "+n};break;}if(this.isLoadingFinished()){if(n!==a.setScene&&n!==a.setView&&n!==a.setViewNode&&n!==a.timestamp&&n!==a.performanceTiming&&n!==a.suppressSendRequests&&n!==a.unsuppressSendRequests&&this._loadingFinishedSent===false){this.onLoadingFinishedCallbacks.execute();this._loadingFinishedSent=true;L.info("Loading is finished - all streaming requests are fulfilled.");}}else if(this._loadingFinishedSent){this._loadingFinishedSent=false;}if(r&&r.error){L.error(r.error);this.onErrorCallbacks.execute(r);}return k;};c.prototype.setPerformance=function(n,j,s){var i;switch(n){case a.setGeometry:i=j.id;b("setGeometry-"+i);break;case a.setImage:i=j.id;b("setImage-"+i);break;case a.setView:i=j.viewId;b("setView-"+i);break;case a.setViewGroup:i=j.id;b("setViewGroup-"+i);break;case a.setMesh:b("setMesh-"+s);break;case a.setMaterial:b("setMaterial-"+s);break;case a.setTree:b("setTree-"+s);break;case a.performanceTiming:this._isPostable=true;this.postPerformanceTiming();break;default:break;}};c.prototype.postPerformanceTiming=function(m){if(m){this._performanceTimingMsg.push(m);}if(this._isPostable&&this._performanceTimingMsg.length>0){this.postMessage(this._performanceTimingMsg.shift());this._isPostable=false;}};c.prototype.printLogTokens=function(){this.contextMap.forEach(function(f,s){L.info("log tokens for scene => "+s);L.info("---------------------------------------");if(f.progressLogger){f.progressLogger.getTokens().forEach(function(t){L.info(t);});}L.info("---------------------------------------");});};function g(f,u,h,s,t,m){var i;var j;switch(f){case"getGeometry":j=m-(h+"geometry?id=").length;break;case"getGeomMesh":j=m-(h+"scenes/"+s+"/meshes?ids="+i).length;break;default:i="?request="+encodeURI(f+"["+m+"]"+JSON.stringify({sceneId:s,ids:[],token:t}));j=m-(u+i).length;break;}return j;}function d(f){switch(f){case"getGeometry":return"&id=".length;default:return",".length;}}function e(s,f,h,i,m){s=s.indexOf("?")===-1?s:s.substring(0,s.indexOf("?"));var j=["getAnnotation","getGeometry","getGeomMesh","getMaterial","getMesh","getParametric","getSequence","getTrack"];var k={};j.forEach(function(n){k[n]={maxBatchStringLength:g(n,s,f,h,i,m),separatorLength:d(n)};});return k;}return c;});
