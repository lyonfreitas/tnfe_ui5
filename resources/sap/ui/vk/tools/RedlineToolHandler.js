/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider","sap/ui/core/Core"],function(E,c){"use strict";var R=E.extend("sap.ui.vk.tools.RedlineToolHandler",{metadata:{},constructor:function(t){this._priority=0;this._tool=t;this._rect=null;this._zoomFactor=1;}});R.prototype.destroy=function(){this._tool=null;this._rect=null;};R.prototype.init=function(){this._previousHoverTarget=null;};R.prototype.beginGesture=function(e){var g=this._tool.getGizmo();if(g&&this._inside(e)){if(g._textEditingElement){e.handled=true;var h=this.hitTest(e.x,e.y);if(h!==g._textEditingElement){var d=g._textEditingElement.getDomRef();if(d){d.childNodes[0].blur();}return;}e.passEvent=true;if(h===g._textEditingElement){return;}}this._gesture=true;g._activeElement=g.getAggregation("activeElement");if(g._activeElement){e.handled=true;var b=g.getDomRef().getBoundingClientRect(),p=g._toVirtualSpace(e.x-b.left-window.pageXOffset,e.y-b.top-window.pageYOffset);g._activeElement.setOriginX(p.x);g._activeElement.setOriginY(p.y);g.rerender();}else{var o=this._getOffset(g.getDomRef());this._pivotPoint=g._toVirtualSpace(e.x-o.x,e.y-o.y);}}};R.prototype.move=function(e){var g=this._tool.getGizmo();if(g&&this._gesture){if(g._textEditingElement){e.handled=true;e.passEvent=true;}else if(g._activeElement){e.handled=true;var b=g.getDomRef().getBoundingClientRect(),x=e.x-b.left-window.pageXOffset,y=e.y-b.top-window.pageYOffset;g._activeElement.edit(x,y,e.event&&e.event.shiftKey);}}};R.prototype.endGesture=function(e){var g=this._tool.getGizmo();if(g&&this._inside(e)){this._gesture=false;if(g._textEditingElement){e.handled=true;e.passEvent=true;}else if(g._activeElement){e.handled=true;g._stopAdding(true);}}};R.prototype.pan=function(d,a){var g=this._tool.getGizmo();if(g&&(d||a)){g.getRedlineElements().forEach(function(e){e.setOriginX(e.getOriginX()+g._toVirtualSpace(d));e.setOriginY(e.getOriginY()+g._toVirtualSpace(a));});g.rerender();}};R.prototype.zoom=function(z){var g=this._tool.getGizmo();if(g&&z!==1){var s=1-z,p=this._pivotPoint;g.getRedlineElements().forEach(function(e){e.applyZoom(z);var o=e.getOriginX(),a=e.getOriginY();o+=(p.x-o)*s;a+=(p.y-a)*s;e.setOriginX(o);e.setOriginY(a);});g.rerender();}};R.prototype.hitTest=function(x,y){var h;var t=6;var a=6;var b=function(x,y){var f=document.elementFromPoint(x,y);if(f){var g=c.byId(f.id||f.parentNode.id);if(g instanceof sap.ui.vk.RedlineElement){return g;}}};h=b(x,y);if(!h){for(var d=y-a;d<y+a;d++){for(var e=x-t;e<x+t;e++){h=b(e,d);if(h){return h;}}}}return h?h:null;};R.prototype.click=function(e){var h=this.hitTest(e.x,e.y);if(h){this._tool.fireElementClicked({elementId:h.getElementId()});}};R.prototype.doubleClick=function(e){var g=this._tool.getGizmo();if(g&&this._tool.getEditable()){var h=this.hitTest(e.x,e.y);if(h instanceof sap.ui.vk.RedlineElementText){g.editTextElement(h);e.handled=true;}}};R.prototype.hover=function(e){var g=this._tool.getGizmo();if(g&&g._textEditingElement){e.passEvent=true;return;}var h=this.hitTest(e.x,e.y);if(h&&h.getElementId()!=this._previousHoverTarget){this._previousHoverTarget=h.getElementId();this._tool.fireElementHovered({elementId:h.getElementId()});}else if(!h&&h!=this._previousHoverTarget){this._previousHoverTarget=h;this._tool.fireElementHovered({elementId:null});}};R.prototype.contextMenu=function(e){};R.prototype.getViewport=function(){return this._tool._viewport;};R.prototype._getOffset=function(o){var r=o.getBoundingClientRect();var p={x:r.left+window.pageXOffset,y:r.top+window.pageYOffset};return p;};R.prototype._inside=function(e){var i=this._tool._viewport.getIdForLabel();var d=document.getElementById(i);if(d==null){return false;}var o=this._getOffset(d);this._rect={x:o.x,y:o.y,w:d.offsetWidth,h:d.offsetHeight};return(e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h);};return R;});
