/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./ExplodeAxis","./ExplodeDirection","./ExplodeItemGroup","./ExplodeType","./ExplodeToolHandler","./ExplodeToolGizmo","../AnimationPlayback","../AnimationTrackType","../AnimationTrackValueType","../OrthographicCamera","sap/ui/base/ManagedObjectObserver","../getResourceBundle","../TransformationMatrix"],function(T,E,a,b,c,d,e,A,f,g,O,M,h,i){"use strict";var j=T.extend("sap.ui.vk.tools.ExplodeTool",{metadata:{properties:{type:{type:"sap.ui.vk.tools.ExplodeType",defaultValue:c.Linear},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float",defaultValue:0.0},anchor:{type:"float[]",defaultValue:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},aggregations:{items:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:true}},associations:{selectedItem:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:false}},events:{axisSelected:{parameters:{axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"}}},magnitudeChanging:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},magnitudeChanged:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},itemSequenceChangePressed:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},moveUp:{type:"boolean"}}},itemPositionAdjusting:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}},itemPositionAdjusted:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}}}},constructor:function(I,s){T.apply(this,arguments);this._viewport=null;this._handler=new d(this);this._gizmo=null;}});j.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);this.setAggregation("gizmo",new e());this._groupObserver=new M(this._onGroupChanged.bind(this));this._groupsObserver=new M(this._onGroupsChanged.bind(this));this._groupsObserver.observe(this,{aggregations:["items"]});};j.prototype.destroy=function(){j._cleanAssociatedLoaders();this._groupsObserver.disconnect();this._groupsObserver=null;this._groupObserver.disconnect();this._groupObserver=null;};j.prototype.setActive=function(v,k,l){T.prototype.setActive.call(this,v,k,l);if(this._viewport){if(v){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._addLocoHandler();}else{this._removeLocoHandler();if(this._gizmo){this._gizmo.hide();this._gizmo=null;}}}return this;};j.prototype.queueCommand=function(k){if(this._addLocoHandler()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")){k();}}return this;};j.prototype.setType=function(v){this.setProperty("type",v,true);if(this._gizmo){this._gizmo._recalculateOffsets();}};j.prototype.setAxis=function(v){this.setProperty("axis",v,true);if(this._gizmo){this._gizmo._updateAxis();}};j.prototype.setDirection=function(v){this.setProperty("direction",v,true);if(this._gizmo){this._gizmo._updateAxis();}};j.prototype.setAnchor=function(v){this.setProperty("anchor",v,true);if(this._gizmo){this._gizmo._updateAxis();}};j.prototype.pickAnchorFromNodesList=function(n){var t=null;var m=-1;var k=new THREE.Vector3();(Array.isArray(n)?n:[n]).forEach(function(l){var o=new THREE.Box3();l._expandBoundingBox(o,false,true,true);var s=o.getSize(new THREE.Vector3()).manhattanLength();if(m<s){m=s;t=l;o.getCenter(k);}});if(t!==null){this.setAnchor(t.matrixWorld.clone().setPosition(k).elements);}return t;};j.prototype.setMagnitude=function(v){v=Math.max(v,0);this.setProperty("magnitude",v,true);if(this._gizmo){this._gizmo._setMagnitude(v);}};j.prototype.setSelectedItem=function(v){this.setAssociation("selectedItem",v);if(this._gizmo){this._gizmo._handleSelectedItemChanged();}};j.prototype._onGroupsChanged=function(k){this._groupObserver.disconnect();this.getItems().forEach(function(l){this._groupObserver.observe(l,{aggregations:["items"]});}.bind(this));if(this._gizmo){this._gizmo._handleGroupsChanged(k);}};j.prototype._onGroupChanged=function(k){if(this._gizmo){this._gizmo._handleGroupsChanged(k);}};j.prototype.reset=function(){this.getItems().forEach(function(k){k.setMagnitudeAdjustmentMultiplier(0);});this.setMagnitude(0);this.setType(c.Linear);this.setAxis(undefined);this.setDirection(undefined);};j.prototype._activateView=function(k){var s=this._viewport.getScene();var v=s.getViewStateManager();var l=s.getViews()[k];v.activateView(l);var m=this._viewport._viewStateManager.getAnimationPlayer();if(m){setTimeout(function(){m.play();},100);}};j.prototype._createView=function(k,n,v,l,m,o,s){var p=this._viewport.getScene();var q=p.getViewStateManager();var r=p.createView({name:n});var t=[];if(k){var u=k.getNodeInfos();u.forEach(function(F){var G={target:F.target,transform:F.transform?F.transform.slice():null,meshId:F.meshId,materialId:F.materialId,visible:F.visible,opacity:F.opacity};t.push(G);});}else{var w=q.getNodeHierarchy();var x=function(F){if(F.visible){t.push({target:F,visible:F.visible});}w.enumerateChildren(F,x,false,true);};w.enumerateChildren(null,x,false,true);}r.setNodeInfos(t);var y={name:n,nodes:[]};if(k){y.sourceId=k.getViewId();y.exclude="PLAYBACK";var z=this._viewport.getCamera();var B={origin:z.getPosition(),target:z.getTargetDirection(),up:z.getUpDirection(),ortho:z instanceof O};if(B.ortho){B.zoom=z.getZoomFactor();}else{B.fov=z.getFov()/180*Math.PI;}y.camera=B;var C=this._viewport._viewStateManager.getAnimationPlayer();if(C){y.time=C.getTime();}}t=[];l.forEach(function(F){var G=F.node;var H=m.get(G);y.nodes.push({sid:p.nodeRefToPersistentId(G),transform:H.localMatrix});t.push({target:G,transform:H.localMatrix});});r.updateNodeInfos(t);var D=p.findViewGroupByView(k);y.groupIds=D?[D.getViewGroupId()]:[o];if(s!==null){y.sequence=s;}if(v){v.push(y);}return r;};j.prototype.generateRequestData=function(o,k){var p=o?o.viewPrefix:null;var l=[];var m=1.0;var s=this._viewport.getScene();var n=this._viewport.getCurrentView();var q=new Map();var r=new Map();var t=[];var u=[];var w=[];var x=[];var y=null;var z=[];var B=null;var C=this.getType();if(k){if(Array.isArray(k.views)){var D=k.views.findIndex(function(v){return v.id===n.getViewId();});if(D>=0){y=k.views[D].sequence+1;}z=k.views.slice(D+1);}B=k.id;}var F=new Map();if(o&&o.animation&&o.animation.enabled){this.getItems().forEach(function(k){k.getItems().forEach(function(v){var V=v.getNodeRef();V.updateMatrixWorld();var W=(new THREE.Vector3()).setFromMatrixPosition(V.matrixWorld);r.set(V.uuid,W);var X=new THREE.Matrix4();X.getInverse(V.parent.matrixWorld).multiply(V.matrixWorld);var Y=new THREE.Vector3();var Z=new THREE.Quaternion();var $=new THREE.Vector3();X.decompose(Y,Z,$);F.set(V,{localMatrix:i.convertTo4x3(X.elements),position:Y,worldPosition:W});});});this._gizmo._nodes.forEach(function(v){var V=v.node;V.matrix.elements[12]=v.local.x;V.matrix.elements[13]=v.local.y;V.matrix.elements[14]=v.local.z;V.position.setFromMatrixPosition(V.matrix);V.updateMatrixWorld(true);q.set(V,[v.local.x,v.local.y,v.local.z]);var W=(new THREE.Vector3()).setFromMatrixPosition(V.matrixWorld);var X=new THREE.Matrix4();X.getInverse(V.parent.matrixWorld).multiply(V.matrixWorld);var Y=new THREE.Vector3();var Z=new THREE.Quaternion();var $=new THREE.Vector3();X.decompose(Y,Z,$);var _=F.get(V);_.originalPosition=Y;_.originalWorldPosition=W;});}var G=new Set();var H=this._createView(n,p?p:h().getText("EXPLODETOOL_VIEW"),l,G,F,B,y);var I=l[l.length-1];if(o&&o.animation&&o.animation.enabled){if(!o.animation.separateAnimations){o.animation.separateViews=false;}var J=o.animation.sequencePrefix;var K=1;var L=new Map();var N=null;var P=[];var Q=[];var R="";this.getItems().forEach(function(k){w.push({name:k.getName()?k.getName():h().getText("EXPLODETOOL_GROUP_NODE",K),contentType:"REFERENCE",transform:[1,0,0,0,1,0,0,0,1,0,0,0]});I=l[l.length-1];if(o.animation.separateAnimations||o.animation.separateViews||K==1){if(P.length>0){u.push({name:R,endTime:m,joints:Q,nodes:P});P=[];Q=[];}if(o.animation.separateViews){R=h().getText("EXPLODETOOL_SEQUENCE_NAME",[I.name,1]);}else{R=h().getText("EXPLODETOOL_SEQUENCE_NAME",[I.name,K]);}R=J?h().getText("EXPLODETOOL_PREFIX_n",[J,K]):R;N=s.createSequence(H.getId()+"_seq"+K,{name:R,duration:m});var v=new A({sequence:N});H.addPlayback(v);H.resetPlaybacksStartTimes();if(!I.playbacks){I.playbacks=[];}I.playbacks.push({start:o.animation.separateViews?0:(K-1)*m,sequence:u.length});}var V=s.createTrack(null,{trackValueType:g.Vector3,isAbsoluteValue:false});this._gizmo._nodes.forEach(function(W){if(W.group==k){var X=W.node;var Y=s.nodeRefToPersistentId(X);Q.push(x.length);x.push({parent:K-1,childSid:Y});var Z=r.get(X.uuid);if(C===c.Radial||V.getKeysCount()==0){if(C===c.Radial&&V.getKeysCount()>0){V=s.createTrack(null,{trackValueType:g.Vector3,isAbsoluteValue:false});}var $=F.get(X);var _=[$.worldPosition.x-$.originalWorldPosition.x,$.worldPosition.y-$.originalWorldPosition.y,$.worldPosition.z-$.originalWorldPosition.z];V.insertKey(0,[0,0,0]);V.insertKey(m,_);t.push({time:[0,m],vector3:[0,0,0,_[0],_[1],_[2]]});}if(C===c.Radial){P.push({sid:Y,rtranslate:{track:t.length-1}});}N.setNodeAnimation(X,f.Translate,V);L.set(X,[Z.x,Z.y,Z.z]);G.add(W);}});if(C===c.Linear){P.push({node:K-1,rtranslate:{track:t.length-1}});}K++;if(o.animation.separateViews&&K<=this.getItems().length){H=this._createView(n,p?h().getText("EXPLODETOOL_PREFIX_n",[p,K]):h().getText("EXPLODETOOL_VIEW_n",K),l,G,F,B,y?++y:y);}}.bind(this));if(P.length>0){u.push({name:R,endTime:m,joints:Q,nodes:P});}}else{var S=[];I.nodes=[];this.getItems().forEach(function(k){k.getItems().forEach(function(v){var V=v.getNodeRef();var W=V.matrix.elements;var X=[W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10],W[12],W[13],W[14]];S.push({target:V,transform:X});I.nodes.push({sid:s.nodeRefToPersistentId(V),transform:X});});});H.updateNodeInfos(S);}var U=function(){var V={data:{views:l}};z.forEach(function(v){V.data.views.push({id:v.id,sequence:++y});});if(u.length>0){V.data.tree={nodes:w};V.data.animation={sequences:u,tracks:t,joints:x};}return V;};return U();};return j;});
