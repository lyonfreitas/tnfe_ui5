/*
 * ! SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(['./BaseController','sap/m/library','sap/ui/comp/library','./ChartWrapper','./Util','sap/ui/comp/odata/ChartMetadata',"sap/ui/mdc/library","sap/base/util/UriParameters","sap/m/MessageStrip"],function(B,M,C,c,U,d,e,f,g){"use strict";var D=B.extend("sap.ui.comp.personalization.DimeasureController",{constructor:function(i,s){B.apply(this,arguments);this.setType(M.P13nPanelType.dimeasure);this.setItemType(M.P13nPanelType.dimeasure+"Items");},metadata:{events:{afterDimeasureModelDataChange:{}}}});D.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(this.getTableType()!==C.personalization.TableType.ChartWrapper){throw"The provided object is incorrect. 'oTable' has to be an instance of sap.ui.comp.personalization.ChartWrapper. ";}var o=t.getChartObject();o.detachDrilledDown(this._onDrilledDown,this);o.attachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);o.attachDrilledUp(this._onDrilledUp,this);this._monkeyPatchTable(o);};D.prototype._monkeyPatchTable=function(o){var t=this;var s=o.setChartType.bind(o);var S=function(a){s(a);t._onSetChartType(a);};if(o.setChartType.toString()===S.toString()){return;}o.setChartType=S;};D.prototype._onSetChartType=function(s){var o=this.getControlData();if(!s||s===o.dimeasure.chartTypeKey){return;}this.fireBeforePotentialTableChange();o.dimeasure.chartTypeKey=s;this.updateControlDataBaseFromJson(o);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype._onDrilledDown=function(E){this.fireBeforePotentialTableChange();this._addVisibleDimensions(E.getParameter("dimensions")||[]);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype._addVisibleDimensions=function(a){if(!a.length){return;}var o=this.getControlData();var s=o.dimeasure.dimeasureItems.filter(function(m){return m.visible&&m.aggregationRole===C.personalization.AggregationRole.Dimension&&a.indexOf(m.columnKey)<0;}).reduce(function(b,m){return m.columnKey;},"");a.forEach(function(b){var i=U.getIndexByKey("columnKey",s,o.dimeasure.dimeasureItems)+1;var I=U.getIndexByKey("columnKey",b,o.dimeasure.dimeasureItems);s=b;if(I<0||i<0||I>o.dimeasure.dimeasureItems.length-1||i>o.dimeasure.dimeasureItems.length-1){return;}var m=o.dimeasure.dimeasureItems.splice(I,1);m[0].visible=true;o.dimeasure.dimeasureItems.splice(i,0,m[0]);var h=-1;o.dimeasure.dimeasureItems.forEach(function(j){if(j.index!==undefined){j.index=++h;}});this.updateControlDataBaseFromJson(o);},this);};D.prototype._onDrilledUp=function(E){this.fireBeforePotentialTableChange();var o=this.getControlData();var i=E.getParameter("dimensions")||[];i.forEach(function(s){var m=U.getArrayElementByKey("columnKey",s,o.dimeasure.dimeasureItems);if(!m){throw"No entry found in 'controlDataBase' for columnKey '"+s+"'";}m.visible=false;this.updateControlDataBaseFromJson(o);},this);this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype.getColumn2Json=function(o,s,i){if(!U.isAggregatable(o)){return null;}return{columnKey:s,index:i,visible:o.getVisible(),role:o.getRole(),aggregationRole:o.getAggregationRole()};};D.prototype.getAdditionalData2Json=function(j,t){var o=t.getChartObject();j.dimeasure.chartTypeKey=o.getChartType();};D.prototype.getColumn2JsonTransient=function(o,s,t,T){if(!U.isAggregatable(o)){return null;}return{columnKey:s,text:t,tooltip:T!==t?T:undefined,aggregationRole:o.getAggregationRole()};};D.prototype.handleIgnore=function(j,i){j.dimeasure.dimeasureItems[i].visible=false;};D.prototype.syncJson2Table=function(j){var o=this.getTable().getChartObject();var u=function(b,s,S,G){var h=U.copy(b);h.sort(D._sortByIndex);var i=[];h.forEach(function(k){if(k.visible===true){i.push(k.columnKey);var l=G(k.columnKey);if(l){l.setRole(k.role);}}});if(JSON.stringify(i)!==JSON.stringify(s)){S(i,true);}};this.fireBeforePotentialTableChange();var a=j.dimeasure.dimeasureItems.filter(function(b){return b.aggregationRole===C.personalization.AggregationRole.Dimension;});var m=j.dimeasure.dimeasureItems.filter(function(b){return b.aggregationRole===C.personalization.AggregationRole.Measure;});var v=o.getVisibleDimensions();u(a,v,o.setVisibleDimensions.bind(o),o.getDimensionByName.bind(o));var V=o.getVisibleMeasures();u(m,V,o.setVisibleMeasures.bind(o),o.getMeasureByName.bind(o));o.setChartType(j.dimeasure.chartTypeKey);this.fireAfterPotentialTableChange();};D.prototype.getDataSuiteFormat2Json=function(o){var j=this.createControlDataStructure();var a=function(s,p,P){var i=U.getIndexByKey("columnKey",s,j.dimeasure.dimeasureItems);if(i<0){i=j.dimeasure.dimeasureItems.length;j.dimeasure.dimeasureItems.splice(i,0,{columnKey:s});}j.dimeasure.dimeasureItems[i][p]=P;};this.getControlDataInitial().dimeasure.dimeasureItems.filter(function(m){return m.visible===true;}).forEach(function(m){a(m.columnKey,"visible",false);});if(o.Visualizations&&o.Visualizations.length){var b=o.Visualizations.filter(function(V){return V.Type==="Chart";});if(b.length){var v=0;if(b[0].Content.Dimensions.length){v=b[0].Content.Dimensions.length;b[0].Content.Dimensions.forEach(function(n,i){var A=U.getArrayElementByKey("Dimension",n,b[0].Content.DimensionAttributes);a(n,"visible",true);a(n,"index",i);if(A&&A.Role){a(n,"role",d.getDimensionRole(A.Role));}a(n,"aggregationRole",C.personalization.AggregationRole.Dimension);},this);}if(b[0].Content.Measures.length){b[0].Content.Measures.forEach(function(n,i){var A=U.getArrayElementByKey("Measure",n,b[0].Content.MeasureAttributes);a(n,"visible",true);a(n,"index",v+i);if(A&&A.Role){a(n,"role",d.getMeasureRole(A.Role));}a(n,"aggregationRole",C.personalization.AggregationRole.Measure);},this);}}j.dimeasure.chartTypeKey=d.getChartType(b[0].Content.ChartType);}return j;};D.prototype.getDataSuiteFormatSnapshot=function(o){var a=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!a.dimeasure||!a.dimeasure.dimeasureItems||!a.dimeasure.dimeasureItems.length){return;}var b=a.dimeasure.dimeasureItems.filter(function(h){return h.aggregationRole===C.personalization.AggregationRole.Dimension;}).filter(function(h){return h.visible===true;});var m=a.dimeasure.dimeasureItems.filter(function(h){return h.aggregationRole===C.personalization.AggregationRole.Measure;}).filter(function(h){return h.visible===true;});if(b.length||m.length){if(!o.Visualizations){o.Visualizations=[];}o.Visualizations.push({Type:"Chart",Content:{ChartType:d.getAnnotationChartType(a.dimeasure.chartTypeKey),Dimensions:b.map(function(h){return h.columnKey;}),DimensionAttributes:b.map(function(h){return{Dimension:h.columnKey,Role:d.getAnnotationDimensionRole(h.role)};}),Measures:m.map(function(h){return h.columnKey;}),MeasureAttributes:m.map(function(h){return{Measure:h.columnKey,Role:d.getAnnotationMeasureRole(h.role)};})}});}};D.prototype.getPanel=function(p){if(!U.hasAggregatableColumns(this.getColumnMap())){return null;}var a=(p&&p.availableChartTypes)?p.availableChartTypes:[];return new Promise(function(r){sap.ui.require(['sap/m/P13nDimMeasurePanel','sap/m/P13nItem','sap/m/P13nDimMeasureItem','sap/ui/core/ResizeHandler'],function(P,b,h,R){var o=new P({availableChartTypes:a,chartTypeKey:"{$sapmP13nPanel>/controlDataReduce/dimeasure/chartTypeKey}",items:{path:'$sapmP13nPanel>/transientData/dimeasure/dimeasureItems',template:new b({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',tooltip:'{$sapmP13nPanel>tooltip}',aggregationRole:'{$sapmP13nPanel>aggregationRole}'})},dimMeasureItems:{path:"$sapmP13nPanel>/controlDataReduce/dimeasure/dimeasureItems",template:new h({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",role:"{$sapmP13nPanel>role}"})},beforeNavigationTo:this.setModelFunction(),changeChartType:function(E){var i=this.getControlDataReduce();i.dimeasure.chartTypeKey=E.getParameter("chartTypeKey");this.setControlDataReduce2Model(i);this.fireAfterPotentialModelChange({json:i});}.bind(this),changeDimMeasureItems:function(E){if(!E.getParameter("items")){return;}var i=E.getParameter("items");var j=this.getControlDataReduce();j.dimeasure.dimeasureItems.forEach(function(m){var k=U.getArrayElementByKey("columnKey",m.columnKey,i);if(!k){return;}m.index=k.index;m.visible=k.visible;m.role=k.role;});this.setControlDataReduce2Model(j);this.fireAfterPotentialModelChange({json:j});}.bind(this)});R.deregister(o._sContainerResizeListener);return r(o);}.bind(this));}.bind(this));};D.prototype.getChartTypeLayoutConfig=function(){if(this._aChartTypeLayout){return this._aChartTypeLayout;}var a=[e.ChartItemRoleType.axis1,e.ChartItemRoleType.category,e.ChartItemRoleType.series];var A=[e.ChartItemRoleType.axis1,e.ChartItemRoleType.axis2,e.ChartItemRoleType.category,e.ChartItemRoleType.series];var b=[e.ChartItemRoleType.axis1,e.ChartItemRoleType.category,e.ChartItemRoleType.category2];var h=[e.ChartItemRoleType.axis1,e.ChartItemRoleType.axis2,e.ChartItemRoleType.axis3,e.ChartItemRoleType.category,e.ChartItemRoleType.series];this._aChartTypeLayout=[{key:"column",allowedLayoutOptions:a},{key:"bar",allowedLayoutOptions:a},{key:"line",allowedLayoutOptions:a},{key:"combination",allowedLayoutOptions:a},{key:"pie",allowedLayoutOptions:a},{key:"donut",allowedLayoutOptions:a},{key:"dual_column",allowedLayoutOptions:A},{key:"dual_bar",allowedLayoutOptions:A},{key:"dual_line",allowedLayoutOptions:A},{key:"stacked_bar",allowedLayoutOptions:a},{key:"scatter",allowedLayoutOptions:A},{key:"bubble",allowedLayoutOptions:h},{key:"heatmap",allowedLayoutOptions:b},{key:"bullet",allowedLayoutOptions:a},{key:"vertical_bullet",allowedLayoutOptions:a},{key:"dual_stacked_bar",allowedLayoutOptions:A},{key:"100_stacked_bar",allowedLayoutOptions:a},{key:"stacked_column",allowedLayoutOptions:a},{key:"dual_stacked_column",allowedLayoutOptions:A},{key:"100_stacked_column",allowedLayoutOptions:a},{key:"dual_combination",allowedLayoutOptions:A},{key:"dual_horizontal_combination",allowedLayoutOptions:A},{key:"dual_horizontal_combination",allowedLayoutOptions:A},{key:"dual_stacked_combination",allowedLayoutOptions:A},{key:"dual_horizontal_stacked_combination",allowedLayoutOptions:A},{key:"stacked_combination",allowedLayoutOptions:a},{key:"100_dual_stacked_bar",allowedLayoutOptions:a},{key:"100_dual_stacked_column",allowedLayoutOptions:a},{key:"horizontal_stacked_combination",allowedLayoutOptions:a},{key:"waterfall",allowedLayoutOptions:b},{key:"horizontal_waterfall",allowedLayoutOptions:b}];return this._aChartTypeLayout;};D.prototype._getTimeseriesSpecificPanelLayout=function(s){if(s.includes("timeseries")){var a=[e.ChartItemRoleType.axis1,e.ChartItemRoleType.category,e.ChartItemRoleType.series];this._aChartTypeLayoutTimeseries=[{key:"timeseries_scatter",allowedLayoutOptions:a}];var l=this._aChartTypeLayoutTimeseries.find(function(i){return i.key===s;});if(l){return l;}else{var b=s.replace("timeseries_","");return this.getChartTypeLayoutConfig().find(function(i){return i.key===b;});}}return undefined;};D.prototype.retrieveAdaptationUI=function(p){function s(I,o){if(!I.hasOwnProperty('index')||!o.hasOwnProperty('index')){return 0;}if(I.index<o.index){return-1;}if(I.index>o.index){return 1;}return 0;}if(f.fromQuery(window.location.search).get("newChartP13n")==="true"){var r;var i=new Promise(function(a,b){r=a;});sap.ui.require(["sap/ui/mdc/p13n/panels/ChartItemPanelNew"],function(a){var l,o=this.getControlDataReduce().dimeasure.chartTypeKey;var S=[{kind:"Dimension"},{kind:"Measure"}];if(o.includes("timeseries")){l=this._getTimeseriesSpecificPanelLayout(o);}if(!l){l=this.getChartTypeLayoutConfig().find(function(k){return k.key===o;});}if(!l){var R=[e.ChartItemRoleType.axis1,e.ChartItemRoleType.axis2,e.ChartItemRoleType.axis3,e.ChartItemRoleType.category,e.ChartItemRoleType.category2,e.ChartItemRoleType.series];l={key:o,allowedLayoutOptions:R};}l.templateConfig=S;var b=new a({panelConfig:l,changeItems:function(E){if(!E.getParameter("items")){return;}var I=E.getParameter("items");var k=this.getControlDataReduce();k.dimeasure.dimeasureItems.forEach(function(m){var n=U.getArrayElementByKey("columnKey",m.columnKey,I);if(!n){return;}m.index=n.index;m.visible=n.visible;m.role=n.role;});this.setControlDataReduce2Model(k);this.fireAfterPotentialModelChange({json:k});}.bind(this)});var h=this.getAdaptationData().sort(s);b.setP13nData(h);this.oPanel=b;if(o==="heatmap"||o==="timeseries_heatmap"){var j=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");b.setMessageStrip(new g({text:j.getText("chart.PERSONALIZATION_DIALOG_MEASURE_WARNING"),type:"Warning"}));}r(b);}.bind(this));return i;}else{return this.getPanel(p);}};D.prototype._transformAdaptationData=function(r,t){var a=B.prototype._transformAdaptationData.apply(this,arguments);a.visible=r.visible;a.role=r.role;a.kind=r.aggregationRole;a.index=r.index;return a;};D.prototype._isDimMeasureItemEqual=function(o,a){if(!o&&!a){return true;}if(o&&!a){if(o.index===-1&&o.visible===false){return true;}return false;}if(a&&!o){if(a.index===-1&&a.visible===false){return true;}return false;}for(var p in o){if(a[p]===undefined||o[p]!==a[p]){return false;}}return true;};D.prototype._isSemanticEqual=function(p,P){if(p.dimeasure.chartTypeKey!==P.dimeasure.chartTypeKey){return false;}var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var h=U.copy(p.dimeasure.dimeasureItems).sort(s);var i=U.copy(P.dimeasure.dimeasureItems).sort(s);var I=true;h.some(function(o,a){if(!this._isDimMeasureItemEqual(o,i[a])){I=false;return true;}},this);return I;};D.prototype.getChangeType=function(p,P){if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return C.personalization.ChangeType.Unchanged;}return this._isSemanticEqual(p,P)?C.personalization.ChangeType.Unchanged:C.personalization.ChangeType.ModelChanged;};D.prototype.getChangeData=function(p,P){if(!p||!p.dimeasure||!p.dimeasure.dimeasureItems){return this.createControlDataStructure();}if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}if(!this._isSemanticEqual(p,P)){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}return null;};D.prototype.getUnionData=function(j,J){if(!J||!J.dimeasure||!J.dimeasure.dimeasureItems){return U.copy(j);}var u=U.copy(J);Object.keys(j.dimeasure).forEach(function(a){if(Array.isArray(j.dimeasure[a])){j.dimeasure[a].forEach(function(m){var o=U.getArrayElementByKey("columnKey",m.columnKey,u.dimeasure[a]);if(!o){u.dimeasure[a].push(m);return;}if(o.visible===undefined&&m.visible!==undefined){o.visible=m.visible;}if(o.role===undefined&&m.role!==undefined){o.role=m.role;}if(o.index===undefined&&m.index!==undefined){o.index=m.index;}if(o.aggregationRole===undefined&&m.aggregationRole!==undefined){o.aggregationRole=m.aggregationRole;}});return;}if(u.dimeasure[a]===undefined&&j.dimeasure[a]!==undefined){u.dimeasure[a]=j.dimeasure[a];}},this);return u;};D._sortByIndex=function(a,b){if(a.index!==undefined&&b.index===undefined){return-1;}if(b.index!==undefined&&a.index===undefined){return 1;}if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;};D.prototype.isChartConsistent=function(o){var t=this.getTable();if(!t){return Promise.resolve(true);}var a=t.getChartObject();if(!a){return Promise.resolve(true);}return sap.ui.getCore().loadLibrary("sap.chart",{async:true}).then(function(){try{var r=sap.chart.api.getChartTypeLayout(o.dimeasure.chartTypeKey,a.getDimensions(),a.getMeasures());return r.errors.length===0;}catch(E){return false;}});};D.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t){var o=t.getChartObject();if(o){o.detachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);}}};return D;});
