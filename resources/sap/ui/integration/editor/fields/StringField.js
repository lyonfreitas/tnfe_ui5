/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/Title","sap/m/Select","sap/m/ComboBox","sap/m/Popover","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/core/ListItem","sap/m/List","sap/m/CustomListItem","sap/m/VBox","sap/base/util/each","sap/base/util/restricted/_debounce","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/ui/integration/editor/EditorResourceBundles","sap/base/util/deepClone","sap/ui/model/Sorter","sap/ui/core/SeparatorItem","sap/base/util/includes","sap/base/util/merge","sap/ui/core/CustomData"],function(B,I,T,a,S,C,P,b,O,c,L,d,e,V,f,_,g,J,E,h,j,k,l,m,n){"use strict";var R=/parameters\.([^\}\}]+)/g;var s=["TODAY_ISO","NOW_ISO","LOCALE"];var o=B.extend("sap.ui.integration.editor.fields.StringField",{metadata:{library:"sap.ui.integration"},renderer:B.getMetadata().getRenderer()});o.prototype.initVisualization=function(p){var v=p.visualization;if(!v){var r=p.value?p.value.match(R):undefined;var q,t,u;if(r&&r.length>0){r=r.filter(function(i){var x=i.substring(11);return!l(s,x);});}if(r&&r.length>0){q=r.map(function(i){if(this.isOrigLangField){return"items>"+i.substring(11)+"/_language/value";}return"items>"+i.substring(11)+"/value";}.bind(this));q.unshift("currentSettings>value");t={parts:q,formatter:function(x){var A=Array.prototype.slice.call(arguments,1);for(var i=0;i<A.length;i++){if(A[i]){x=x.replaceAll("{{"+r[i]+"}}",A[i]);}}return x;}};u=function(i){var x=i.getSource().getValue();var y=this.getBindingContext("currentSettings").sPath;var z=this.getModel("currentSettings");z.setProperty(y+"/value",x);var A=z.getBindings();var D=y.substring(y.lastIndexOf("/")+1);f(A,function(F,G){if(G.sPath==="/form/items/"+D+"/value"){G.checkUpdate(true);}});}.bind(this);}if(this.getMode()==="translation"){if(p.editable){v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:p.editable,visible:p.visible,placeholder:p.placeholder}};}else{v={type:T,settings:{text:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},visible:p.visible,wrapping:false}};}}else if(p.enum){var w=new L({key:{path:"currentSettings>"},text:{path:"currentSettings>"}});v={type:S,settings:{selectedKey:{path:'currentSettings>value'},forceSelection:false,editable:p.editable,visible:p.visible,showSecondaryValues:false,width:"100%",items:{path:"currentSettings>enum",template:w}}};}else if(p.values){var w=this.formatListItem(p.values.item);if(!p.values.item.key){p.values.item.key=p.values.item.text;}v={type:C,settings:{busy:{path:'currentSettings>_loading'},selectedKey:{path:'currentSettings>value'},editable:p.editable,visible:p.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:w}}};if(this.isFilterBackend()){v.settings.selectedKey={parts:['currentSettings>value','currentSettings>suggestValue'],formatter:function(i,x){if((!i||i==="")&&x){return x.replaceAll('\'\'',"'");}else{return i;}}};}}else{v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:p.editable,visible:p.visible,placeholder:p.placeholder}};if(q){delete v.settings.tooltip;v.settings.value=t;v.settings.change=u;}}}this._visualization=v;this.attachAfterInit(this._afterInit);};o.prototype._afterInit=function(){var i=this.getAggregation("_field");if(i instanceof C){if(this.isFilterBackend()){this.onInput=_(this.onInput,500);i.oninput=this.onInput;i.attachSelectionChange(this.onSelectionChange);}}};o.prototype.onSelectionChange=function(i){var p=i.getParameter("selectedItem")||{};var K=p.getKey();var q=this.getBindingContext("currentSettings").sPath;var r=this.getModel("currentSettings");r.setProperty(q+"/value",K);};o.prototype.onInput=function(i){var t=i.target.value;var p=this.getBindingContext("currentSettings").sPath;var q=this.getModel("currentSettings");q.setProperty(p+"/suggestValue",t.replaceAll("'","\'\'"));q.setProperty(p+"/_loading",true);q.setProperty(p+"/value","");var r=q.getBindings();var u=p.substring(p.lastIndexOf("/")+1);f(r,function(w,x){if(x.sPath==="/form/items/"+u+"/value"){x.checkUpdate(true);}});var v=i.srcControl;v.open();v.setValue(t);v.setSelection(null);};o.prototype.getOriginTranslatedValues=function(i){var q=[];var r=E.getInstance(i._resourceBundleURL);for(var p in r){var t=r[p];var K;if(i._translatedDefaultPlaceholder.startsWith("{i18n>")&&i._translatedDefaultPlaceholder.endsWith("}")){K=i._translatedDefaultPlaceholder.substring(6,i._translatedDefaultPlaceholder.length-1);}else if(i._translatedDefaultPlaceholder.startsWith("{{")&&i._translatedDefaultPlaceholder.endsWith("}}")){K=i._translatedDefaultPlaceholder.substring(2,i._translatedDefaultPlaceholder.length-2);}var u="";var v="";if(K&&t){var w=t.resourceBundle.getText(K,[],true);if(w!==undefined){u=w;v=w;}}else{u=i._translatedDefaultPlaceholder;v=i._translatedDefaultPlaceholder;}var x={"key":p,"desription":t.language,"value":u,"originValue":v,"editable":true};q.push(x);}return q;};o.prototype.openTranslationListPopup=function(i){var t=this;var p=i.getSource();var F=p.getParent();var q=F.getConfiguration();if(!t._aOriginTranslatedValues){t._aOriginTranslatedValues=F.getOriginTranslatedValues(q);}var r=h(t._aOriginTranslatedValues,500);var u=g.getLibraryResourceBundle("sap.ui.integration");r.forEach(function(x){if(q.valueTranslations&&q.valueTranslations[x.key]){x.value=q.valueTranslations[x.key];if(!l(t._aUpdatedLanguages,x.key)){x.originValue=x.value;}}x.status=u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");if(x.key===u.sLocale){x.editable=false;}});var v={"currentLanguage":{},"isUpdated":false,"translatedLanguages":[]};var M;if(r){r.forEach(function(x){if(l(t._aUpdatedLanguages,x.key)){x.value=q.valueTranslations[x.key];x.status=u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");}if(x.key===u.sLocale){x.value=p.getValue();v.currentLanguage=x;}else{v.translatedLanguages.push(x);}});}if(!t._oTranslationPopover){var w=new d({items:{path:"languages>/translatedLanguages",template:new e({content:[new V({items:[new T({text:"{languages>desription}"}),new I({value:"{languages>value}",editable:"{languages>editable}"})]})],customData:[new n({key:"{languages>key}",value:"{languages>desription}"})]}),sorter:[new j({path:'status',descending:true,group:true})],groupHeaderFactory:t.getGroupHeader}});t._oTranslationPopover=new P({placement:"Right",contentWidth:"300px",contentHeight:"345px",customHeader:new V({items:[new a({text:u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_TITLE")}).addStyleClass("sapMPopoverTitle"),new a({text:u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_CURRENTLANGUAGE")}).addStyleClass("sapMHeaderTitle"),new V({items:[new T({text:"{languages>/currentLanguage/desription}"}),new I({value:"{languages>/currentLanguage/value}",editable:false})]}).addStyleClass("sapMCurrentLanguageVBox"),new a({text:u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_OTHERLANGUAGES")}).addStyleClass("sapMHeaderTitle")]}),content:w,footer:new O({content:[new c(),new b({type:"Emphasized",text:u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_SAVE"),enabled:"{languages>/isUpdated}",press:function(){var x=t._oTranslationPopover.getModel("languages").getData();var y=h(q.valueTranslations,500);var z={};var U=[];x.translatedLanguages.forEach(function(A){if(A.value!==A.originValue){z[A.key]=A.value;U.push(A.key);}});if(x.currentLanguage.value!=x.currentLanguage.originValue){z[x.currentLanguage.key]=x.currentLanguage.value;U.push(x.currentLanguage.key);}if(z!=={}){q.valueTranslations=m(y,z);q._changed=true;}if(U.length>0){t._aUpdatedLanguages=U;}t._oTranslationPopover.close();}}),new b({text:u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_CANCEL"),press:function(){t._oTranslationPopover.close();}})]})}).addStyleClass("sapUiIntegrationFieldTranslation");M=new J(v);M.attachPropertyChange(function(i){var D=M.getData();var U=u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");var N=u.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");var x=false;D.translatedLanguages.forEach(function(y){if(y.value!==y.originValue){y.status=U;x=true;}else{y.status=N;}});D.isUpdated=x;M.setData(D);M.checkUpdate(true);});t._oTranslationPopover.setModel(M,"languages");}else{M=t._oTranslationPopover.getModel("languages");M.setData(v);M.checkUpdate(true);}t._oTranslationPopover.openBy(p);};o.prototype.getGroupHeader=function(G){return new k({text:G.key});};return o;});
