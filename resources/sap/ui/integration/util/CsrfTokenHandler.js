/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/base/util/isPlainObject","sap/ui/model/json/JSONModel"],function(B,i,J){"use strict";var r=/\{\{csrfTokens.([^\}]+)/;var T="X-CSRF-Token";var C=B.extend("sap.ui.integration.util.CsrfTokenHandler",{metadata:{library:"sap.ui.integration"},constructor:function(s){B.call(this);s=s||{};this._oHost=s.host;this._oConfiguration=s.configuration;}});C._mTokens=new Map();C.prototype.resolveToken=function(d){var c=this._findCsrfPlaceholder(d),o;if(!c){return Promise.resolve(d);}o=this._getCsrfConfig(c);if(this._oHost){return this._oHost.getCsrfToken(o).then(function(t){if(!t){return this._resolveTokenByUrl(d);}this._replaceCsrfPlaceholder(d,t);return d;}.bind(this)).catch(function(e){return Promise.reject(e);});}return this._resolveTokenByUrl(d);};C.prototype._resolveTokenByUrl=function(d){var c=this._findCsrfPlaceholder(d),s=this._getCsrfConfig(c).data.request.url;if(C._mTokens.has(s)){return C._mTokens.get(s).then(function(t){this._replaceCsrfPlaceholder(d,t);return d;}.bind(this));}if(c){return this._requestToken(d);}return Promise.resolve(d);};C.prototype.setDataProviderFactory=function(d){this._oDataProviderFactory=d;};C.prototype.setHost=function(h){this._oHost=h;};C.prototype.isExpiredToken=function(j){if(!j){return false;}var x=j.getResponseHeader(T);return x&&x.toLowerCase()==="required"&&j.status===403;};C.prototype._requestToken=function(d){var c=this._findCsrfPlaceholder(d),o=this._getCsrfConfig(c);if(!c||!o){return Promise.reject("CSRF definition is incorrect");}var p=new Promise(function(a,b){var e=this._oDataProviderFactory.create(o.data);e.getData().then(function(D){var t,m;if(o.data.path){m=new J(D);t=m.getProperty(o.data.path);m.destroy();}else{t=e.getLastJQXHR().getResponseHeader(T);}a(t);}).catch(function(){b("CSRF token cannot be resolved");});}.bind(this));this._registerToken(o,p);return p.then(function(t){this._replaceCsrfPlaceholder(d,t);return d;}.bind(this));};C.prototype.resetTokenByRequest=function(d){var c=this._findCsrfPlaceholder(d);if(!c){return;}this._deleteRegisteredToken(this._getCsrfConfig(c));};C.prototype._getCsrfConfig=function(c){return this._oConfiguration[c];};C.prototype._findCsrfPlaceholder=function(d){var h=this._findCsrfInHeaders(d);if(h){return this._getCsrfName(d.headers[h]);}return null;};C.prototype._replaceCsrfPlaceholder=function(d,t){d.headers[T]=t;};C.prototype._findCsrfInHeaders=function(d){if(!d||!d.headers||!i(d.headers)){return"";}for(var k in d.headers){if(typeof d.headers[k]==="string"&&this._hasCsrf(d.headers[k])){return k;}}return"";};C.prototype._hasCsrf=function(s){return!!s.match(r);};C.prototype._getCsrfName=function(s){var m=s.match(r);if(!m){return"";}return m[1];};C.prototype._registerToken=function(c,p){C._mTokens.set(c.data.request.url,p);if(this._oHost){this._oHost.csrfTokenFetched(c,p);}};C.prototype._deleteRegisteredToken=function(c){C._mTokens.delete(c.data.request.url);if(this._oHost){this._oHost.csrfTokenExpired(c);}};return C;});
