/*
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./BaseController","./DraftController","sap/ui/generic/app/util/ModelUtil","sap/base/util/extend"],function(q,B,D,M,e){"use strict";var T=B.extend("sap.ui.generic.app.transaction.TransactionController",{metadata:{publicMethods:["destroy","setBatchStrategy","getDraftController","invokeAction","editEntity","deleteEntity","deleteEntities","propertyChanged","hasClientValidationErrors","resetChanges","getDefaultValues","getDefaultValuesFunction"]},constructor:function(m,Q,p){B.apply(this,[m,Q]);this.sName="sap.ui.generic.app.transaction.TransactionController";this._oDraft=null;p=p||{};if(!p.noBatchGroups){m.setDeferredGroups(["Changes"]);m.setChangeGroups({"*":{groupId:"Changes",changeSetId:"Changes",single:false}});}return this.getInterface();}});T.prototype.setBatchStrategy=function(s){var n,c=this._oModel.getChangeGroups();for(n in c){c[n].single=s;}this._oModel.setChangeGroups(c);};T.prototype.getDraftController=function(){if(!this._oDraft){this._oDraft=new D(this._oModel,this._oQueue);}return this._oDraft;};T.prototype.editEntity=function(c,p,r){var t=this;return new Promise(function(a){var d,E;d=t.getDraftController().getDraftContext();E=M.getEntitySetFromContext(c);if(d.isDraftEnabled(E)&&t._oDraftUtil.isActiveEntity(c.getObject())){return a(t.getDraftController().createEditDraftEntity(c,p,r));}return a({context:c});});};T.prototype.deleteEntity=function(E,p,i){var P,o,t=this,s,c,d;if(typeof E=="string"){s=E;}else if(typeof E=="object"&&E instanceof sap.ui.model.Context){c=E;s=c.getPath();}p=p||{};q.extend(p,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true,context:c});var h=i?"lenient":"strict";p.headers={Prefer:"handling="+h};if(t._oModel.getObject(s)&&t._oDraftUtil.isActiveEntity(t._oModel.getObject(s))!==undefined&&!t._oDraftUtil.isActiveEntity(t._oModel.getObject(s))){if(!c){c=new sap.ui.model.Context(this._oModel,s);}d=t.getDraftController();P=d.discardDraft(c,p);}else{P=this._remove(s,p);}P.then(function(r){return t._normalizeResponse(r,true);},function(r){var R=t._normalizeError(r);throw R;});o=this.triggerSubmitChanges(p);return this._returnPromiseAll([P,o]);};T.prototype.deleteEntities=function(E,p){var P,a=[],t=this,s,c,d;p=p||{};var h=p.bIsStrict?"strict":"lenient";p.headers=p.headers||{};p.headers.Prefer="handling="+h;q.extend(p,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true});var r=function(o){return t._normalizeResponse(o,true);};var R=function(o){var b=t._normalizeError(o);throw b;};for(var i=0;i<E.length;i++){c=null;if(typeof E[i]=="string"){s=E[i];}else if(typeof E[i]=="object"&&E[i]instanceof sap.ui.model.Context){c=E[i];s=c.getPath();}if(t._oModel.getObject(s)&&t._oDraftUtil.isActiveEntity(t._oModel.getObject(s))!==undefined&&!t._oDraftUtil.isActiveEntity(t._oModel.getObject(s))){p.changeSetId="Changes";if(!c){c=new sap.ui.model.Context(this._oModel,s);}d=t.getDraftController();P=d.discardDraft(c,p).then(r,R);}else{p.changeSetId="ActiveChanges";P=this._remove(s,p).then(r,R);}a.push(P);}P=this.triggerSubmitChanges(p);a.push(P);return this._atLeastOnePromiseResolved(a,true);};T.prototype.invokeAction=function(f,c,p){var t=this,P,o;P=this.hasClientMessages();if(P){return P;}p={batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:p.urlParameters,forceSubmit:true,context:c};P=this._callAction(f,c,p).then(function(r){return t._normalizeResponse(r,true);},function(r){var O=t._normalizeError(r);throw O;});this._oModel.refresh(true,false,"Changes");o=this.triggerSubmitChanges(p);return this._returnPromiseAll([P,o]);};T.prototype.resetChanges=function(k){this._oModel.resetChanges(k);};T.prototype.propertyChanged=function(E,p,b){var d,c,P={batchGroupId:"Changes",changeSetId:"Changes",binding:b};d=this.getDraftController().getDraftContext();if(d.checkUpdateOnChange(E,p)){c=b.getBoundContext();if(d.hasDraftPreparationAction(c)){return this.getDraftController().saveAndPrepareDraftEntity(c,P);}P.onlyIfPending=true;return this.triggerSubmitChanges(P);}P.onlyIfPending=true;P.noShowResponse=true;P.noBlockUI=true;return this.triggerSubmitChanges(P);};T.prototype.getDefaultValues=function(c,p,n,f){var E,a;if(!c&&!c instanceof sap.ui.model.Context){throw new Error("No context");}var s=M.getEntitySetFromContext(c);if(!s&&s===""){throw new Error("No EntitySet found in the current context");}var m=c.getModel().getMetaModel();var b=m.getODataEntitySet(s).entityType;var o=m.getODataEntityType(b);if(n){o['navigationProperty'].forEach(function(N){if(N.name===n){E=N;}});var C=m.getODataEntityType(m.getODataAssociationEnd(o,n).type);a=C.property;}else if(f){E=m.getODataFunctionImport(f);a=E.parameter;}else{E=m.getODataEntitySet(s);a=o.property;}var d=this.getDefaultValuesFunction(E);if(d){var P={successMsg:"Call of action succeeded",failedMsg:"Call of action failed",urlParameters:null,forceSubmit:true,context:c,headers:{"If-Match":"*"}};var g=this._callAction(d,c,P).then(function(r){if(r.httpResponse.statusCode==="200"){var i=d.split("/");var f=i[1];var R=r.responseData[f]||r.responseData;var j={};a.forEach(function(t){if(R.hasOwnProperty(t.name)){j[t.name]=R[t.name];}});if(p){var k={};for(var l in p){if(p[l]!==""){k[l]=p[l];}}p=e({},k,j);}else{p=j;}return p;}});var h=this.triggerSubmitChanges(P);return this._returnPromiseAll([g,h]);}else{return p;}};T.prototype.getDefaultValuesFunction=function(E){var d=E["com.sap.vocabularies.Common.v1.DefaultValuesFunction"];var s=d?"/"+d.String:null;return s;};T.prototype.destroy=function(){B.prototype.destroy.apply(this,[]);if(this._oDraft){this._oDraft.destroy();}this._oDraft=null;};return T;},true);
