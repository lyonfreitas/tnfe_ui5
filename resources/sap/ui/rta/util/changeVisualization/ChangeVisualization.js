/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/deepEqual","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Control","sap/ui/dt/OverlayRegistry","sap/ui/dt/ElementUtil","sap/ui/events/KeyCodes","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel","sap/ui/rta/util/changeVisualization/ChangeIndicator","sap/ui/rta/util/changeVisualization/ChangeIndicatorRegistry"],function(d,a,L,J,C,O,E,K,b,c,P,e,F,R,f,g,h){"use strict";var V={add:["createContainer","addDelegateProperty","reveal","addIFrame"],move:["move"],rename:["rename"],combinesplit:["combine","split"],remove:["remove"]};var i="all";var j={all:"sap-icon://show",add:"sap-icon://add",move:"sap-icon://move",rename:"sap-icon://edit",combinesplit:"sap-icon://combine",remove:"sap-icon://less"};var k=C.extend("sap.ui.rta.util.changeVisualization.ChangeVisualization",{metadata:{library:"sap.ui.rta",properties:{rootControlId:{type:"string"},isActive:{type:"boolean",defaultValue:false}}},constructor:function(){C.prototype.constructor.apply(this,arguments);this._oChangeIndicatorRegistry=new h({commandCategories:V});this._oTextBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this.setModel(new R({bundle:this._oTextBundle}),"i18n");this._oChangeVisualizationModel=new f({active:this.getIsActive()});this._oChangeVisualizationModel.setDefaultBindingMode("OneWay");this._sSelectedCommandCategory="all";this._bSetModeChanged=false;}});k.prototype.setRootControlId=function(r){if(this.getRootControlId()&&this.getRootControlId()!==r){this._reset();}this.setProperty("rootControlId",r);};k.prototype._getComponent=function(){return F.getAppComponentForControl(E.getElementInstance(this.getRootControlId()));};k.prototype.setIsActive=function(A){if(A===this.getIsActive()){return;}this.setProperty("isActive",A);if(this._oChangeVisualizationModel){this._updateVisualizationModel({active:A});}};k.prototype.exit=function(){this._oChangeIndicatorRegistry.destroy();if(this.oRootOverlay){this.oRootOverlay.getDomRef().removeEventListener("click",o.bind(null,this.oMenuButton),{capture:true});}};k.prototype._reset=function(){this._oChangeIndicatorRegistry.reset();};k.prototype._updateVisualizationModelMenuData=function(){var l=Object.keys(V).map(function(s){var t=this._getCommandCategoryLabel(s,this._getChangesForCommandCategory(s).length);return{key:s,count:this._getChangesForCommandCategory(s).length,title:t,icon:j[s]};}.bind(this));l.unshift({key:i,count:this._getChangesForCommandCategory(i).length,title:this._getCommandCategoryLabel(i,this._getChangesForCommandCategory(i).length),icon:j[i]});this._updateVisualizationModel({commandCategories:l});};k.prototype._getChangesForCommandCategory=function(s){var r=this._oChangeIndicatorRegistry.getChanges();return r.filter(function(l){return s===i?l.commandCategory!==undefined:s===l.commandCategory;});};k.prototype._getCommandCategoryLabel=function(s,l){var m="TXT_CHANGEVISUALIZATION_OVERVIEW_"+s.toUpperCase();return this._oTextBundle.getText(m,[l]);};k.prototype._getCommandCategoryButton=function(s){var B="BTN_CHANGEVISUALIZATION_OVERVIEW_"+s.toUpperCase();return this._oTextBundle.getText(B);};k.prototype.onCommandCategorySelection=function(l){var s=l.getParameter("item").getKey();return this._selectCommandCategory(s);};k.prototype._selectCommandCategory=function(s){this._sSelectedCommandCategory=s;var r=this._getChangesForCommandCategory(s);var l=this._getCommandCategoryButton(s);this._updateVisualizationModel({commandCategory:s,commandCategoryText:l});return Promise.all(r.map(function(m){return this._getVisualizationInfo(m).then(function(v){this._oChangeIndicatorRegistry.addVisualizationInfo(m.change.getId(),v);}.bind(this));}.bind(this))).then(function(){this._updateChangeIndicators();this._setFocusedIndicator();}.bind(this));};k.prototype._getVisualizationInfo=function(m){var l=this._getComponent();function n(s){if(!s){return undefined;}return s.map(function(S){var p=typeof S.getId==="function"?S:J.bySelector(S,l);return p&&p.getId();}).filter(Boolean);}return this._getInfoFromChangeHandler(l,m.change).then(function(I){var v=I||{};var A=(n(v.affectedControls||[m.change.getSelector()]));return{affectedElementIds:A,dependentElementIds:n(v.dependentControls)||[],displayElementIds:n(v.displayControls)||A,payload:v.payload};});};k.prototype._getCommandForChange=function(l){var s=l.getDefinition().support.command;if(s){return s;}var m=this._getComponent();var S=J.bySelector(l.getSelector(),m);var n=l.getDependentSelectorList().slice(-1)[0];var p=J.bySelector(n,m);function q(r,A){var t=r.getElement();var s=r.getDesignTimeMetadata().getCommandName(l.getChangeType(),t,A);if(s){return s;}var u=r.getParentElementOverlay();var v=r.getParentAggregationOverlay();if(r.getElement().getId()===S.getId()||!u){return undefined;}return q(u,v&&v.getAggregationName());}return S&&p&&q(O.getOverlay(p));};k.prototype._getInfoFromChangeHandler=function(A,l){var m=J.bySelector(l.getSelector(),A);if(m){var p={modifier:J,appComponent:A,view:F.getViewForControl(m)};var n=b.getControlIfTemplateAffected(l,m,p);return c.getChangeHandler({changeType:l.getChangeType(),element:n.control,modifier:J,layer:l.getLayer()}).then(function(q){if(q&&typeof q.getChangeVisualizationInfo==="function"){return q.getChangeVisualizationInfo(l,A);}return undefined;}).catch(function(v){L.error(v);return undefined;});}return Promise.resolve();};k.prototype._collectChanges=function(){var l=this._getComponent();var p={oComponent:l,selector:l,invalidateCache:false,includeVariants:true,currentLayer:e.CUSTOMER};return P._getUIChanges(p);};k.prototype._updateChangeRegistry=function(){return this._collectChanges().then(function(l){var r=this._oChangeIndicatorRegistry.getChangeIds();var m=l.reduce(function(p,q){p[q.getId()]=q;return p;},{});var n=Object.keys(m);d(r,n).forEach(function(s){this._oChangeIndicatorRegistry.removeChange(s);}.bind(this));d(n,r).forEach(function(s){var p=m[s];var q=this._getCommandForChange(p);this._oChangeIndicatorRegistry.registerChange(p,q);}.bind(this));}.bind(this));};k.prototype.selectChange=function(l){var s=l.getParameter("changeId");this._selectChange(s);};k.prototype._selectChange=function(s){var D=this._oChangeIndicatorRegistry.getChange(s).visualizationInfo.dependentElementIds;D.forEach(function(l){var m=O.getOverlay(l).getDomRef();m.scrollIntoViewIfNeeded();m.classList.add("sapUiRtaChangeIndicatorDependent");m.addEventListener("animationend",function(){m.classList.remove("sapUiRtaChangeIndicatorDependent");},{once:true});});};k.prototype._updateVisualizationModel=function(D){this._oChangeVisualizationModel.setData(Object.assign({},this._oChangeVisualizationModel.getData(),D));};k.prototype._updateChangeIndicators=function(){var s=this._oChangeIndicatorRegistry.getChangeIndicatorData();var I={};Object.keys(s).forEach(function(S){var l=s[S];var m=O.getOverlay(S);if(!m||!m.getDomRef()){return undefined;}var n=m.getDomRef().getClientRects()[0]||{left:0,top:0};I[S]={posX:parseInt(n.left),posY:parseInt(n.top),changes:this._filterRelevantChanges(l)};if(!this._oChangeIndicatorRegistry.hasChangeIndicator(S)){this._createChangeIndicator(m,S);}return undefined;}.bind(this));if(!a(I,this._oChangeVisualizationModel.getData().content)){this._updateVisualizationModel({content:I});}};k.prototype._filterRelevantChanges=function(l){if(!Array.isArray(l)){return l;}var r=this._oChangeVisualizationModel.getData();return l.filter(function(m){return(!m.dependent&&(r.commandCategory==='all'||r.commandCategory===m.commandCategory));});};k.prototype._createChangeIndicator=function(l,s){var m=new g({changes:"{changes}",posX:"{posX}",posY:"{posY}",visible:"{= ${/active} && (${changes} || []).length > 0}",overlayId:l.getId(),selectorId:s,selectChange:this.selectChange.bind(this),keyPress:this._onIndicatorKeyPress.bind(this)});m.setModel(this._oChangeVisualizationModel);m.bindElement("/content/"+s);m.setModel(this.getModel("i18n"),"i18n");m.placeAt(sap.ui.getCore().getStaticAreaRef());this._oChangeIndicatorRegistry.registerChangeIndicator(s,m);};k.prototype._onIndicatorKeyPress=function(l){var m=l.getParameter("originalEvent");var n=m.keyCode;var I=l.getSource();if(n===K.ARROW_UP||n===K.ARROW_LEFT||(n===K.TAB&&m.shiftKey)){m.stopPropagation();m.preventDefault();this._setFocusedIndicator(I,-1);}else if(n===K.ARROW_DOWN||n===K.ARROW_RIGHT||n===K.TAB){m.stopPropagation();m.preventDefault();this._setFocusedIndicator(I,1);}};k.prototype._setFocusedIndicator=function(s,D){var v=this._oChangeIndicatorRegistry.getChangeIndicators().filter(function(l){return l.getVisible();}).sort(function(l,m){var n=l.getPosY()-m.getPosY();var p=l.getPosX()-m.getPosX();return n||p;});if(v.length===0){return;}var I=s?(v.length+v.indexOf(s)+D)%v.length:0;v[I].focus();};function o(m){m.getMenu().close();}k.prototype.triggerModeChange=function(r,t){this.oMenuButton=t.getControl("toggleChangeVisualizationMenuButton");this.oRootOverlay=O.getOverlay(r);if(this.getIsActive()){this.setIsActive(false);if(this.oRootOverlay){this.oRootOverlay.getDomRef().removeEventListener("click",o.bind(null,this.oMenuButton),{capture:true});}return;}if(this.oRootOverlay){this.oRootOverlay.getDomRef().addEventListener("click",o.bind(null,this.oMenuButton),{capture:true});}if(!this.getRootControlId()){this.setRootControlId(r);}this.setIsActive(true);this._updateChangeRegistry().then(this._selectCommandCategory.bind(this,this._sSelectedCommandCategory)).then(function(){this._updateVisualizationModelMenuData();t.setModel(this._oChangeVisualizationModel,"visualizationModel");}.bind(this));};return k;});
