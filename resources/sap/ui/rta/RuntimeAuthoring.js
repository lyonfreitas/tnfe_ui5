/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/Standalone","sap/ui/rta/toolbar/Personalization","sap/ui/rta/toolbar/FioriLike","sap/ui/dt/DesignTime","sap/ui/dt/Overlay","sap/ui/rta/command/Stack","sap/ui/rta/command/LREPSerializer","sap/ui/rta/Utils","sap/ui/dt/Util","sap/ui/dt/ElementUtil","sap/ui/fl/library","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/m/MessageBox","sap/m/MessageToast","sap/ui/rta/util/PluginManager","sap/ui/rta/util/PopupManager","sap/ui/core/BusyIndicator","sap/ui/dt/DOMUtil","sap/ui/rta/appVariant/Feature","sap/ui/Device","sap/ui/rta/service/index","sap/ui/rta/util/ServiceEventBus","sap/ui/dt/OverlayRegistry","sap/base/strings/capitalize","sap/base/util/UriParameters","sap/ui/performance/Measurement","sap/base/Log","sap/ui/events/KeyCodes","sap/ui/model/json/JSONModel","sap/ui/rta/util/validateFlexEnabled","sap/ui/rta/util/changeVisualization/ChangeVisualization"],function(q,M,F,S,P,a,D,O,C,L,U,b,E,f,c,d,e,R,g,V,h,i,j,k,l,B,m,n,o,p,r,s,t,u,v,w,K,J,x,y){"use strict";var z="STARTING";var A="STARTED";var G="STOPPED";var H="FAILED";var I="SERVICE_STARTING";var N="SERVICE_STARTED";var Q="SERVICE_FAILED";var T=M.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.base.ManagedObject"}},properties:{customFieldUrl:"string",showCreateCustomField:"boolean",showToolbars:{type:"boolean",defaultValue:true},triggeredFromDialog:{type:"boolean",defaultValue:false},showWindowUnloadDialog:{type:"boolean",defaultValue:true},commandStack:{type:"any"},flexSettings:{type:"object",defaultValue:{layer:e.CUSTOMER,developerMode:true}},mode:{type:"string",defaultValue:"adaptation"},metadataScope:{type:"string",defaultValue:"default"}},events:{start:{parameters:{editablePluginsCount:{type:"int"}}},stop:{},failed:{},selectionChange:{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},modeChanged:{},undoRedoStackModified:{}}},_sAppTitle:null,_dependents:null,_sStatus:G,constructor:function(){M.apply(this,arguments);this._dependents={};this._mServices={};this._mCustomServicesDictinary={};this._mUShellServices={};this.addDependent(new k(),"pluginManager");this.addDependent(new l(),"popupManager");if(this.getShowToolbars()){this.getPopupManager().attachOpen(this.onPopupOpen,this);this.getPopupManager().attachClose(this.onPopupClose,this);this.addDependent(new y(),"changeVisualization");}if(window.parent!==window){this.startService("receiver");}if(this._shouldValidateFlexEnabled()){this.attachEvent("start",x.bind(null,this));}this._loadUShellServicesPromise=c.getUShellServices(["URLParsing","AppLifeCycle","CrossApplicationNavigation"]).then(function(Z){this._mUShellServices=Z;}.bind(this));},_RELOAD:{NOT_NEEDED:"NO_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION",RELOAD_PAGE:"HARD_RELOAD"}});T.prototype._shouldValidateFlexEnabled=function(){var Z=document.location.hostname;var $=Z.endsWith(".sap"+".corp")||Z==="localhost";if($){var a1=u.fromQuery(window.location.search).get("sap-ui-rta-skip-flex-validation");$=a1!=="true";}return $;};T.prototype.addDependent=function(Z,$,a1){a1=typeof a1==="undefined"?true:!!a1;if(!($ in this._dependents)){if($&&a1){this["get"+t($,0)]=this.getDependent.bind(this,$);}this._dependents[$||Z.getId()]=Z;}else{throw b.createError("RuntimeAuthoring#addDependent",b.printf("Can't add dependency with same key '{0}'",$),"sap.ui.rta");}};T.prototype.getDependent=function(Z){return this._dependents[Z];};T.prototype.getDependents=function(){return this._dependents;};T.prototype.removeDependent=function(Z){delete this._dependents[Z];};T.prototype.onPopupOpen=function(Z){var $=Z.getParameters().getSource();if($.isA("sap.m.Dialog")&&this.getToolbar().type==="fiori"){this.getToolbar().setColor("contrast");}this.getToolbar().bringToFront();};T.prototype.onPopupClose=function(Z){if(Z.getParameters().isA("sap.m.Dialog")){this.getToolbar().setColor();}};T.prototype.setPlugins=function(Z){if(this._sStatus!==G){throw new Error("Cannot replace plugins: runtime authoring already started");}this.getPluginManager().setPlugins(Z);};T.prototype.getPlugins=function(){return this.getPluginManager&&this.getPluginManager()&&this.getPluginManager().getPlugins();};T.prototype.getDefaultPlugins=function(){return this.getPluginManager().getDefaultPlugins(this.getFlexSettings());};T.prototype.setFlexSettings=function(Z){var $=u.fromQuery(window.location.search);var a1=$.get("sap-ui-layer");Z=q.extend({},this.getFlexSettings(),Z);if(a1){Z.layer=a1.toUpperCase();}if(Z.scenario||Z.baseId){var b1=c.buildLrepRootNamespace(Z.baseId,Z.scenario,Z.projectId);Z.rootNamespace=b1;Z.namespace=b1+"changes/";}U.setRtaStyleClassName(Z.layer);this.setProperty("flexSettings",Z);};T.prototype.getLayer=function(){return this.getFlexSettings().layer;};T.prototype.getRootControlInstance=function(){if(!this._oRootControl){this._oRootControl=E.getElementInstance(this.getRootControl());}return this._oRootControl;};T.prototype._getTextResources=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");};T.prototype._setVersionsModel=function(Z){this._oVersionsModel=Z;};T.prototype._initVersioning=function(){return V.initialize({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(this._setVersionsModel.bind(this));};function W(Z,$){if(Z.isA("sap.ui.core.UIComponent")){Z=Z.getRootControl();}if(Z){Z[$?"addStyleClass":"removeStyleClass"]("sapUiRtaRoot");}}T.prototype.start=function(){var Z;var $;if(this._sStatus===G){this._sStatus=z;var a1=this.getRootControlInstance();if(!a1){$=new Error("Root control not found");w.error($);return Promise.reject($);}return this._loadUShellServicesPromise.then(this._initVersioning.bind(this)).then(this._determineReload.bind(this)).then(function(b1){if(b1){return Promise.reject("Reload triggered");}this._oSerializer=new L({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});this.getPluginManager().preparePlugins(this.getFlexSettings(),this._handleElementModified.bind(this),this.getCommandStack());var c1=this.getPluginManager().getPluginList();Z=new Promise(function(d1,e1){v.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new D({scope:this.getMetadataScope(),plugins:c1});this._oDesignTime.addRootElement(this._oRootControl);q(O.getOverlayContainer()).addClass("sapUiRta");if(this.getLayer()===e.USER){q(O.getOverlayContainer()).addClass("sapUiRtaPersonalize");}else{q("body").addClass("sapUiRtaMode");}this._oDesignTime.getSelectionManager().attachChange(function(f1){this.fireSelectionChange({selection:f1.getParameter("selection")});},this);this._oDesignTime.attachEventOnce("synced",function(){d1();v.end("rta.dt.startup","Measurement of RTA: DesignTime start up");},this);this._oDesignTime.attachEventOnce("syncFailed",function(f1){e1(f1.getParameter("error"));});}.bind(this));this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);}.bind(this)).then(function(){if(this.getShowToolbars()){return this._getToolbarButtonsVisibility().then(this._createToolsMenu.bind(this));}}.bind(this)).then(this._onStackModified.bind(this)).then(function(){O.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidth",m.getScrollbarWidth()+"px");O.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidthPlusTwo",m.getScrollbarWidth()+2+"px");return Z;}).then(function(){this.getPopupManager().setRta(this);if(this.getShowToolbars()){return this.getToolbar().show();}}.bind(this)).then(function(){if(o.browser.name==="ff"){q(document).on("contextmenu",_);}}).then(function(){this.fnKeyDown=this._onKeyDown.bind(this);q(document).on("keydown",this.fnKeyDown);W(this.getRootControlInstance(),true);}.bind(this)).then(function(){this._sStatus=A;this.fireStart({editablePluginsCount:this.getPluginManager().getEditableOverlaysCount()});}.bind(this)).catch(function($){if($!=="Reload triggered"){this._sStatus=H;this.fireFailed($);}if($){this.destroy();return Promise.reject($);}}.bind(this));}};function _(){return false;}T.prototype._getToolbarButtonsVisibility=function(){return g.isPublishAvailable().then(function(Z){return n.isSaveAsAvailable(this.getRootControlInstance(),this.getLayer(),this._oSerializer).then(function($){return{publishAvailable:Z,saveAsAvailable:Z&&$};});}.bind(this));};T.prototype._isOldVersionDisplayed=function(){return V.isOldVersionDisplayed({selector:this.getRootControlInstance(),layer:this.getLayer()});};T.prototype._isDraftAvailable=function(){return V.isDraftAvailable({selector:this.getRootControlInstance(),layer:this.getLayer()});};var X=function(Z){B.hide();var $=Z.userMessage||Z.stack||Z.message||Z.status||Z;var a1=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");w.error("Failed to transfer changes",$);var b1=a1.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+a1.getText("MSG_ERROR_REASON",$);i.error(b1,{styleClass:U.getRtaStyleClassName()});};T.prototype.setCommandStack=function(Z){var $=this.getProperty("commandStack");if($){$.detachModified(this._onStackModified,this);}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack;}var a1=this.setProperty("commandStack",Z);if(Z){Z.attachModified(this._onStackModified,this);}if(this.getPluginManager&&this.getPluginManager()){this.getPluginManager().provideCommandStack("settings",Z);}return a1;};T.prototype.getCommandStack=function(){var Z=this.getProperty("commandStack");if(!Z){Z=new C();this._oInternalCommandStack=Z;this.setCommandStack(Z);}return Z;};T.prototype._onStackModified=function(){var Z=this._oVersionsModel.getProperty("/backendDraft");var $=this._oVersionsModel.getProperty("/displayedVersion")===sap.ui.fl.Versions.Draft;var a1=this.getCommandStack();var b1=a1.canUndo();if(!this.getShowToolbars()||!b1||this._bUserDiscardedDraft||$||!Z){return this._modifyStack();}return U.showMessageBox("warning","MSG_DRAFT_DISCARD_AND_CREATE_NEW_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_DIALOG",actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK}).then(function(c1){if(c1===i.Action.OK){this._discardDraftConfirmed();}else{this.undo();}}.bind(this));};T.prototype._discardDraftConfirmed=function(){this._bUserDiscardedDraft=true;this._modifyStack();};T.prototype._modifyStack=function(){if(this.getShowToolbars()){var Z=this.getCommandStack();var $=Z.canUndo();var a1=Z.canRedo();this._oVersionsModel.setDirtyChanges($);this._oToolbarControlsModel.setProperty("/undoEnabled",$);this._oToolbarControlsModel.setProperty("/redoEnabled",a1);this._oToolbarControlsModel.setProperty("/publishEnabled",this.bInitialPublishEnabled||$);this._oToolbarControlsModel.setProperty("/restoreEnabled",this.bInitialResetEnabled||$);}this.fireUndoRedoStackModified();return Promise.resolve();};T.prototype._checkToolbarAndExecuteFunction=function(Z,$){if(this.getShowToolbars()&&this.getToolbar&&this.getToolbar()){return this.getToolbar()[Z]($);}};T.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelectionManager().get();}return[];};T.prototype.stop=function(Z,$){this._checkToolbarAndExecuteFunction("setBusy",true);return this._handleReloadOnExit($).then(function(a1){return((Z)?Promise.resolve():this._serializeToLrep(this)).then(this._checkToolbarAndExecuteFunction.bind(this,"hide",Z)).then(function(){this.fireStop();if(a1.reloadMethod&&(a1.reloadMethod!==this._RELOAD.NOT_NEEDED)){a1.deleteMaxLayer=true;a1.onExit=true;a1.triggerHardReload=(a1.reloadMethod===this._RELOAD.RELOAD_PAGE);return this._handleUrlParameterOnExit(a1);}}.bind(this));}.bind(this)).catch(X).then(function(){this._checkToolbarAndExecuteFunction("setBusy",false);this._sStatus=G;q("body").removeClass("sapUiRtaMode");}.bind(this));};T.prototype.restore=function(){return this._onRestore();};T.prototype.transport=function(){return this._onTransport();};T.prototype.undo=function(){return this._onUndo();};T.prototype.redo=function(){return this._onRedo();};T.prototype.canUndo=function(){return this.getCommandStack().canUndo();};T.prototype.canRedo=function(){return this.getCommandStack().canRedo();};T.prototype._onKeyDown=function(Z){var $=o.os.macintosh;var a1=O.getOverlayContainer().get(0).contains(document.activeElement);var b1=this.getShowToolbars()&&this.getToolbar().getDomRef().contains(document.activeElement);var c1=false;q(".sapUiDtContextMenu").each(function(g1,h1){if(h1.contains(document.activeElement)){c1=true;}});var d1=document.body===document.activeElement;var e1=q(document.activeElement).parents(".sapUiRtaEditableField").length>0;if((a1||b1||c1||d1)&&!e1){var f1=$?Z.metaKey:Z.ctrlKey;if(Z.keyCode===K.Z&&Z.shiftKey===false&&Z.altKey===false&&f1===true){this._onUndo().then(Z.stopPropagation.bind(Z));}else if((($&&Z.keyCode===K.Z&&Z.shiftKey===true)||(!$&&Z.keyCode===K.Y&&Z.shiftKey===false))&&Z.altKey===false&&f1===true){this._onRedo().then(Z.stopPropagation.bind(Z));}}};T.prototype._onUnload=function(){var Z=this.getCommandStack();var $=Z.canUndo()||Z.canRedo();if($&&this.getShowWindowUnloadDialog()){return this._getTextResources().getText("MSG_UNSAVED_CHANGES");}window.onbeforeunload=this._oldUnloadHandler;};T.prototype._serializeAndSave=function(){return this._oSerializer.saveCommands(this._oVersionsModel.getProperty("/versioningEnabled"));};T.prototype._serializeToLrep=function(){if(!this._bReloadNeeded){return this._oSerializer.needsReload().then(function(Z){this._bReloadNeeded=Z;return this._serializeAndSave();}.bind(this));}return this._serializeAndSave();};T.prototype._onUndo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().undo();};T.prototype._onRedo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().redo();};T.prototype._onActivate=function(Z){var $=Z.getParameter("versionTitle");if(this._isOldVersionDisplayed()&&this._isDraftAvailable()){return U.showMessageBox("warning","MSG_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK}).then(function(a1){if(a1===i.Action.OK){this._activate($);}}.bind(this));}return this._activate($);};T.prototype._activate=function(Z){var $=this.getLayer();var a1=this.getRootControlInstance();return V.activate({layer:$,selector:a1,title:Z}).then(function(){this._showMessageToast("MSG_DRAFT_ACTIVATION_SUCCESS");this.bInitialResetEnabled=true;this._oToolbarControlsModel.setProperty("/restoreEnabled",true);this.getCommandStack().removeAllCommands();}.bind(this)).catch(function(b1){U.showMessageBox("error","MSG_DRAFT_ACTIVATION_FAILED",{error:b1});});};T.prototype._handleDiscard=function(){var Z=this.getLayer();var $={isDraftAvailable:false,layer:Z};T.enableRestart(Z,this.getRootControlInstance());if(!c.getUshellContainer()){this.getCommandStack().removeAllCommands();return this._triggerHardReload($);}var a1=true;this.getCommandStack().removeAllCommands();var b1=this._removeVersionParameterForFLP($,c.getParsedURLHash(this._getUShellService("URLParsing")),a1);this._triggerCrossAppNavigation(b1);return this.stop(true,true);};T.prototype._onDiscardDraft=function(){return U.showMessageBox("warning","MSG_DRAFT_DISCARD_DIALOG",{actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK}).then(function(Z){if(Z===i.Action.OK){return V.discardDraft({layer:this.getLayer(),selector:this.getRootControlInstance(),updateState:true}).then(this._handleDiscard.bind(this));}return undefined;}.bind(this));};T.prototype._onSwitchVersion=function(Z){var $=Z.getParameter("version");var a1=this._oVersionsModel.getProperty("/displayedVersion");if($===a1){return;}if(this.canUndo()){this._nSwitchToVersion=$;U.showMessageBox("warning","MSG_SWITCH_VERSION_DIALOG",{titleKey:"TIT_SWITCH_VERSION_DIALOG",actions:[i.Action.YES,i.Action.NO,i.Action.CANCEL],emphasizedAction:i.Action.YES}).then(function(b1){if(b1===i.Action.YES){this._serializeToLrep(this).then(this._switchVersion.bind(this,this._nSwitchToVersion));}else if(b1===i.Action.NO){this.getCommandStack().removeAllCommands(true);this._switchVersion(this._nSwitchToVersion);}return undefined;}.bind(this));return;}this._switchVersion($);};T.prototype._switchVersion=function(Z){var $=Z.toString();T.enableRestart(this.getLayer(),this.getRootControlInstance());if(!c.getUshellContainer()){if(!R.hasVersionParameterWithValue({value:$},this._getUShellService("URLParsing"))){var a1={versionSwitch:true,version:$};return this._triggerHardReload(a1);}return this._reloadPage();}var b1=c.getParsedURLHash(this._getUShellService("URLParsing"));V.loadVersionForApplication({selector:this.getRootControlInstance(),layer:this.getLayer(),version:Z});var c1=b1.params[sap.ui.fl.Versions.UrlParameter];if(c1&&c1[0]===$&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}else{b1.params[sap.ui.fl.Versions.UrlParameter]=$;this._triggerCrossAppNavigation(b1);}return undefined;};T.prototype._setUriParameter=function(Z){document.location.search=Z;};T.prototype._createToolsMenu=function(Z){if(!this.getDependent("toolbar")){var $=this.getLayer()===e.USER;var a1={rtaInformation:{flexSettings:this.getFlexSettings(),rootControl:this.getRootControlInstance(),commandStack:this.getCommandStack()},textResources:this._getTextResources(),restore:this._onRestore.bind(this),exit:this.stop.bind(this,false,$)};if(!$){a1.transport=this._onTransport.bind(this);a1.undo=this._onUndo.bind(this);a1.redo=this._onRedo.bind(this);a1.modeChange=this._onModeChange.bind(this);a1.activate=this._onActivate.bind(this);a1.discardDraft=this._onDiscardDraft.bind(this);a1.switchVersion=this._onSwitchVersion.bind(this);a1.onCommandCategorySelection=this.getChangeVisualization?this.getChangeVisualization().onCommandCategorySelection.bind(this.getChangeVisualization()):function(){};}var b1;if($){b1=new P(a1);}else if(U.isOriginalFioriToolbarAccessible()){b1=new F(a1);}else if(U.getFiori2Renderer()){b1=new a(a1);}else{b1=new S(a1);}this.addDependent(b1,"toolbar");return b1.onFragmentLoaded().then(function(){var c1=Z.saveAsAvailable;var d1=c1&&n.isOverviewExtended();this._oToolbarControlsModel=new J({undoEnabled:false,redoEnabled:false,translationVisible:false,translationEnabled:false,publishVisible:Z.publishAvailable,publishEnabled:this.bInitialPublishEnabled,restoreEnabled:this.bInitialResetEnabled,appVariantsOverviewVisible:c1&&d1,appVariantsOverviewEnabled:c1&&d1,saveAsVisible:c1,saveAsEnabled:false,manageAppsVisible:c1&&!d1,manageAppsEnabled:c1&&!d1,modeSwitcher:this.getMode()});if(c1){n.isManifestSupported().then(function(e1){this._oToolbarControlsModel.setProperty("/saveAsEnabled",e1);this._oToolbarControlsModel.setProperty("/appVariantsOverviewEnabled",e1);this._oToolbarControlsModel.setProperty("/manageAppsEnabled",e1);}.bind(this));}this.getToolbar().setModel(this._oVersionsModel,"versions");this.getToolbar().setModel(this._oToolbarControlsModel,"controls");}.bind(this));}return Promise.resolve();};T.prototype.destroy=function(){q.map(this._dependents,function(Z,$){this.removeDependent($);Z.destroy(true);}.bind(this));Object.keys(this._mServices).forEach(function(Z){this.stopService(Z);},this);if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;q(document).off("keydown",this.fnKeyDown);}if(this.getRootControlInstance()){W(this.getRootControlInstance(),false);}this.setCommandStack(null);if(this._oServiceEventBus){this._oServiceEventBus.destroy();}if(o.browser.name==="ff"){q(document).off("contextmenu",_);}window.onbeforeunload=this._oldUnloadHandler;M.prototype.destroy.apply(this,arguments);};T.prototype._onTransport=function(){this.getPluginManager().handleStopCutPaste();B.show(500);return this._serializeToLrep().then(function(){B.hide();var Z=c.isApplicationVariant(this._oRootControl)&&!c.isVariantByStartupParameter(this._oRootControl);return((Z)?n.getAppVariantDescriptor(this._oRootControl):Promise.resolve()).then(function($){var a1=[];if($){a1.push($);}return h.publish({selector:this.getRootControlInstance(),styleClass:U.getRtaStyleClassName(),layer:this.getLayer(),appVariantDescriptors:a1}).then(function(b1){if(b1!=="Error"&&b1!=="Cancel"){j.show(b1);if(this.getShowToolbars()){h.getResetAndPublishInfo({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(function(c1){this._oToolbarControlsModel.setProperty("/publishEnabled",c1.isPublishEnabled);this._oToolbarControlsModel.setProperty("/restoreEnabled",c1.isResetEnabled);}.bind(this));}}}.bind(this));}.bind(this));}.bind(this))["catch"](X);};T.prototype._deleteChanges=function(){var Z=this.getLayer();var $=c.getAppComponentForControl(this.getRootControlInstance());return h.reset({selector:$,layer:Z}).then(function(){R.removeInfoSessionStorage($);var a1={isDraftAvailable:R.hasVersionParameterWithValue({value:Z},this._getUShellService("URLParsing")),layer:Z,deleteMaxLayer:false,triggerHardReload:true};return this._handleUrlParameterOnExit(a1);}.bind(this)).catch(function(a1){if(a1!=="cancel"){U.showMessageBox("error","MSG_RESTORE_FAILED",{error:a1});}});};T.prototype._reloadPage=function(){window.location.reload();};T.prototype._showMessageToast=function(Z){var $=this._getTextResources().getText(Z);j.show($);};T.needsRestart=function(Z){return!!window.sessionStorage.getItem("sap.ui.rta.restart."+Z);};T.enableRestart=function(Z,$){var a1=c.getComponentClassName($);var b1=a1||true;window.sessionStorage.setItem("sap.ui.rta.restart."+Z,b1);};T.disableRestart=function(Z){window.sessionStorage.removeItem("sap.ui.rta.restart."+Z);};T.prototype._onRestore=function(){var Z=this.getLayer();var $=Z===e.USER?"FORM_PERS_RESET_MESSAGE_PERSONALIZATION":"FORM_PERS_RESET_MESSAGE";var a1=Z===e.USER?"BTN_RESTORE":"FORM_PERS_RESET_TITLE";this.getPluginManager().handleStopCutPaste();return U.showMessageBox("warning",$,{titleKey:a1,actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK}).then(function(b1){if(b1===i.Action.OK){T.enableRestart(Z,this.getRootControlInstance());return this._deleteChanges().then(function(){this.getCommandStack().removeAllCommands();}.bind(this));}return undefined;}.bind(this));};T.prototype._scheduleOnCreated=function(Z,$){function a1(b1){var c1=b1.getParameter("elementOverlay");if(c1.getElement().getId()===Z){this._oDesignTime.detachEvent("elementOverlayCreated",a1,this);$(c1);}}this._oDesignTime.attachEvent("elementOverlayCreated",a1,this);};T.prototype._scheduleOnCreatedAndVisible=function(Z,$){function a1(c1){var d1=c1.getSource();if(d1.getGeometry()&&d1.getGeometry().visible){d1.detachEvent("geometryChanged",a1);$(d1);}}function b1(c1){if(!c1.getGeometry()||!c1.getGeometry().visible){c1.attachEvent("geometryChanged",a1);}else{$(c1);}}this._scheduleOnCreated(Z,function(c1){if(c1.isRendered()){b1(c1);}else{c1.attachEventOnce("afterRendering",function(d1){b1(d1.getSource());});}});};T.prototype._scheduleRenameOnCreatedContainer=function(Z,$){var a1=function(b1){b1.setSelected(true);this.getPluginManager().getPlugin("rename").startEdit(b1);}.bind(this);this._scheduleOnCreatedAndVisible($,function(b1){var c1=this.getPluginManager().getPlugin("createContainer").getCreatedContainerId(Z,b1.getElement().getId());var d1=s.getOverlay(c1);if(d1){a1(d1);}else{this._scheduleOnCreatedAndVisible(c1,a1);}}.bind(this));};T.prototype._handleElementModified=function(Z){this.getPluginManager().handleStopCutPaste();var $=Z.getParameter("action");var a1=Z.getParameter("newControlId");var b1=Z.getParameter("command");if(b1 instanceof sap.ui.rta.command.BaseCommand){if(a1){this._scheduleOnCreated(a1,function(c1){var d1=c1.getDesignTimeMetadata();var e1=d1.getData().select;if(typeof e1==="function"){e1(c1.getElement());}});if($){this._scheduleRenameOnCreatedContainer($,a1);}}return this.getCommandStack().pushAndExecute(b1).catch(function(c1){if(c1&&c1.message&&c1.message.indexOf("The following Change cannot be applied because of a dependency")>-1){U.showMessageBox("error","MSG_DEPENDENCY_ERROR",{error:c1});}w.error("sap.ui.rta: "+c1.message);});}return Promise.resolve();};T.prototype._buildNavigationArguments=function(Z){return{target:{semanticObject:Z.semanticObject,action:Z.action,context:Z.contextRaw},params:Z.params,appSpecificRoute:Z.appSpecificRoute,writeHistory:false};};T.prototype._triggerCrossAppNavigation=function(Z){if((this.getLayer()!==e.USER)&&this._getUShellService("CrossApplicationNavigation")){this._getUShellService("CrossApplicationNavigation").toExternal(this._buildNavigationArguments(Z));return true;}return false;};T.prototype._removeVersionParameterForFLP=function(Z,$,a1){var b1=this.getLayer();if(b1===e.USER){return $;}var c1=c.getParameter(f.Versions.UrlParameter,this._getUShellService("URLParsing"));if(c1){delete $.params[f.Versions.UrlParameter];}else if((this._isDraftAvailable()||a1)&&!Z.hasHigherLayerChanges&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}return $;};T.prototype._removeMaxLayerParameterForFLP=function(Z,$){if(Z.deleteMaxLayer&&Z.hasHigherLayerChanges){delete $.params[d.FL_MAX_LAYER_PARAM];}return $;};T.prototype._handleUrlParameterOnExit=function(Z){if(!c.getUshellContainer()){return this._triggerHardReload(Z);}var $=c.getParsedURLHash(this._getUShellService("URLParsing"));if(!$){return undefined;}if(Z.allContexts&&!Z.hasHigherLayerChanges&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}$=this._removeMaxLayerParameterForFLP(Z,$);$=this._removeVersionParameterForFLP(Z,$,false);this._triggerCrossAppNavigation($);if(Z.triggerHardReload){this._reloadPage();}};T.prototype._getReloadMessageOnStart=function(Z){var $;var a1=Z.layer===e.CUSTOMER;if(Z.hasHigherLayerChanges&&Z.isDraftAvailable){$=a1?"MSG_VIEWS_OR_PERSONALIZATION_AND_DRAFT_EXISTS":"MSG_HIGHER_LAYER_CHANGES_AND_DRAFT_EXISTS";}else if(Z.hasHigherLayerChanges&&Z.allContexts){$="MSG_RESTRICTED_CONTEXT_EXIST_AND_PERSONALIZATION";}else if(Z.hasHigherLayerChanges){$=a1?"MSG_PERSONALIZATION_OR_PUBLIC_VIEWS_EXISTS":"MSG_HIGHER_LAYER_CHANGES_EXIST";}else if(Z.isDraftAvailable){$="MSG_DRAFT_EXISTS";}else if(Z.allContexts){$="MSG_RESTRICTED_CONTEXT_EXIST";}return $;};T.prototype._getReloadMessageOnExit=function(Z){var $=Z.layer===e.CUSTOMER;if(Z.hasHigherLayerChanges){if(!$){return"MSG_RELOAD_WITH_ALL_CHANGES";}if(Z.isDraftAvailable){return"MSG_RELOAD_WITH_VIEWS_PERSONALIZATION_AND_WITHOUT_DRAFT";}if(Z.allContexts){return"MSG_RELOAD_WITH_PERSONALIZATION_AND_RESTRICTED_CONTEXT";}return"MSG_RELOAD_WITH_PERSONALIZATION_AND_VIEWS";}if(Z.initialDraftGotActivated){return"MSG_RELOAD_ACTIVATED_DRAFT";}if(Z.isDraftAvailable){return"MSG_RELOAD_WITHOUT_DRAFT";}if(Z.changesNeedReload){return"MSG_RELOAD_NEEDED";}if(Z.allContexts){return"MSG_RELOAD_WITHOUT_ALL_CONTEXT";}};T.prototype._handleReloadMessageBoxOnExit=function(Z){var $=this._getReloadMessageOnExit(Z);if($){return U.showMessageBox("information",$,{titleKey:"HEADER_RELOAD_NEEDED"});}return Promise.resolve();};T.prototype._triggerReloadOnStart=function(Z){if(this._getUShellService("CrossApplicationNavigation")){if(Z.isDraftAvailable){V.loadDraftForApplication({selector:Z.selector,layer:Z.layer});}else{V.loadVersionForApplication({selector:Z.selector,layer:Z.layer,allContexts:Z.allContexts});}}var $=this._getReloadMessageOnStart(Z);if(!$){return Promise.resolve();}return U.showMessageBox("information",$).then(function(){T.enableRestart(Z.layer,this.getRootControlInstance());if(Z.allContexts&&!Z.hasHigherLayerChanges&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}if(c.getUshellContainer()){var a1=R.handleParametersOnStart(Z);return this._triggerCrossAppNavigation(a1);}return this._triggerHardReload(Z);}.bind(this));};T.prototype._determineReload=function(){var Z={hasHigherLayerChanges:false,isDraftAvailable:false,layer:this.getLayer(),selector:this.getRootControlInstance(),ignoreMaxLayerParameter:false,includeCtrlVariants:true,URLParsingService:this._getUShellService("URLParsing")};return R.getReloadReasonsForStart(Z).then(function(Z){var $=h.getResetAndPublishInfoFromSession(Z.selector);this.bInitialResetEnabled=!!$.isResetEnabled;this.bInitialPublishEnabled=!!$.isPublishEnabled;if(Z.hasHigherLayerChanges||Z.isDraftAvailable||Z.allContexts){return this._triggerReloadOnStart(Z);}return undefined;}.bind(this));};T.prototype._triggerHardReload=function(Z){Z.parameters=document.location.search;Z.URLParsingService=this._getUShellService("URLParsing");var $=R.handleUrlParametersForStandalone(Z);if(document.location.search!==$){this._setUriParameter($);return Promise.resolve();}return this._reloadPage();};T.prototype._handleReloadOnExit=function(Z){if(Z){return Promise.resolve({reloadMethod:this._RELOAD.NOT_NEEDED});}var $=this._bReloadNeeded?Promise.resolve(this._bReloadNeeded):this._oSerializer.needsReload();return $.then(function(a1){var b1={layer:this.getLayer(),selector:this.getRootControlInstance(),changesNeedReload:a1,isDraftAvailable:this._oVersionsModel.getProperty("/draftAvailable"),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),activeVersion:this._oVersionsModel.getProperty("/activeVersion"),URLParsingService:this._getUShellService("URLParsing")};b1=R.getReloadMethod(b1);return this._handleReloadMessageBoxOnExit(b1).then(function(){return b1;});}.bind(this));};T.prototype._onModeChange=function(Z){this.setMode(Z.getParameter("item").getKey());};T.prototype.setMode=function(Z){var $=this.getMode();if($!==Z){var a1=this.getChangeVisualization&&this.getChangeVisualization();if(Z==="visualization"||$==="visualization"){a1.triggerModeChange(this.getRootControl(),this.getToolbar());}var b1=this.getPluginManager().getPlugin("tabHandling");var c1=this.getPluginManager().getPlugin("selection");if($==="navigation"||Z==="navigation"){this._oDesignTime.setEnabled(Z!=="navigation");b1[(Z==="navigation")?"restoreTabIndex":"removeTabIndex"]();}b1[(Z==="adaptation")?"restoreOverlayTabIndex":"removeOverlayTabIndex"]();c1.setIsActive(!(Z==="visualization"));O.getOverlayContainer().toggleClass("sapUiRtaVisualizationMode",(Z==="visualization"));if(Z==="visualization"){q(".sapUiDtOverlayMovable").css("cursor","default");}else{q(".sapUiDtOverlayMovable").css("cursor","move");}this._oToolbarControlsModel.setProperty("/modeSwitcher",Z);this.setProperty("mode",Z);this.fireModeChanged({mode:Z});}};T.prototype.setMetadataScope=function(Z){if(this._sStatus!==G){w.error("sap.ui.rta: Failed to set metadata scope on RTA instance after RTA is started");return;}this.setProperty("metadataScope",Z);};function Y(Z){if(p.hasOwnProperty(Z)){return p[Z].replace(/\./g,"/");}}T.prototype.startService=function(Z){if(this._sStatus!==A){return new Promise(function(b1,c1){this.attachEventOnce("start",b1);this.attachEventOnce("failed",c1);}.bind(this)).then(function(){return this.startService(Z);}.bind(this),function(){return Promise.reject(b.createError("RuntimeAuthoring#startService",b.printf("Can't start the service '{0}' while RTA has been failed during a startup",Z),"sap.ui.rta"));});}var $=Y(Z);var a1;if(!$){return Promise.reject(b.createError("RuntimeAuthoring#startService",b.printf("Unknown service. Can't find any registered service by name '{0}'",Z),"sap.ui.rta"));}a1=this._mServices[Z];if(a1){switch(a1.status){case N:{return Promise.resolve(a1.exports);}case I:{return a1.initPromise;}case Q:{return a1.initPromise;}default:{return Promise.reject(b.createError("RuntimeAuthoring#startService",b.printf("Unknown service status. Service name = '{0}'",Z),"sap.ui.rta"));}}}else{this._mServices[Z]=a1={status:I,location:$,initPromise:new Promise(function(b1,c1){sap.ui.require([$],function(d1){a1.factory=d1;if(!this._oServiceEventBus){this._oServiceEventBus=new r();}b.wrapIntoPromise(d1)(this,this._oServiceEventBus.publish.bind(this._oServiceEventBus,Z)).then(function(e1){if(this.bIsDestroyed){throw b.createError("RuntimeAuthoring#startService",b.printf("RuntimeAuthoring instance is destroyed while initialising the service '{0}'",Z),"sap.ui.rta");}if(!q.isPlainObject(e1)){throw b.createError("RuntimeAuthoring#startService",b.printf("Invalid service format. Service should return simple javascript object after initialisation. Service name = '{0}'",Z),"sap.ui.rta");}a1.service=e1;a1.exports={};if(Array.isArray(e1.events)&&e1.events.length>0){q.extend(a1.exports,{attachEvent:this._oServiceEventBus.subscribe.bind(this._oServiceEventBus,Z),detachEvent:this._oServiceEventBus.unsubscribe.bind(this._oServiceEventBus,Z),attachEventOnce:this._oServiceEventBus.subscribeOnce.bind(this._oServiceEventBus,Z)});}var f1=e1.exports||{};q.extend(a1.exports,Object.keys(f1).reduce(function(g1,h1){var i1=f1[h1];g1[h1]=typeof i1==="function"?b.waitForSynced(this._oDesignTime,i1):i1;return g1;}.bind(this),{}));a1.status=N;b1(Object.freeze(a1.exports));}.bind(this)).catch(c1);}.bind(this),function(d1){a1.status=Q;c1(b.propagateError(d1,"RuntimeAuthoring#startService",b.printf("Can't load service '{0}' by its name: {1}",Z,$),"sap.ui.rta"));});}.bind(this)).catch(function(b1){a1.status=Q;return Promise.reject(b.propagateError(b1,"RuntimeAuthoring#startService",b.printf("Error during service '{0}' initialisation.",Z),"sap.ui.rta"));})};return a1.initPromise;}};T.prototype.stopService=function(Z){var $=this._mServices[Z];if($){if($.status===N){if(typeof $.service.destroy==="function"){$.service.destroy();}}delete this._mServices[Z];}else{throw b.createError("RuntimeAuthoring#stopService",b.printf("Can't destroy service: unable to find service with name '{0}'",Z),"sap.ui.rta");}};T.prototype.getService=function(Z){return this.startService(Z);};T.prototype._getUShellService=function(Z){return c.getUshellContainer()&&this._mUShellServices[Z];};return T;});
