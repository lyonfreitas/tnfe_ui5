/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/core/InvisibleText','sap/ui/core/Element','sap/ui/core/Control','sap/ui/core/ListItem','sap/ui/core/library',"sap/ui/core/Renderer",'sap/ui/core/message/MessageMixin','sap/m/DynamicDateFormat','sap/m/DynamicDateUtil','sap/ui/core/IconPool',"sap/ui/core/LabelEnablement",'sap/ui/core/format/DateFormat','sap/ui/base/ManagedObjectObserver','sap/ui/Device','./Label','./GroupHeaderListItem','./StandardListItem','./StandardListItemRenderer','./Button','./List','./Input','./InputRenderer','./Toolbar','./ResponsivePopover','./Page','./NavContainer','./DynamicDateRangeRenderer','./StandardDynamicDateOption','sap/ui/dom/jquery/Focusable','./library'],function(I,E,C,L,c,R,M,D,d,e,f,g,h,i,j,G,S,k,B,l,m,n,T,p,P,N,q,r,F,s){"use strict";var V=c.ValueState,t=s.ToolbarDesign,u=s.ToolbarStyle,v=s.ListType,w=s.ListMode,x=s.ListSeparators,y=sap.ui.getCore().getLibraryResourceBundle("sap.m");var z=C.extend("sap.m.DynamicDateRange",{metadata:{library:"sap.m",properties:{value:{type:"object"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},enabled:{type:"boolean",group:"Behavior",defaultValue:true},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:V.None},name:{type:"string",group:"Misc",defaultValue:null},placeholder:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Behavior",defaultValue:true},valueStateText:{type:"string",group:"Misc",defaultValue:null},required:{type:"boolean",group:"Misc",defaultValue:false},enableGroupHeaders:{type:"boolean",group:"Behavior",defaultValue:true},formatter:{type:"object"},options:{type:"string[]",group:"Behavior",defaultValue:[]}},aggregations:{_input:{type:"sap.m.Input",multiple:false,visibility:"hidden"},_popup:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"}},events:{change:{parameters:{value:{type:"object"},valid:{type:"boolean"}}}}},renderer:q});M.call(z.prototype);z.prototype.init=function(){this._oInput=new H(this.getId()+"-input",{showValueHelp:true,valueHelpIconSrc:e.getIconURI("sap-icon://check-availability"),valueHelpRequest:this._toggleOpen.bind(this),showSuggestion:true,suggest:this._handleSuggest.bind(this)});this._oListItemDelegate=undefined;this._onBeforeInputRenderingDelegate={onBeforeRendering:function(){this._oInput._getValueHelpIcon().setVisible(true);}};this._oInput._getValueHelpIcon().setTooltip(y.getText("INPUT_VALUEHELP_BUTTON"));this._oInput.addDelegate(this._onBeforeInputRenderingDelegate,this);this.setAggregation("_input",this._oInput,false);this._oInput._setControlOrigin(this);this._oInput.attachChange(this._handleInputChange,this);this.oValueObserver=new h(function(){delete this.oBoundValueFormatter;}.bind(this));this.oValueObserver.observe(this,{bindings:["value"]});};z.prototype.exit=function(){this._oInput.removeDelegate(this._onBeforeInputRenderingDelegate);this._onBeforeInputRenderingDelegate=undefined;this.oValueObserver.destroy();this._infoDatesFooter=undefined;this.aInputControls=undefined;this._removeAllListItemDelegates();};z.prototype._removeAllListItemDelegates=function(){if(this._oOptionsList){this._oOptionsList.getItems().forEach(function(o){o.removeDelegate(this._oListItemDelegate);},this);}};z.prototype.onBeforeRendering=function(){this._updateInputValue(this.getValue());this._oInput.setEditable(this.getEditable());this._oInput.setEnabled(this.getEnabled());this._oInput.setRequired(this.getRequired());this._oInput.setName(this.getName());this._oInput.setWidth(this.getWidth());this._oInput.setPlaceholder(this.getPlaceholder());this._oInput.setValueState(this.getValueState());this._oInput.setValueStateText(this.getValueStateText());};z.prototype.setValue=function(o){o=this._substitudeValue(o);this.setProperty("value",o);this._updateInputValue(o);return this;};z.prototype._toggleOpen=function(){if(this._oPopup&&this._oPopup.isOpen()){this._closePopup();}else{this.open();}};z.prototype.open=function(){if(this.getEditable()&&this.getEnabled()){this._createPopup();this._createPopupContent();if(!this._oListItemDelegate){this._oListItemDelegate={onsapshow:this._closePopup.bind(this),onsaphide:this._closePopup.bind(this)};}this._removeAllListItemDelegates();this._oOptionsList.destroyAggregation("items");this._createValueHelpItems().forEach(function(o){o.addDelegate(this._oListItemDelegate,this);this._oOptionsList.addItem(o);},this);this._oNavContainer.to(this._oNavContainer.getPages()[0]);this._openPopup();}};z.prototype.addOption=function(K){var o=this.getOptions();if(o.indexOf(K)===-1){o.push(K);}this.setOptions(o);};z.prototype.getFocusDomRef=function(){return this.getAggregation("_input")&&this.getAggregation("_input").getFocusDomRef();};z.prototype._updateInputValue=function(o){var a;if(o&&o.operator!=="PARSEERROR"){a=this._enhanceInputValue(this._formatValue(o),o);this._oInput.setValue(a);}};z.prototype._handleSuggest=function(o){if(this._oPopup&&this._oPopup.isOpen()){this._closePopup();}var Q=o.getParameter("suggestValue");this._oInput.removeAllSuggestionItems();var a=this._getOptions().filter(function(K){var O={operator:K.getKey(),values:[]},U=K.getValueHelpUITypes(this);if(U.length&&U[0].getType()){return false;}var W=d.getOption(O.operator).format(O,this._getFormatter()).toLowerCase();var X=W.indexOf(Q.toLowerCase());return X===0||(X>0&&W[X-1]===" ");},this);a.forEach(function(K){var O={operator:K.getKey(),values:[]};this._addSuggestionItem(O);},this);var b=Q.match(/\d+/);if(!b){return;}a=this._getOptions().filter(function(K){return K.getValueHelpUITypes(this).length===1&&K.getValueHelpUITypes(this)[0].getType()==="int";},this);a.forEach(function(K){var O={operator:K.getKey(),values:[parseInt(b[0])]};this._addSuggestionItem(O);},this);};z.prototype._getOptions=function(){var O=this.getOptions();var a=O.map(function(K){return d.getOption(K);},this);return a.filter(function(o){return!!o;});};z.prototype._getDatesLabelFormatter=function(){if(!this._oDatesLabelFormatter){var o=Object.create(this._getFormatter()._dateFormatter.oFormatOptions);o.interval=true;this._oDatesLabelFormatter=g.getInstance(o);}return this._oDatesLabelFormatter;};z.prototype._destroyInputControls=function(){if(!this.aInputControls){return;}this.aInputControls.forEach(function(o){o.destroy();});this.aInputControls=undefined;};z.prototype._addSuggestionItem=function(o){var a=d.toDates(o);var b=new L({text:d.getOption(o.operator).format(o,this._getFormatter()),additionalText:this._getDatesLabelFormatter().format(a)});this._oInput.addSuggestionItem(b);};z.prototype._handleInputChange=function(o){var a=o.getParameter("value");var b=this._parseValue(this._stripValue(a));var K=this.getValue();var O=a.trim()===""||!!b;if(!O){this.setValue({operator:"PARSEERROR",values:[y.getText("DDR_WRONG_VALUE"),a]});}else{this.setValue(b);}this.fireChange({value:this.getValue(),prevValue:K,valid:O});};z.prototype._enhanceInputValue=function(a,o){if(d.getOption(o.operator).enhanceFormattedValue()||(o.operator==="LASTDAYS"&&o.values[0]<=1)||(o.operator==="NEXTDAYS"&&o.values[0]<=1)){return a+" ("+this._toDatesString(o)+")";}return a;};z.prototype._stripValue=function(a){var o=a.indexOf("(");var b=a.lastIndexOf(")");var K=a;if(o!==-1&&b!==-1&&o<b){K=a.slice(0,o)+a.slice(b+1);K=K.trim();}return K;};z.prototype._toDatesString=function(o){return this._getDatesLabelFormatter().format(d.toDates(o));};z.prototype._createPopup=function(){if(!this._oPopup){this._oPopup=new p(this.getId()+"-RP",{contentHeight:'470px',contentWidth:_(this.getDomRef())?'272px':'320px',showCloseButton:false,showArrow:false,showHeader:false,placement:s.PlacementType.VerticalPreferedBottom,ariaLabelledBy:[I.getStaticId("sap.m","INPUT_AVALIABLE_VALUES")]});this._oPopup.addStyleClass("sapMDDRPopover");if(i.system.phone){this._oPopup.addStyleClass("sapUiNoContentPadding");}else{this._oPopup._oControl._getSingleNavContent=function(){return null;};}this._oPopup.attachAfterOpen(function(){var o=this._oNavContainer.getPages()[0];this._applyNavContainerPageFocus(o);this.invalidate();},this);this._oPopup.attachAfterClose(function(){this._setFooterVisibility(false);this.invalidate();},this);this._oPopup.setBeginButton(new B({type:s.ButtonType.Emphasized,text:y.getText("DYNAMIC_DATE_RANGE_CONFIRM"),press:this._applyValue.bind(this)}));this._oPopup.setEndButton(new B({text:y.getText("DYNAMIC_DATE_RANGE_CANCEL"),press:this._closePopup.bind(this)}));this._setFooterVisibility(false);this._oPopup._getPopup().setAutoClose(true);this.setAggregation("_popup",this._oPopup,true);}};z.prototype._createValueHelpItems=function(){var o;var K;var O=[];var Q=this._getOptions();Q.sort(function(a,b){var U=a.getGroup()-b.getGroup();if(U){return U;}return s.StandardDynamicDateRangeKeys.indexOf(a.getKey())-s.StandardDynamicDateRangeKeys.indexOf(b.getKey());});Q=Q.reduce(function(a,b){if(r.LastXKeys.indexOf(b.getKey())!==-1){if(o){return a;}o=true;}if(r.NextXKeys.indexOf(b.getKey())!==-1){if(K){return a;}K=true;}a.push(b);return a;},[]);if(this.getEnableGroupHeaders()){Q=Q.reduce(function(a,b){var U=b.getGroupHeader();if(O.indexOf(U)===-1){O.push(U);a.push(U);}a.push(b);return a;},[]);}return Q.map(function(a){if(typeof(a)==="string"){return this._createHeaderListItem(a);}return this._createListItem(a);},this);};z.prototype._createListItem=function(o){var b=this._isFixedOption(o);return new J({type:b?v.Active:v.Navigation,title:o.getText(this),wrapping:true,optionKey:o.getKey(),press:this._handleOptionPress.bind(this)});};z.prototype._createHeaderListItem=function(a){var o=new G();o.setTitle(a);o._bGroupHeader=true;return o;};z.prototype._handleOptionPress=function(o){var O=o.getSource().getOptionKey(),a=d.getOption(O);this._oSelectedOption=a;if(this._isFixedOption(a)){this._applyValue();}else{var b=this._createInfoDatesFooter();this._destroyInputControls();this.aInputControls=a.createValueHelpUI(this,this._updateInternalControls.bind(this));var K=this._oNavContainer.getPages()[1];K.removeAllContent();this.aInputControls.forEach(function(Q){K.addContent(Q);});K.setFooter(b);K.setTitle(a.getText(this));this._setFooterVisibility(true);this._updateInternalControls(a);this._oNavContainer.to(K);}};z.prototype._isFixedOption=function(o){return!o.getValueHelpUITypes(this).length;};z.prototype._createInfoDatesFooter=function(){this._infoDatesFooter=new T({design:t.Info,style:u.Clear,content:[new j({text:y.getText("DDR_INFO_DATES_EMPTY_HINT")})]});return this._infoDatesFooter;};z.prototype._getDatesLabel=function(){return this._infoDatesFooter.getContent()[0];};z.prototype._updateDatesLabel=function(){var o=this._oSelectedOption.getValueHelpOutput(this),a,b;if(!o||!o.operator||!d.getOption(o.operator)){return;}a=d.toDates(o);if(a){b=this._getDatesLabelFormatter().format(a);this._getDatesLabel().setText(y.getText("DDR_INFO_DATES",[b]));}};z.prototype._setApplyButtonEnabled=function(b){if(!this._oPopup){return;}var a=this._oPopup.getBeginButton();if(a.getVisible()){a.setEnabled(b);}};z.prototype._updateInternalControls=function(o){var b=o.validateValueHelpUI(this);if(b){this._updateDatesLabel();}this._setApplyButtonEnabled(b);};z.prototype._setFooterVisibility=function(b){var o;if(!this._oPopup){return;}o=this._oPopup.getAggregation("_popup");if(i.system.phone){this._oPopup.getBeginButton().setVisible(b);}else{o.getFooter().setVisible(b);}o.invalidate();return this;};z.prototype._createPopupContent=function(){var o=new P({showHeader:false,showNavButton:false}),a=new P({showHeader:true,showNavButton:true}).addStyleClass("sapMDynamicDateRangePopover");a.attachNavButtonPress(function(){this._setFooterVisibility(false);this._oNavContainer.back();},this);if(i.system.phone){o.setShowHeader(true);o.setTitle(this._getOptionsPageTitleText());}if(!this._oOptionsList){this._oOptionsList=new l({showSeparators:x.None,mode:w.None});}if(!this._oNavContainer){this._oNavContainer=new N({autoFocus:false});this._oNavContainer.addPage(o);this._oNavContainer.setInitialPage(o);this._oNavContainer.addPage(a);this._oNavContainer.attachAfterNavigate(this._navContainerAfterNavigate,this);this._oPopup.addContent(this._oNavContainer);}this._oNavContainer.getPages()[0].removeAllContent();this._oNavContainer.getPages()[0].addContent(this._oOptionsList);return this._oOptionsList;};z.prototype._applyNavContainerPageFocus=function(o){var a=this.getValue(),O=this._oNavContainer.getPages()[0],b;if(o===O&&a){b=this._oOptionsList.getItems().find(function(K){return K.isA("sap.m.DynamicDateRangeListItem")&&(K.getOptionKey()===a.operator);});}if(!b){b=jQuery(o.getDomRef().querySelector("section")).firstFocusableDomRef();}b.focus();this._reApplyFocusToElement(o,a);};z.prototype._reApplyFocusToElement=function(o,a){};z.prototype._getOptionsPageTitleText=function(){return f.getReferencingLabels(this).concat(this.getAriaLabelledBy()).reduce(function(a,b){var o=E.registry.get(b);return a+" "+(o.getText?o.getText():"");},"").trim();};z.prototype._navContainerAfterNavigate=function(o){var O=this._oNavContainer.getPages()[1],a=o.getParameters()["to"];if(a===O){this.aInputControls.forEach(function(b){if(jQuery(b.getDomRef()).firstFocusableDomRef()){b.addAriaLabelledBy(a.getAggregation("_internalHeader"));if(!this._isCalendarBasedControl(b)&&b.addAriaDescribedBy){b.addAriaDescribedBy(a.getFooter().getContent()[0]);}}},this);}if(this._oPopup&&this._oPopup.isOpen()){this._applyNavContainerPageFocus(a);}else{this.focus();}};z.prototype._isCalendarBasedControl=function(o){return o.isA("sap.ui.unified.Calendar")||o.isA("sap.ui.unified.calendar.CustomMonthPicker")||o.isA("sap.ui.unified.calendar.MonthPicker")||o.isA("sap.ui.unified.calendar.YearPicker")||o.isA("sap.ui.unified.calendar.YearRangePicker")||o.isA("sap.ui.unified.calendar.Month");};z.prototype._openPopup=function(){if(!this._oPopup){return;}this._oPopup._getPopup().setAutoCloseAreas([this._oInput.getDomRef()]);this._oPopup.openBy(this._oInput);};z.prototype._applyValue=function(){this._oOutput=this._oSelectedOption.getValueHelpOutput(this);var a=this.getValue();this.setValue(this._oOutput);this.fireChange({prevValue:a,value:this.getValue(),valid:true});this._closePopup();};z.prototype._closePopup=function(){this._setFooterVisibility(false);this._oNavContainer.to(this._oNavContainer.getPages()[0]);this._oPopup.close();};z.prototype._getFormatter=function(){var o=this.getFormatter(),b;if(o){return o;}if(this.oBoundValueFormatter){return this.oBoundValueFormatter;}b=this.getBinding("value");if(b&&b.getType()){this.oBoundValueFormatter=D.getInstance(b.getType().oFormatOptions);return this.oBoundValueFormatter;}if(!this.oDefaultFormatter){this.oDefaultFormatter=D.getInstance();}return this.oDefaultFormatter;};z.prototype._formatValue=function(o){return d.getOption(o.operator).format(o,this._getFormatter());};z.prototype._parseValue=function(a){var b=d.parse(a,this._getFormatter(),this.getOptions()).filter(function(o){return this.getOptions().indexOf(o.operator)!==-1;},this);return b.length?b[0]:null;};z.prototype._substitudeValue=function(o){var K,a,b;if(!o||!o.operator||!o.values){return o;}K=o.operator;a=o.values;if(K==="LASTDAYS"&&a[0]===1){b={operator:"YESTERDAY",values:[]};}else if(K==="NEXTDAYS"&&a[0]===1){b={operator:"TOMORROW",values:[]};}else if((K==="LASTDAYS"||K==="NEXTDAYS")&&a[0]===0){b={operator:"TODAY",values:[]};}return b?b:o;};var A=R.extend(n);A.apiVersion=2;A.getAriaRole=function(o){return"combobox";};A.writeInnerAttributes=function(o,a){o.attr("type","text");};A.getAccessibilityState=function(o){var a=n.getAccessibilityState(o),b=o._getControlOrigin(),K=b.getAriaLabelledBy(),O=f.getReferencingLabels(b),Q=b.getAriaDescribedBy().join(" "),U;U=O.concat(K).join(" ");if(Q){a.describedby=Q;}if(U){a.labelledby=U;}a.roledescription=y.getText("ACC_CTR_TYPE_DYNAMIC_DATE_RANGE");a.role=this.getAriaRole();a.expanded=b._oPopup?b._oPopup.isOpen():false;a.haspopup=c.aria.HasPopup.ListBox.toLowerCase();a.autocomplete="list";a.controls=b._oPopup&&b._oPopup.getDomRef()?b._oPopup.getDomRef().id:undefined;return a;};var H=m.extend("sap.m.internal.DynamicDateRangeInput",{metadata:{library:"sap.m"},renderer:A});H.prototype._setControlOrigin=function(o){this._oOriginControl=o;return this._oOriginControl;};H.prototype._getControlOrigin=function(){return this._oOriginControl;};H.prototype.preventChangeOnFocusLeave=function(o){return this.bFocusoutDueRendering;};var J=S.extend("sap.m.DynamicDateRangeListItem",{metadata:{library:"sap.m",properties:{optionKey:{type:"string",group:"Misc",defaultValue:null}}},renderer:k});J.prototype.getNavigationControl=function(){var o=S.prototype.getNavigationControl.apply(this,arguments),b=["SPECIFICMONTH","DATE","DATERANGE","FROM","TO"].includes(this.getOptionKey()),a=b?e.getIconURI("appointment-2"):e.getIconURI("slim-arrow-right");if(b){o.addStyleClass("sapMDDRDateOption");}o.setSrc(a);return o;};function _(o){var a=o;while(a&&a.classList){if(a.classList.contains("sapUiSizeCompact")){return true;}a=a.parentNode;}return false;}return z;});
