/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/odata/v4/vizChart/ChartDelegateNew","sap/fe/macros/ODataMetaModelUtil","sap/ui/mdc/odata/v4/ODataMetaModelUtil","sap/base/util/merge","sap/fe/macros/chart/ChartUtils","sap/ui/mdc/util/FilterUtil","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/base/SyncPromise","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/ResourceModel","sap/fe/macros/CommonHelper","sap/fe/macros/ChartAPI"],function(M,B,a,O,m,C,F,D,S,L,b,R,c,d){"use strict";var e=Object.assign({},B);function s(f,g){var n="",h=C.getAllFilterInfo(f),i=g.path.substr(1);if(f.getFilter()){if(h.search||(h.filters&&h.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT";}}else{if(h.search||(h.filters&&h.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"||n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT"){return f.getModel("sap.fe.i18n").getResourceBundle().then(function(r){f.setNoDataText(b.getTranslatedText(n,r,null,i));}).catch(function(j){L.error(j);});}else{if(R){f.setNoDataText(R.getText(n));}}}e._handleProperty=function(f,E,k,g,p,h){var A=c.parseCustomData(f.data("applySupported"));var l=E["@Org.OData.Capabilities.V1.SortRestrictions"]||{};var n=O.getSortRestrictionsInfo(l);var q=E["@Org.OData.Capabilities.V1.FilterRestrictions"];var r=O.getFilterRestrictionsInfo(q);var t=this.getModel().getObject(this.getPath());var K=this.getModel().getObject(this.getPath()+"@sapui.name");var u=this.getModel();if(t&&t.$kind==="Property"){if(t.$isCollection){return;}var P=u.getObject(this.getPath()+"@");var v=u.getObject("@sapui.name",u.getMetaContext(this.getPath()));var G=A&&A.GroupableProperties;var w=A&&A.AggregatableProperties;var x=false,y=false;if(G&&G.length){for(var i=0;i<G.length;i++){if(G[i].$PropertyPath===v){x=true;break;}}}if(w&&w.length){for(var j=0;j<w.length;j++){if(w[j].Property.$PropertyPath===v){y=true;break;}}}if(!G||(G&&!G.length)){x=P["@Org.OData.Aggregation.V1.Groupable"];}if(!w||(w&&!w.length)){y=P["@Org.OData.Aggregation.V1.Aggregatable"];}if(!x&&!y){return;}if(y){var z=e._createPropertyInfosForAggregatable(K,P,r,n,k,g);z.forEach(function(H){p.push(H);});}if(x){var N=K||"",T=P["@com.sap.vocabularies.Common.v1.Text"]?P["@com.sap.vocabularies.Common.v1.Text"].$Path:null;var I=false;if(N&&N.indexOf("/")>-1){L.error("$expand is not yet supported. Property: "+N+" from an association cannot be used");return;}if(T&&T.indexOf("/")>-1){L.error("$expand is not yet supported. Text Property: "+T+" from an association cannot be used");I=true;}p.push({name:K,propertyPath:K,label:P["@com.sap.vocabularies.Common.v1.Label"]||K,sortable:n[K]?n[K].sortable:true,filterable:r[K]?r[K].filterable:true,groupable:true,aggregatable:false,maxConditions:O.isMultiValueFilterExpression(r.propertyInfo[K])?-1:1,sortKey:K,kind:"Groupable",availableRoles:e._getLayoutOptionsForType("groupable"),role:M.ChartItemRoleType.category,criticality:h,textProperty:!I&&P["@com.sap.vocabularies.Common.v1.Text"]?P["@com.sap.vocabularies.Common.v1.Text"].$Path:null,textFormatter:function(V,H){if(P["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]){var J=P["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"];if(J.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst"){return H+" ("+V+")";}else if(J.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return V+" ("+H+")";}else if(J.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return H;}}return H?H:V;}});}}};e.updateBindingInfo=function(f,g){s(f,g);var h=sap.ui.getCore().byId(f.getFilter());if(h){var i=h.getConditions();if(i){if(!g){g={};}var I=f.getControlDelegate()._getChart(f);var j;if(I){if(C.getChartSelectionsExist(f)){j=C.getAllFilterInfo(f);}}j=j?j:C.getFilterBarFilterInfo(f);if(j){g.filters=j.filters;}var p=D.getParametersInfo(h,i);if(p){g.path=p;}}}};e.fetchProperties=function(f){var g=this._getModel(f);var p;if(!g){p=new Promise(function(r){f.attachModelContextChange({resolver:r},o,this);}.bind(this)).then(function(g){return this._createPropertyInfos(f,g);}.bind(this));}else{p=this._createPropertyInfos(f,g);}return p.then(function(P){if(f.data){f.data("$mdcChartPropertyInfo",P);}return P;});};function o(E,f){var g=E.getSource();var h=this._getModel(g);if(h){g.detachModelContextChange(o);f.resolver(h);}}e._createPropertyInfos=function(f,g){var E="/"+f.data("entitySet");var h=g.getMetaModel();return Promise.all([h.requestObject(E+"/"),h.requestObject(E+"@")]).then(function(r){var p=[];var i=r[0],j=r[1];var k=c.parseCustomData(f.data("customAgg"));var A;var P=[];for(var l in j){if(l.startsWith("@Org.OData.Aggregation.V1.CustomAggregate")){A=l.replace("@Org.OData.Aggregation.V1.CustomAggregate#","");var n=A.split("@");if(n.length==2&&n[1]=="com.sap.vocabularies.Common.v1.Label"){k[n[0].label]=j[l];}}}var q=[],t=[];if(Object.keys(k).length>=1){var u=f.getItems();for(var v in u){if(u[v].isA("sap.ui.mdc.chart.DimensionItem")){q.push(u[v].getKey());}else if(u[v].isA("sap.ui.mdc.chart.MeasureItem")){t.push(u[v].getKey());}}if(t.filter(function(z){return q.indexOf(z)!=-1;}).length>=1){L.error("Dimension and Measure has the sameProperty Configured");}}var T=c.parseCustomData(f.data("transAgg"));var K={};for(var w in T){var x=T[w].propertyPath;K[x]=K[x]||{};K[x][T[w].aggregationMethod]={name:T[w].name,label:T[w].label};}for(var y in i){if(y.indexOf("$")!==0){P.push(a.fetchCriticality(h,h.createBindingContext(E+"/"+y)).then(e._handleProperty.bind(h.getMetaContext(E+"/"+y),f,j,K,k,p)));}}return Promise.all(P).then(function(){return p;});});};e._createPropertyInfosForAggregatable=function(k,p,f,g,K,h){var A=[];if(Object.keys(K).indexOf(k)>-1){for(var i in K[k]){A.push({name:K[k][i].name,propertyPath:k,label:K[k][i].label||p["@com.sap.vocabularies.Common.v1.Label"]+" ("+i+")"||k+" ("+i+")",sortable:g[k]?g[k].sortable:true,filterable:f[k]?f[k].filterable:true,groupable:false,aggregatable:true,aggregationMethod:i,maxConditions:O.isMultiValueFilterExpression(f.propertyInfo[k])?-1:1,kind:"Aggregatable",availableRoles:e._getLayoutOptionsForType("aggregatable"),role:M.ChartItemRoleType.axis1,datapoint:null});}}else if(Object.keys(h).indexOf(k)>-1){for(var j in h){if(j===k){var I=m({},h[j],{groupable:false,aggregatable:true,kind:"Aggregatable",availableRoles:e._getLayoutOptionsForType("aggregatable"),role:M.ChartItemRoleType.axis1,datapoint:null});A.push(I);break;}}}return A;};e.rebindChart=function(f,g){B.rebindChart(f,g);};e._setChart=function(f,i){var g=f.getParent();i.setVizProperties(f.data("vizProperties"));i.detachSelectData(g.handleSelectionChange.bind(g));i.detachDeselectData(g.handleSelectionChange.bind(g));i.detachDrilledUp(g.handleSelectionChange.bind(g));i.attachSelectData(g.handleSelectionChange.bind(g));i.attachDeselectData(g.handleSelectionChange.bind(g));i.attachDrilledUp(g.handleSelectionChange.bind(g));i.setSelectionMode(f.getPayload().selectionMode.toUpperCase());B._setChart(f,i);};e._getBindingInfo=function(f){if(this._getBindingInfoFromState(f)){return this._getBindingInfoFromState(f);}var g=f.getDelegate().payload;var h=f.getModel()&&f.getModel().getMetaModel();var t=f.data("targetCollectionPath");var E=(h.getObject(t+"/$kind")==="EntitySet"?"/":"")+g.contextPath;var p=m({},g.parameters,{entitySet:f.data("entitySet"),useBatchRequests:true,provideGrandTotals:true,provideTotalResultSize:true,noPaging:true});var i={path:E,parameters:p};return i;};e.removeItemFromInnerChart=function(f,g){B.removeItemFromInnerChart.call(this,f,g);if(g.getType()==="groupable"){var i=this._getChart(f);i.fireDeselectData();}};return e;},false);
