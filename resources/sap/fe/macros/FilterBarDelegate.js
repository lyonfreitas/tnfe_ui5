/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate","sap/ui/model/json/JSONModel","sap/fe/core/TemplateModel","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/fe/macros/filter/FilterFieldHelper","sap/fe/macros/filter/FilterUtils","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/ResourceModel","sap/base/util/merge","sap/fe/macros/DelegateUtil","sap/fe/macros/FilterBarHelper","sap/base/Log","sap/base/util/JSTokenizer","sap/fe/core/templating/PropertyFormatters"],function(F,J,T,C,c,M,S,d,e,f,g,R,m,D,h,L,i,P){"use strict";var O=Object.assign({},F),E="$editState",j="$search",V="FilterFieldValueHelp",k="sap_fe_FilterBarDelegate_propertyInfoMap",l=/\+|\*/g;var n=c.FilterRestrictions;function _(){return{name:j,path:j,typeConfig:g.getTypeConfig("sap.ui.model.odata.type.String"),maxConditions:1};}function o(){return{name:E,path:E,groupLabel:"",group:"",label:R.getText("M_COMMON_FILTERBAR_EDITING_STATUS"),tooltip:null,hiddenFilter:false,typeConfig:g.getTypeConfig("sap.ui.model.odata.type.String")};}function p(I,a){var b=new J({id:I}),A={bindingContexts:{"this":b.createBindingContext("/")},models:{"this.i18n":R.getModel(),"this":b}};return D.templateControlFragment("sap.fe.macros.filter.DraftEditState",A,undefined,a).finally(function(){b.destroy();});}function q(a,I,b,A,B){var G=new J({id:I}),H=new T(b,A),K={bindingContexts:{"this":G.createBindingContext("/"),"item":H.createBindingContext("/")},models:{"this":G,"item":H}};return D.templateControlFragment("sap.fe.macros.filter.CustomFilter",K,undefined,B).finally(function(){G.destroy();H.destroy();});}function r(a){return a.replace(l,"");}function s(a,b){return a.find(function(A){return A.conditionPath===b&&A.availability!=="Hidden";});}O._fetchBasicPropertyInfo=function(a){return{name:a.conditionPath,path:a.conditionPath,groupLabel:a.groupLabel,group:a.group,label:a.label,tooltip:null,hiddenFilter:a.availability==="Hidden",removeFromAppState:false,hasValueHelp:false,display:"Value",typeConfig:g.getTypeConfig("String"),isParameter:a.isParameter,caseSensitive:a.caseSensitive};};function t(a,b){var A=O._fetchBasicPropertyInfo(b),B=b.annotationPath;if(!B){return A;}var G=B.substr(0,B.lastIndexOf("/")),H=a.getObject(B),I=a.getObject(B+"@"),K=a.getObject(G+"/@"),N,Q,U=a.createBindingContext(B),W=i.parseJS(e.formatOptions(H,{context:U})||"{}"),X=i.parseJS(e.constraints(H,{context:U})||"{}"),Y=I["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||I["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||I["@com.sap.vocabularies.Analytics.v1.Measure"];var Z=C.getLocationForPropertyPath(a,b.annotationPath);var $=b.annotationPath.replace(Z+"/","");if(!c.isPropertyFilterable(a,Z,r($),true)){return null;}Q=I["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(Q){N=Q["$"+D.getModelType(H.$Type)];}A=Object.assign(A,{tooltip:I["@com.sap.vocabularies.Common.v1.QuickInfo"]||undefined,removeFromAppState:Y,hasValueHelp:P.hasValueHelp(U.getObject(),{context:U}),formatOptions:W,constraints:X,typeConfig:g.getTypeConfig(H.$Type,W,X),display:d.displayMode(I,K),defaultFilterConditions:N?[{fieldPath:b.conditionPath,operator:"EQ",values:[N]}]:undefined});return A;}function u(a,b,N){return N?S.generate([a,b,N]):S.generate([a,b]);}function v(a,b){return Promise.resolve().then(function(){var A=new J({idPrefix:b.sVhIdPrefix,conditionModel:"$filters",navigationPrefix:b.sNavigationPrefix?"/"+b.sNavigationPrefix:"",filterFieldValueHelp:true,useSemanticDateRange:b.bUseSemanticDateRange}),B=m({},a,{bindingContexts:{"this":A.createBindingContext("/")},models:{"this":A}});return D.templateControlFragment("sap.fe.macros.internal.valuehelp.ValueHelp",B,{isXML:a.isXML}).then(function(G){if(G){var H="dependents";if(G.length){G.forEach(function(I){if(b.oModifier){return b.oModifier.insertAggregation(b.oControl,H,I,0);}else{b.oControl.insertAggregation(H,I,0,false);}});}else if(b.oModifier){return b.oModifier.insertAggregation(b.oControl,H,G,0);}else{b.oControl.insertAggregation(H,G,0,false);}}}).finally(function(){A.destroy();});}).catch(function(A){L.error("Error while evaluating DelegateUtil.isValueHelpRequired",A);});}function w(a,b){var A=new J({idPrefix:b.sIdPrefix,vhIdPrefix:b.sVhIdPrefix,propertyPath:b.sPropertyName,navigationPrefix:b.sNavigationPrefix?"/"+b.sNavigationPrefix:"",useSemanticDateRange:b.bUseSemanticDateRange,settings:b.oSettings,visualFilter:b.visualFilter});var B=b.oMetaModel;var G=new T(b.visualFilter,B);var H=m({},a,{bindingContexts:{"this":A.createBindingContext("/"),"visualFilter":G.createBindingContext("/")},models:{"this":A,"visualFilter":G,"metaModel":B}});return D.templateControlFragment("sap.fe.macros.FilterField",H,{isXML:a.isXML}).finally(function(){A.destroy();});}O.addItem=function(a,b,A){if(!A){return O._addP13nItem(a,b);}var B=A.appComponent&&A.appComponent.getModel().getMetaModel();if(!B){return Promise.resolve(null);}return O._addFlexItem(a,b,B,A.modifier);};O._addP13nItem=function(a,b){return D.fetchModel(b).then(function(A){return O._addFlexItem(a,b,A.getMetaModel(),undefined);}).catch(function(A){L.error("Model could not be resolved",A);return null;});};O.fetchPropertiesForEntity=function(a,b,A){var B=b.getObject(a);if(!A||!B){return[];}var G=M.getEntitySetPath(a),H=f.getConvertedFilterFields(A,a),I,K=[],N=[],Q=c.getFilterRestrictionsByPath(G,b),U=Q[n.REQUIRED_PROPERTIES],W=Q[n.NON_FILTERABLE_PROPERTIES],X=Q[n.ALLOWED_EXPRESSIONS];Object.keys(H).forEach(function(Z){var $=H[Z];var a1=r($.conditionPath);if(W.indexOf(a1)===-1){I=t(b,$);if(I){if(X[a1]&&X[a1].length>0){I.filterExpression=c.getSpecificAllowedExpression(X[a1]);}else{I.filterExpression="auto";}I.maxConditions=!I.isParameter&&D.isMultiValue(I)?-1:1;I.required=I.isParameter||U.indexOf(a1)>=0;I.visible=$.availability==="Default";I.label=D.getLocalizedText($.label,A);K.push(I);if(I.isParameter){N.push(a1);}}}});if(A.data("showDraftEditState")==="true"){K.push(o());}if(G&&A.data("hideBasicSearch")!=="true"){var Y=c.getSearchRestrictions(G,b);if(!Y||Y.Searchable){K.push(_());}}D.setCustomData(A,"parameters",N);return K;};O._addFlexItem=function(a,b,A,B){var G=B?B.getId(b):b.getId(),I=B?"":"Adaptation",H=f.getConvertedFilterFields(b),K=s(H,a),N=r(a),Q=!!B&&B.targets==="xmlTree";if(a===E){return p(G,B);}else if(a===j){return Promise.resolve(null);}else if(K&&K.template){return q(b,u(G,I+"FilterField"),K,A,B);}var U=C.getNavigationPath(N),W=K.annotationPath,X,Y,Z,$,a1;return Promise.resolve().then(function(){if(K.isParameter){return W.substr(0,W.lastIndexOf("/")+1);}return D.getCustomData(b,"entityType",B);}).then(function(b1){X=b1;return D.getCustomData(b,"useSemanticDateRange",B);}).then(function(b1){Y=b1;var c1=A.createBindingContext(X+N);var G=B?B.getId(b):b.getId();Z={bindingContexts:{"contextPath":A.createBindingContext(X),"property":c1},models:{"contextPath":A,"property":A},isXML:Q};$="/"+M.getEntitySetPath(X).split("/").filter(M.filterOutNavPropBinding).join("/");a1={sPropertyName:N,sBindingPath:$,sValueHelpType:I+V,oControl:b,oMetaModel:A,oModifier:B,sIdPrefix:u(G,I+"FilterField",U),sVhIdPrefix:u(G,I+V),sNavigationPrefix:U,bUseSemanticDateRange:Y,oSettings:K?K.settings:{},visualFilter:K?K.visualFilter:undefined};return D.doesValueHelpExist(a1);}).then(function(b1){if(!b1){return v(Z,a1);}return Promise.resolve();}).then(function(){return w(Z,a1);});};function x(a){if(a instanceof window.Element){return null;}return D.getCustomData(a,k);}function y(a,b){if(a instanceof window.Element){return;}D.setCustomData(a,k,b);}function z(A,B,G){var H=x(G);var I;if(!H){H=O.fetchPropertiesForEntity(A,B,G);H.forEach(function(a){I=null;if(a.groupLabel){I=D.getLocalizedText(a.groupLabel,G);a.groupLabel=I===null?a.groupLabel:I;}});H.sort(function(a,b){if(a.groupLabel===undefined||a.groupLabel===null){return-1;}if(b.groupLabel===undefined||b.groupLabel===null){return 1;}return a.groupLabel.localeCompare(b.groupLabel);});y(G,H);}return H;}O.fetchProperties=function(a){var b=D.getCustomData(a,"entityType");return D.fetchModel(a).then(function(A){if(!A){return[];}return z(b,A.getMetaModel(),a);});};O.getTypeUtil=function(a){return g;};return O;},false);
