/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageToast","sap/m/MessageItem","sap/m/MessageView","sap/m/Button","sap/m/Dialog","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/message/Message","sap/ui/core/IconPool","sap/ui/model/json/JSONModel","sap/ui/core/format/DateFormat"],function(M,a,b,B,D,C,F,c,d,I,J,e){"use strict";var f=C.MessageType;var t=this;function g(){var P;function i(w){return w.property?"( ${"+w.property+'} ? ("<p>'+w.property.substr(Math.max(w.property.lastIndexOf("/"),w.property.lastIndexOf("."))+1)+' : " + '+"${"+w.property+'} + "</p>") : "" )':"";}function u(w){var H="";if(w.groupName&&w.property&&w.groupName!==P){H+="( ${"+w.property+'} ? "<br><h3>'+w.groupName+'</h3>" : "" ) + ';P=w.groupName;}return H;}function v(){var T="technicalDetails";return[{"groupName":"","property":T+"/status"},{"groupName":"","property":T+"/statusText"},{"groupName":"Application","property":T+"/error/@SAP__common.Application/ComponentId"},{"groupName":"Application","property":T+"/error/@SAP__common.Application/ServiceId"},{"groupName":"Application","property":T+"/error/@SAP__common.Application/ServiceRepository"},{"groupName":"Application","property":T+"/error/@SAP__common.Application/ServiceVersion"},{"groupName":"ErrorResolution","property":T+"/error/@SAP__common.ErrorResolution/Analysis"},{"groupName":"ErrorResolution","property":T+"/error/@SAP__common.ErrorResolution/Note"},{"groupName":"ErrorResolution","property":T+"/error/@SAP__common.ErrorResolution/DetailedNote"},{"groupName":"ErrorResolution","property":T+"/error/@SAP__common.ExceptionCategory"},{"groupName":"ErrorResolution","property":T+"/error/@SAP__common.TimeStamp"},{"groupName":"ErrorResolution","property":T+"/error/@SAP__common.TransactionId"},{"groupName":"Messages","property":T+"/error/code"},{"groupName":"Messages","property":T+"/error/message"}];}var H="Object.keys("+"${technicalDetails}"+').length > 0 ? "<h2>Technical Details</h2>" : "" ';v().forEach(function(w){H=H+u(w)+""+i(w)+" + ";});return H;}function h(){var H="(${"+'description} ? ("<h2>Description</h2>" + ${'+'description}) : "")';return H;}function G(u){var v=f.None,L=u.length,w={Error:0,Warning:0,Success:0,Information:0};for(var i=0;i<L;i++){++w[u[i].getType()];}if(w[f.Error]>0){v=f.Error;}else if(w[f.Warning]>0){v=f.Warning;}else if(w[f.Success]>0){v=f.Success;}else if(w[f.Information]>0){v=f.Information;}return v;}function m(u,R){var v=u.getMessageModel().getObject("/");var w=false;var E="";v.forEach(function(x,i){var T=x.getTechnicalDetails();if(T&&T.httpStatus===412){E=E||R.getText("C_APP_COMPONENT_SAPFE_ETAG_TECHNICAL_ISSUES");u.removeMessages(v[i]);x.setMessage(E);x.target="";u.addMessages(x);w=true;}});return w;}function j(){t.oDialog.close();t.oBackButton.setVisible(false);r();}function k(i,u){var N=new Date();var T=i.getTechnicalDetails(),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),v;if(T&&T.httpStatus===503&&T.retryAfter){var w=T.retryAfter;var v;var x;if(N.getFullYear()!==w.getFullYear()){x=e.getDateTimeInstance({pattern:"MMMM dd, yyyy 'at' hh:mm a"});v=R.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR_YEAR",x.format(w));}else if(N.getFullYear()==w.getFullYear()){if(u){v=R.getText("C_MESSAGE_HANDLING_SAPFE_503_TITLE")+" "+R.getText("C_MESSAGE_HANDLING_SAPFE_503_DESC");}else if(N.getMonth()!==w.getMonth()||N.getDate()!==w.getDate()){x=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"MMMM dd 'at' hh:mm a"});v=R.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR",x.format(w));}else{x=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"hh:mm a"});v=R.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR_DAY",x.format(w));}}}if(T&&T.httpStatus===503&&!T.retryAfter){v=R.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR_NO_RETRY_AFTER");}return v;}function s(u,v,H,S){var U=o(),w=sap.ui.getCore().getMessageManager(),x,y,z=[new F({path:"code",operator:c.NE,value1:null}),new F({path:"persistent",operator:c.NE,value1:false})],A=false;if(S){U.push.apply(U,o(true,true));z.push(new F({path:"persistent",operator:c.EQ,value1:true}));var E=function(i){var P=Infinity,Q=sap.ui.getCore().byId(i[0]),R=sap.ui.getCore().byId(i[0]);while(Q){var T=Q instanceof D?R.getParent().findElements(true).indexOf(R):Infinity;if(Q instanceof D){if(P>T){P=T;R.focus();}return false;}Q=Q.getParent();}return true;};z.push(new F({path:"controlIds",test:E,caseSensitive:true}));}else{z.push(new F({path:"target",operator:c.EQ,value1:""}));}if(u&&u.length){u.forEach(function(i){var P=i.code?i.code:"";w.addMessages(new d({message:i.text,type:i.type,target:"",persistent:true,code:P}));});}var L=w.getMessageModel().bindList("/",undefined,undefined,z),K=L.getCurrentContexts(),N=new J();if(K&&K.length>0){A=true;var O=[];K.forEach(function(v){var i=v.getObject(),R=k(i,true);if(R){i.setMessage(R+" "+i.getMessage());}O.push(i);});N.setData(O);}if(U.length===0&&!u&&!H){return Promise.resolve(true);}else if(U.length===1&&U[0].getType()===f.Success&&!u){return new Promise(function(i,P){M.show(U[0].message);w.removeMessages(U);i();});}else if(A){t.aResolveFunctions=t.aResolveFunctions||[];return new Promise(function(P,Q){t.aResolveFunctions.push(P);sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(R){t.oMessageTemplate=t.oMessageTemplate||new a({counter:"{counter}",title:"{message}",subtitle:"{additionalText}",longtextUrl:"{descriptionUrl}",type:"{type}",description:"{= ${"+"description} || ${technicalDetails} ? "+'"<html><body>" + '+h()+" + "+g()+'"</body></html>"'+' : "" }',markupDescription:true});t.oMessageView=t.oMessageView||new b({showDetailsPageHeader:false,itemSelect:function(){t.oBackButton.setVisible(true);},items:{path:"/",template:t.oMessageTemplate}});t.oBackButton=t.oBackButton||new B({icon:I.getIconURI("nav-back"),visible:false,press:function(){t.oMessageView.navigateBack();this.setVisible(false);}});t.oMessageView.setModel(N);t.oDialog=t.oDialog||new D({resizable:true,content:t.oMessageView,endButton:new B({press:function(){j();if(S){n();}},text:R.getText("C_COMMON_SAPFE_CLOSE")}),customHeader:new sap.m.Bar({contentMiddle:[new sap.m.Text({text:R.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE")})],contentLeft:[t.oBackButton]}),contentWidth:"37.5em",contentHeight:"21.5em",verticalScrolling:false,afterClose:function(T){for(var i=0;i<t.aResolveFunctions.length;i++){t.aResolveFunctions[i].call();}t.aResolveFunctions=[];}});var H=m(w,R);if(H){sap.ui.require(["sap/m/ButtonType"],function(i){t.oDialog.setBeginButton(new B({press:function(){j();if(v.hasPendingChanges()){v.getBinding().resetChanges();}v.refresh();},text:R.getText("C_COMMON_SAPFE_REFRESH"),type:i.Emphasized}));});}else{t.oDialog.destroyBeginButton();}x=G(t.oMessageView.getItems());y=l(x);t.oDialog.setState(x);t.oDialog.getCustomHeader().getContentMiddle()[0].setText(y);t.oMessageView.navigateBack();t.oDialog.open();}).catch(Q);});}else{return Promise.resolve(true);}}function l(H){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");switch(H){case"Error":return R.getText("C_COMMON_SAPFE_ERROR_MESSAGES_PAGE_TITLE_ERROR");case"Information":return R.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_INFO");case"Success":return R.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_SUCCESS");case"Warning":return R.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING");default:return R.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE");}}function r(){p(false);}function n(){p(true);}function o(u,T){var v=sap.ui.getCore().getMessageManager(),w=v.getMessageModel(),x=w.getObject("/"),y=[];for(var i=0;i<x.length;i++){if((!T||x[i].persistent)&&((u&&x[i].target!=="")||(!u&&(!x[i].target||x[i].target==="")))&&x[i].code){y.push(x[i]);}}for(var i=0;i<y.length;i++){if(y[i].code==="503"){y[i].message="\n"+y[i].message;}}return y;}function p(i){var u=o(i,true);if(u.length>0){sap.ui.getCore().getMessageManager().removeMessages(u);}}var q={getMessages:o,showUnboundMessages:s,removeUnboundTransitionMessages:r,removeBoundTransitionMessages:n,modifyETagMessagesOnly:m,getRetryAfterMessage:k};return q;});
