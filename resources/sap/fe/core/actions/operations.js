/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/messageHandling","sap/fe/core/BusyLocker","sap/fe/core/CommonUtils","sap/base/Log","sap/fe/core/library","sap/fe/core/helpers/FPMHelper"],function(M,D,J,X,a,F,m,B,C,L,b,c){"use strict";var d=b.Constants;function e(A,i,j,u,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=[i];}var v=j.getMetaModel(),w=v.getMetaPath(i[0].getPath())+"/"+A,x=v.createBindingContext(w+"/@$ui5.overload/0");P.aContexts=i;P.isCriticalAction=o(v,w,i,x);return k(A,j,x,u,P);}function f(A,i,j,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var u=i.getMetaModel(),v=i.bindContext("/"+A).getPath(),w=u.createBindingContext("/"+u.createBindingContext(v).getObject("$Action")+"/0");P.isCriticalAction=o(u,v+"/@$ui5.overload");return k(A,i,w,j,P);}function g(i,j,u){if(!j){return Promise.reject("Bound functions always requires a context");}var v=u.getMetaModel(),w=v.getMetaPath(j.getPath())+"/"+i,x=v.createBindingContext(w);return _(i,u,x,j);}function h(i,j){if(!i){return Promise.resolve();}var u=j.getMetaModel(),v=j.bindContext("/"+i).getPath(),w=u.createBindingContext("/"+u.createBindingContext(v).getObject("$Function")+"/0");return _(i,j,w);}function _(i,j,u,v){var w,G;if(!u||!u.getObject()){return Promise.reject(new Error("Function"+i+" not found"));}if(v){u=j.bindContext(i+"(...)",v);G="functionGroup";}else{u=j.bindContext("/"+i+"(...)");G="functionImport";}w=u.execute(G);j.submitBatch(G);return w.then(function(){return u.getBoundContext();});}function k(A,i,j,u,P){return new Promise(function(v,w){var x=P.actionParameters||[],y={},z,E,G=P.label,S=P.showActionParameterDialog,H=P.aContexts,I=P.bIsCreateAction,K=P.isCriticalAction,N,O,Q,R;if(!j||!j.getObject()){return w(new Error("Action"+A+" not found"));}if(S||x.length>0){x=p(j,x);if(!x||x.length===0){S=false;}}if(S){z=s;}else if(K){z=l;}y={fnOnSubmitted:P.onSubmitted,fnOnResponse:P.onResponse,actionName:A,model:i,aActionParameters:x,bGetBoundContext:P.bGetBoundContext,defaultValuesExtensionFunction:P.defaultValuesExtensionFunction};if(j.getObject("$IsBound")){if(P.additionalSideEffect&&P.additionalSideEffect.pathExpressions){N=i.getMetaModel();O=N.getMetaPath(H[0].getPath());Q=N.getObject(O+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(Q){R=P.additionalSideEffect.pathExpressions.findIndex(function(T){return T.$PropertyPath===Q;});if(R>-1){P.mBindingParameters=P.mBindingParameters||{};if(j.getObject("$ReturnType/$Type/"+Q)&&(!P.mBindingParameters.$select||P.mBindingParameters.$select.split(",").indexOf(Q)===-1)){P.mBindingParameters.$select=P.mBindingParameters.$select?P.mBindingParameters.$select+","+Q:Q;if(P.additionalSideEffect.triggerActions.length===0){P.additionalSideEffect.pathExpressions.splice(R,1);}}}}}y.aContexts=H;y.mBindingParameters=P.mBindingParameters;y.additionalSideEffect=P.additionalSideEffect;y.bGrouped=P.invocationGrouping==="ChangeSet";y.bReturnAsArray=P.bReturnAsArray;y.internalModelContext=P.internalModelContext;y.operationAvailableMap=P.operationAvailableMap;y.bObjectPage=P.bObjectPage;}if(I){y.bIsCreateAction=I;}if(z){E=z(A,u,G,y,x,j,P.parentControl,P.entitySetName,P.messageHandler);}else{E=q(u,y);}return E.then(function(T){v(T);}).catch(function(T){w(T);});});}function l(A,i,j,P,u,v,w,x,y){return new Promise(function(z,E){var G=A?A:null;G=G.indexOf(".")>=0?G.split(".")[G.split(".").length-1]:G;var H=G&&x?x+"|"+G:"";var R=w.getController().oResourceBundle;var I=C.getTranslatedText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",R,null,H);M.confirm(I,{onClose:function(K){if(K===M.Action.OK){return q(i,P).then(function(O){z(O);}).catch(function(N){y.showMessageDialog().then(function(){E(N);}).catch(function(){E(N);});});}else{z();}}});});}function s(A,u,v,P,w,x,y,z,E){var G=r(x,A),H=x.getModel().oModel.getMetaModel(),I=H.createBindingContext(G),K=x.getObject("$IsBound")?x.getPath().split("/@$ui5.overload/0")[0]:x.getPath().split("/0")[0],N=H.createBindingContext(K),O="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(Q,R){var S=X.loadTemplate(O,"fragment"),T=new J({$displayMode:{}}),U=[],V=[],W={},Y=function(){return Promise.all(V.filter(function(i){var j=i.getFields()[0];return j.getRequired()&&j.getValueState()!=="Error";}).map(function(i){var j=i.getFields()[0].isA("sap.ui.mdc.MultiValueField")?i.getFields()[0].getItems():i.getFields()[0].getValue();if(j===undefined||j===null||j===""){return i.getLabel().getText();}})).then(function(i){i=i.filter(function(j){return j!==undefined;});return i;});},Z=function(w,U,i){var j=sap.ui.getCore().getMessageManager();var a1=j.getMessageModel().getData();U=[];w.forEach(function(b1){var c1=b1.$Name;a1.forEach(function(d1){var e1=c1.replace("-inner","");if(d1.controlIds.length>0&&(d1.getControlId().includes("APD_::"+c1)||(d1.getControlId().includes("APD_::"+c1+"inner")&&U.indexOf("APD_::"+e1)<0))){if(i){j.removeMessages(d1);}else{U.push("APD_::"+e1);}}if(d1.target.includes("APD_::"+c1)){U.push("APD_::"+e1);d1.target=i?"":d1.target;j.removeMessages(d1);}});});return U;},$={handleChange:function(i){E.removeTransitionMessages();var j=i.getSource();var a1=i.getParameter("id");var b1=i.getParameter("promise");if(b1){W[a1]=b1.then(function(){return j.getValue();});}Z(w,U);}};return Promise.resolve(a.process(S,{name:O},{bindingContexts:{action:x,actionName:N,entitySet:I},models:{action:x.getModel(),actionName:N.getModel(),entitySet:I.getModel(),metaModel:I.getModel()}})).then(function(S){return C.setUserDefaults(u,w,T,true).then(function(){return F.load({definition:S,controller:$}).then(function(a1){var b1;var c1=y.getController().oResourceBundle;var d1=new D({title:v||C.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE",c1),content:[a1],escapeHandler:function(i){d1.close();E.removeTransitionMessages();R();},beginButton:{text:v||C.getTranslatedText("C_COMMON_DIALOG_OK",c1),type:"Emphasized",press:function(h1){Y().then(function(i1){if(i1.length){var j1=[];for(var i=0;i<i1.length;i++){j1.push({text:C.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_MISSING_MANDATORY_MSG",c1,i1[i]),code:200,type:"Error"});}E.showMessageDialog({customMessages:j1});return;}U=Z(w,U);if(U.length>0){return m.showUnboundMessages();}B.lock(d1);return Promise.all(Object.keys(W).map(function(j){return W[j];})).then(function(){E.removeTransitionMessages();var k1,l1=b1&&b1.getParameterContext();for(var i in w){if(w[i].$isCollection){var m1=d1.getModel("mvfview").getProperty("/"+w[i].$Name),n1=[];for(var j in m1){n1.push(m1[j].Key);}k1=n1;}else{k1=l1.getProperty(w[i].$Name);}w[i].value=k1;k1=undefined;}return q(u,P).then(function(o1){d1.close();Q(o1);}).catch(function(o1){throw o1;});}).catch(function(){var j=sap.ui.getCore().getMessageManager();var k1=m.modifyETagMessagesOnly(j,c1);E.showMessages({bHasEtagMessage:k1,context:P.aContexts[0],isActionParameterDialogOpen:true,messagePageNavigationCallback:function(){d1.close();}});if(d1&&k1){d1.close();}}).finally(function(){B.unlock(d1);});}).catch(function(){return E.showMessageDialog();});}},endButton:{text:C.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",c1),press:function(){Z(w,U,true);d1.close();E.removeTransitionMessages();R(d.CancelActionDialog);}},beforeOpen:function(h1){var i1=Object.assign({},h1);E.removeTransitionMessages();var j1=function(l1){var m1=function(q1,j){return new Promise(function(Q,R){if(j!==undefined){if(g1.length>0&&j.$Path){var z1=C.requestSingletonProperty(j.$Path,b1.getModel());z1.then(function(A1){if(A1===null){return b1.getParameterContext().requestProperty(j.$Path);}return A1;}).then(function(A1){if(g1.length>1){var B1=j.$Path;if(B1.indexOf(l1+"/")===0){B1=B1.replace(l1+"/","");}for(var i=1;i<g1.length;i++){if(g1[i].getProperty(B1)!==A1){Q({paramName:q1,value:undefined,bNoPossibleValue:true});}}}Q({paramName:q1,value:A1});}).catch(function(){L.error("Error while reading default action parameter",q1,P.actionName);Q({paramName:q1,value:undefined,bLatePropertyError:true});});}else{Q({paramName:q1,value:j});}}else{if(T&&T.oData[q1]){Q({paramName:q1,value:T.oData[q1]});}else{Q({paramName:q1,value:undefined});}}});};var n1=function(q1){var j=d1.getModel().getMetaModel(),f1=x.sPath&&x.sPath.split("/@")[0],z1=f1+"/"+q1+"@",A1=j.getObject(z1),B1=A1&&A1["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];return B1;};var o1=function(){var j=d1.getModel().getMetaModel(),f1=x.sPath&&x.sPath.split("/@")[0],z1=j.getObject(f1+"@com.sap.vocabularies.Common.v1.DefaultValuesFunction");return z1;};var p1=[];var q1,r1;for(var i in w){q1=w[i].$Name;r1=n1(q1);p1.push(m1(q1,r1));}if(x.getObject("$IsBound")&&g1.length>0){var s1=o1();if(s1&&s1.length>0&&typeof s1==="string"){var t1=[];for(var i in g1){t1.push(g(s1,g1[i],P.model,P));}}}var u1=Promise.all(p1),v1=[],w1;if(t1){v1=Promise.all(t1);}if(P.defaultValuesExtensionFunction){var x1=P.defaultValuesExtensionFunction.substring(0,P.defaultValuesExtensionFunction.lastIndexOf(".")||-1).replace(/\./gi,"/"),y1=P.defaultValuesExtensionFunction.substring(P.defaultValuesExtensionFunction.lastIndexOf(".")+1,P.defaultValuesExtensionFunction.length);w1=c.actionWrapper(i1,x1,y1,{"contexts":g1});}Promise.all([u1,v1,w1]).then(function(z1){var p1=z1[0],t1=z1[1],A1=z1[2],B1;for(var i in w){B1=w[i].$Name;if(A1&&A1.hasOwnProperty(B1)){b1.setParameter(w[i].$Name,A1[B1]);}else if(p1[i]&&p1[i].value!==undefined){b1.setParameter(w[i].$Name,p1[i].value);}else if(s1&&!p1[i].bNoPossibleValue){if(g1.length>1){var j=0;while(j<g1.length-1){if(t1[j]&&t1[j+1]&&t1[j].getObject(B1)===t1[j+1].getObject(B1)){j++;}else{break;}}if(j===g1.length-1){b1.setParameter(w[i].$Name,t1[j].getObject(B1));}}else{if(t1[0]&&t1[0].getObject(B1)){b1.setParameter(w[i].$Name,t1[0].getObject(B1));}}}}var C1=p1.some(function(E1){if(E1.bLatePropertyError){return E1.bLatePropertyError;}});if(C1){var D1=C.getTranslatedText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY",c1);M.warning(D1,{contentWidth:"25em"});}}).catch();};if(x.getObject("$IsBound")&&g1.length>0){var k1=x.getObject("$Parameter"),l1=k1[0]&&k1[0].$Name;g1[0].requestObject().then(function(i){if(i){b1.setParameter(l1,i);}j1(l1);}).catch(function(i){L.error("Error while retrieving the parameter",i);});}else{j1();}},afterClose:function(){d1.destroy();}});V=a1.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");d1.setModel(x.getModel().oModel);d1.setModel(T,"paramsModel");d1.bindElement({path:"/",model:"paramsModel"});var e1=new J({});d1.setModel(e1,"mvfview");var f1=A+"(...)";var g1=P.aContexts||[];if(!g1.length){f1="/"+f1;}d1.bindElement({path:f1});if(y){y.addDependent(d1);}if(g1.length>0){d1.setBindingContext(g1[0]);}b1=d1.getObjectBinding();d1.open();});});}).catch(R);});}function p(A,P){var i=n(A);P=P||[];if(P.length>0){}return i;}function n(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function o(i,P,j,u){var A=i.getObject(P+"@com.sap.vocabularies.Common.v1.IsActionCritical"),v=A&&A.$Path;if(!v){return!!A;}var w=u&&u.getObject("$Parameter"),x=v&&v.split("/"),y=w&&w.length&&typeof w==="object"&&v&&j&&j.length;if(y){w.filter(function(z){var E=x&&x.indexOf(z.$Name);if(E>-1){x.splice(E,1);}});v=x.join("/");return j[0].getObject(v);}else if(v){return j[0].getObject(v);}}function q(A,P){var u=P.aContexts||[],v=P.model,E=m.getMessages().length||0,w=P.aActionParameters||[],x=P.actionName,O=P.fnOnSubmitted,y=P.fnOnResponse,I=P.bIsCreateAction,z=false,G;function H(i){return i.then(function(j){var Q=m.getMessages();if(Q.length>E&&Q[Q.length-1].type==="Error"){return{response:j,status:"rejected"};}return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function K(){if(w&&w.length){z=true;for(var j=0;j<w.length;j++){if(!w[j].value){switch(w[j].$Type){case"Edm.String":w[j].value="";break;case"Edm.Boolean":w[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":w[j].value=0;break;default:break;}}G.setParameter(w[j].$Name,w[j].value);}}}if(u.length){return new Promise(function(Q,R){var S=P.mBindingParameters,T=P.bGrouped,U=P.bReturnAsArray,V=P.bGetBoundContext,W=[],N,i,Y,Z=function(G,j,c1){K();Y=!T?"$auto."+j:G.getUpdateGroupId();N=V?G.execute(Y).then(function(){return G.getBoundContext();}):G.execute(Y);W.push(N);var d1=A.getSideEffectsService();if(c1&&c1.triggerActions&&c1.triggerActions.length){c1.triggerActions.forEach(function(e1){if(e1){d1.executeAction(e1,c1.context,Y);}});}if(c1&&c1.pathExpressions&&c1.pathExpressions.length>0){d1.requestSideEffects(c1.pathExpressions,c1.context,Y).then(function(){if(P.operationAvailableMap&&P.internalModelContext){C.setActionEnablement(P.internalModelContext,JSON.parse(P.operationAvailableMap),P.aContexts);}}).catch(function(e1){L.error("Error while requesting side effects",e1);});}},$=function(G,j,c1){var d1=new Promise(function(Q,R){var e1,f1=[];K();Y="apiMode"+j;N=V?G.execute(Y).then(function(){return G.getBoundContext();}):G.execute(Y);W.push(N);f1.push(N);var g1=A.getSideEffectsService();if(c1&&c1.triggerActions&&c1.triggerActions.length){c1.triggerActions.forEach(function(h1){if(h1){e1=g1.executeAction(h1,c1.context,Y);f1.push(e1);}});}if(c1&&c1.pathExpressions&&c1.pathExpressions.length>0){e1=g1.requestSideEffects(c1.pathExpressions,c1.context,Y);f1.push(e1);e1.then(function(){if(P.operationAvailableMap&&P.internalModelContext){C.setActionEnablement(P.internalModelContext,JSON.parse(P.operationAvailableMap),P.aContexts);}}).catch(function(h1){L.error("Error while requesting side effects",h1);});}v.submitBatch(Y);Promise.all(f1).then(function(){return Q();}).catch(function(){return Q();});});return d1;};function a1(u){(O||function e1(){})(W);function c1(e1,i){G=v.bindContext(x+"(...)",e1,S);return $(G,i,{context:e1,pathExpressions:P.additionalSideEffect&&P.additionalSideEffect.pathExpressions,triggerActions:P.additionalSideEffect&&P.additionalSideEffect.triggerActions});}var d1=Promise.resolve(undefined);var j=0;u.forEach(function(e1){var id=++j;d1=d1.then(function(){return c1(e1,id);});});d1.then(function(){b1();}).catch();}if(P.bObjectPage&&!T){a1(u);}else{for(i=0;i<u.length;i++){G=v.bindContext(x+"(...)",u[i],S);Z(G,u.length<=1?null:i,{context:u[i],pathExpressions:P.additionalSideEffect&&P.additionalSideEffect.pathExpressions,triggerActions:P.additionalSideEffect&&P.additionalSideEffect.triggerActions});}(O||function j(){})(W);b1();}function b1(){Promise.all(W.map(H)).then(function(j){var c1=[],d1=[],e1;for(e1=0;e1<j.length;e1++){if(j[e1].status==="rejected"){c1.push(j[e1].response);}if(j[e1].status==="resolved"){if(I&&z){j[e1].bConsiderDocumentModified=true;d1.push(j[e1]);}else{d1.push(j[e1].response);}}}if(!j||(j&&j.length===0)){R(true);}if(c1.length===0){if(U){Q(d1);}else{Q(d1[0]);}}else{R({resolvedItems:d1,rejectedItems:c1});}}).catch(R);}}).finally(function(){(y||function i(){})();});}else{var N;G=v.bindContext("/"+x+"(...)");K();N=G.execute("actionImport");v.submitBatch("actionImport");(O||function i(){})(N);return N.finally(function(){(y||function i(){})();});}}function r(A,i){var P=A.getPath();P=A.getObject("$IsBound")?P.split("@$ui5.overload")[0]:P.split("/0")[0];return P.split("/"+i)[0];}var t={callBoundAction:e,callActionImport:f,callBoundFunction:g,callFunctionImport:h};return t;});
