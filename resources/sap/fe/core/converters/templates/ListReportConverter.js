/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["../ManifestSettings","../controls/Common/DataVisualization","../helpers/ID","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingExpression","../controls/Common/KPI","sap/fe/core/converters/controls/ListReport/FilterBar"],function(M,D,I,A,C,B,K,a){"use strict";var _={};var g=a.getFilterBarhideBasicSearch;var b=a.getManifestFilterFields;var c=a.getSelectionFields;var d=K.getKPIDefinitions;var f=B.compileBinding;var h=B.annotationExpression;var j=C.insertCustomElements;var k=A.getActionsFromManifest;var l=I.IconTabBarID;var m=I.ChartID;var T=I.TableID;var p=I.FilterVariantManagementID;var q=I.FilterBarID;var r=I.CustomTabID;var s=D.isSelectionPresentationCompliant;var t=D.getSelectionVariant;var u=D.isPresentationCompliant;var v=D.getSelectionPresentationVariant;var w=D.getDefaultPresentationVariant;var x=D.getDefaultLineItem;var y=D.getDefaultChart;var z=D.getDataVisualizationConfiguration;var V=M.VariantManagementType;var E=M.TemplateType;var G=M.VisualizationType;function H(e){return N(e)||L(e)||P(e)||J();}function J(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function L(i){if(typeof Symbol!=="undefined"&&i[Symbol.iterator]!=null||i["@@iterator"]!=null)return Array.from(i);}function N(e){if(Array.isArray(e))return Q(e);}function O(o,n){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=P(o))||n&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function(){};return{s:F,n:function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function(e){throw e;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var d1=true,e1=false,f1;return{s:function(){it=it.call(o);},n:function(){var e=it.next();d1=e.done;return e;},e:function(e){e1=true;f1=e;},f:function(){try{if(!d1&&it.return!=null)it.return();}finally{if(e1)throw f1;}}};}function P(o,e){if(!o)return;if(typeof o==="string")return Q(o,e);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Q(o,e);}function Q(e,n){if(n==null||n>e.length)n=e.length;for(var i=0,o=new Array(n);i<n;i++){o[i]=e[i];}return o;}function R(e){var i=[];e.forEach(function(n){if(!n.type){var o=n.secondaryVisualization?n.secondaryVisualization.visualizations:n.presentation.visualizations;o.forEach(function(F){if(F.type===G.Table){i.push(F);}});}});return i;}function S(e){var i=[];e.forEach(function(n){if(!n.type){var o=n.primaryVisualization?n.primaryVisualization.visualizations:n.presentation.visualizations;o.forEach(function(F){if(F.type===G.Chart){i.push(F);}});}});return i;}var U=function(e){var i={};for(var n in e){var o,F,d1;if((o=e[n])!==null&&o!==void 0&&(F=o.settings)!==null&&F!==void 0&&(d1=F.defaultValues)!==null&&d1!==void 0&&d1.length){var e1,f1;i[n]=(e1=e[n])===null||e1===void 0?void 0:(f1=e1.settings)===null||f1===void 0?void 0:f1.defaultValues;}}return i;};function W(e,i,n){var o=i.getManifestWrapper().getDefaultTemplateAnnotationPath();var F=v(e,o,i);if(o&&F){var d1=F.PresentationVariant;if(!d1){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest");}var e1=u(F.PresentationVariant);if(!e1){return undefined;}if(s(F,n)){return F;}}if(F){if(s(F,n)){return F;}}var f1=w(e);if(f1){if(u(f1,n)){return f1;}}if(!n){var g1=x(e);if(g1){return g1;}}return undefined;}var X=function(e){var i=e;if(i.converterContext){var n,o;var F=i.converterContext;i=i;var d1=z(i.annotation?F.getRelativeAnnotationPath(i.annotation.fullyQualifiedName,F.getEntityType()):"",true,F,i);var e1="";var f1="";var g1="";var h1="";var i1=function(i){return i.key!==undefined;};var j1=function(d1,x1){var y1;var z1=O(d1.visualizations),A1;try{for(z1.s();!(A1=z1.n()).done;){var B1=A1.value;if(x1&&B1.type===G.Chart){y1=B1;break;}if(!x1&&B1.type===G.Table){y1=B1;break;}}}catch(C1){z1.e(C1);}finally{z1.f();}var D1=Object.assign({},d1);if(y1){D1.visualizations=[y1];}return D1;};var k1=function(x1){var r1=F.getEntityTypeAnnotation(x1.annotationPath);var y1=r1.annotation;F=r1.converterContext;var z1=y1;d1=z(z1?F.getRelativeAnnotationPath(z1.fullyQualifiedName,F.getEntityType()):"",true,F,i);return d1;};var l1=function(x1,y1){var z1=j1(x1[0],true);f1=(z1===null||z1===void 0?void 0:z1.visualizations[0]).id;var A1=j1(x1[1]?x1[1]:x1[0]);e1=(A1===null||A1===void 0?void 0:A1.visualizations[0]).annotation.id;if(z1&&A1){var m1={primaryVisualization:z1,secondaryVisualization:A1,tableControlId:e1,chartControlId:f1,defaultPath:y1};return m1;}};if(((n=d1)===null||n===void 0?void 0:(o=n.visualizations)===null||o===void 0?void 0:o.length)===2&&F.getTemplateType()===E.AnalyticalListPage){var m1=l1([d1],"both");if(m1){return m1;}}else if(F.getManifestWrapper().hasMultipleVisualizations(i)||F.getTemplateType()===E.AnalyticalListPage){var n1=i,o1=n1.primary,p1=n1.secondary;if(o1&&o1.length&&p1&&p1.length){var q1=l1([k1(o1[0]),k1(p1[0])],i.defaultPath);if(q1){return q1;}}else{throw new Error("SecondaryItems in the Views is not present");}}else if(i1(i)){var r1=F.getEntityTypeAnnotation(i.annotationPath);var s1=r1.annotation;F=r1.converterContext;g1=f(h(s1.Text));d1.visualizations.forEach(function(x1,y1){switch(x1.type){case G.Table:var z1=d1.visualizations[y1];var A1=z1.control.filters||{};A1.hiddenFilters=A1.hiddenFilters||{paths:[]};if(!i.keepPreviousPresonalization){z1.annotation.id=T(i.key||"","LineItem");}i=i;if(i&&i.annotation&&i.annotation.term==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){h1=i.annotation.SelectionVariant.fullyQualifiedName.split("@")[1];}else{h1=i.annotationPath;}A1.hiddenFilters.paths.push({annotationPath:h1});z1.control.filters=A1;break;case G.Chart:var B1=d1.visualizations[y1];B1.id=m(i.key||"","Chart");break;default:break;}});}d1.visualizations.forEach(function(x1){if(x1.type===G.Table){e1=x1.annotation.id;}else if(x1.type===G.Chart){f1=x1.id;}});return{presentation:d1,tableControlId:e1,chartControlId:f1,title:g1,selectionVariantPath:h1};}else{i=i;var t1=i.label,u1=i.template,v1=i.type,w1=r(i.key||"");return{title:t1,fragment:u1,type:v1,customTabId:w1};}};var Y=function(e,i){var n=[];if(i){i.paths.forEach(function(F){if(e.getManifestWrapper().hasMultipleVisualizations(F)){if(i.paths.length>1){throw new Error("ALP flavor cannot have multiple views");}else{F=F;n.push({converterContext:e,primary:F.primary,secondary:F.secondary,defaultPath:F.defaultPath});}}else if(F.template){F=F;n.push({key:F.key,label:F.label,template:F.template,type:"Custom"});}else{F=F;var d1=e.getManifestWrapper(),e1=e.getConverterContextFor(F.contextPath||F.entitySet&&"/"+F.entitySet||e.getContextPath()),o=e1.getEntityType();if(o&&e1){var f1=d1.getDefaultTemplateAnnotationPath();var g1;var h1=e1.getEntityTypeAnnotation(F.annotationPath);var i1=h1.annotation;var j1=h1.converterContext;if(i1){if(i1.term==="com.sap.vocabularies.UI.v1.SelectionVariant"){if(f1){g1=v(e1.getEntityType(),f1,j1);}else{g1=x(e1.getEntityType());}}else{g1=i1;}n.push({converterContext:e1,annotation:g1,annotationPath:F.annotationPath,keepPreviousPresonalization:F.keepPreviousPresonalization,key:F.key});}}else{}}});}else{var o=e.getEntityType();if(e.getTemplateType()===E.AnalyticalListPage){n=Z(e,n);}else{n.push({annotation:W(o,e,false),converterContext:e});}}return n.map(function(F){return X(F);});};function Z(e,i){var n=e.getEntityType();var o=W(n,e,true);var F,d1;if(o){i.push({annotation:o,converterContext:e});}else{F=y(n);d1=x(n);if(F&&d1){var e1=[{annotationPath:F.term}];var f1=[{annotationPath:d1.term}];i.push({converterContext:e,primary:e1,secondary:f1,defaultPath:"both"});}}return i;}var $=function(e){var i=e.getManifestWrapper();return j([],k(i.getHeaderActions(),e));};_.getHeaderActions=$;var a1=function(e,i){e.forEach(function(n){if(!n.type){var o=n.presentation;o.visualizations.forEach(function(F){if(F.type===G.Chart&&F.filterId!==i){F.filterId=i;}});}});};_.checkChartFilterBarId=a1;var b1=function(e){var i=e.getEntityType();var n=e.getContextPath();if(!n){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.");}var o=e.getManifestWrapper();var F=o.getViewConfiguration();var d1=o.hasMultipleEntitySets();var e1=Y(e,F);var f1=F?(F===null||F===void 0?void 0:F.showCounts)||d1:undefined;var g1=R(e1);var h1=S(e1);var i1=g1.some(function(A1){return A1.control.type==="ResponsiveTable";});var j1="";var k1="";var l1=q(n);var m1=p(l1);var n1=o.getFilterConfiguration();var o1=(n1===null||n1===void 0?void 0:n1.initialLayout)!==undefined?n1===null||n1===void 0?void 0:n1.initialLayout.toLowerCase():"compact";var p1=(n1===null||n1===void 0?void 0:n1.layout)!==undefined?n1===null||n1===void 0?void 0:n1.layout.toLowerCase():"compact";var q1=n1.useSemanticDateRange!==undefined?n1.useSemanticDateRange:true;var r1=c1(e,e1);if(r1){k1=r1.chartId;j1=r1.tableId;}var s1=c(e,g1);var t1=g(g1,e);var u1=t(i,e);var v1=q1?U(b(i,e)):{};var w1=$(e);var x1=o.hasMultipleVisualizations()||e.getTemplateType()===E.AnalyticalListPage;if(d1){a1(e1,l1);}var y1=g1.map(function(A1){return A1.annotation.id;}).concat(h1.map(function(A1){return A1.id;}));var z1=[l1].concat(H(o.getVariantManagement()!==V.Control?y1:[]),H(!x1&&e1.length>1?[l()]:[]));return{mainEntitySet:n,mainEntityType:n+"/",singleTableId:j1,singleChartId:k1,showTabCounts:f1,headerActions:w1,showPinnableToggle:i1,filterBar:{selectionFields:s1,hideBasicSearch:t1},views:e1,filterBarId:l1,filterConditions:{selectionVariant:u1,defaultSemanticDates:v1},variantManagement:{id:m1,targetControlIds:z1.join(",")},isMultiEntitySets:d1,hasMultiVisualizations:x1,templateType:o.getTemplateType(),useSemanticDateRange:q1,filterInitialLayout:o1,filterLayout:p1,kpiDefinitions:d(e)};};_.convertPage=b1;function c1(e,i){var n="",o="";if(e.getManifestWrapper().hasMultipleVisualizations()||e.getTemplateType()===E.AnalyticalListPage){var F=O(i),d1;try{for(F.s();!(d1=F.n()).done;){var e1=d1.value;e1=e1;if(e1.chartControlId&&e1.tableControlId){o=e1.chartControlId;n=e1.tableControlId;break;}}}catch(f1){F.e(f1);}finally{F.f();}}else{var g1=O(i),h1;try{for(g1.s();!(h1=g1.n()).done;){var i1=h1.value;i1=i1;if(!n&&i1.tableControlId){n=i1.tableControlId||"";}if(!o&&i1.chartControlId){o=i1.chartControlId||"";}if(o&&n){break;}}}catch(f1){g1.e(f1);}finally{g1.f();}}if(n||o){return{chartId:o,tableId:n};}return undefined;}return _;},false);
