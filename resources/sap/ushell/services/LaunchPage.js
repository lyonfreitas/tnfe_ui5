// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/services/ContentExtensionAdapterFactory","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/ushell/services/_AppState/AppStatePersistencyMethod","sap/ushell/Config","sap/m/library","sap/m/GenericTile"],function(L,C,q,r,A,a,m,G){"use strict";var b=m.LoadState;function c(o){var t=this,T=[],d=C.getAdapters();this.oAdapters={default:o};d.then(function(e){q.extend(this.oAdapters,e);}.bind(this));this.getGroups=function(){if(a.last("/core/spaces/enabled")){return new q.Deferred().resolve([]).promise();}var D=new q.Deferred();d.then(function(){var e=Object.keys(t.oAdapters).map(function(s){return t._getAdapter(s).getGroups();});q.when.apply(q,e).done(function(){var f=[].concat.apply([],arguments);D.resolve(f);}).fail(function(){L.error("getGroups failed");});});return D.promise();};this.getGroupsForBookmarks=function(e){var D=new q.Deferred();this.getGroups().then(function(f){this.getDefaultGroup().then(function(h){if(f.length>0){f=f.filter(function(i){if(e===true){return this.isGroupVisible(i);}return!this.isGroupLocked(i)&&this.isGroupVisible(i);}.bind(this));f=f.map(function(i){return{title:(i===h&&r.i18n.getText("my_group"))||this.getGroupTitle(i),object:i};}.bind(this));}D.resolve(f);}.bind(this),function(E){L.error("getGroupsForBookmarks - getDefaultGroup - failed: "+E.message);});}.bind(this),function(E){L.error("getGroupsForBookmarks - getGroups - failed: "+E.message);});return D.promise();};this.getDefaultGroup=function(){var p=this._getAdapter().getDefaultGroup();p.fail(function(){L.error("getDefaultGroup failed");});return p;};this.getGroupTitle=function(e){return this._getAdapter(e.contentProvider).getGroupTitle(e);};this.getGroupId=function(e){return this._getAdapter(e.contentProvider).getGroupId(e);};this.getGroupById=function(s){var D=new q.Deferred(),t=this;this.getGroups().then(function(e){e=q.grep(e,function(f){return t.getGroupId(f)===s;});D.resolve((e&&e.length>0?e[0]:undefined));});return D.promise();};this.getGroupTiles=function(e){return this._getAdapter(e.contentProvider).getGroupTiles(e);};this.getTilesByGroupId=function(s){var D=new q.Deferred(),t=this;this.getGroupById(s).then(function(e){if(e){var f=t._getAdapter(e.contentProvider).getGroupTiles(e);if(f){f=f.map(function(h){return{id:t.getTileId(h),title:t.getTileTitle(h),subtitle:t.getCatalogTilePreviewSubtitle(h),url:t.getCatalogTileTargetURL(h),icon:t.getCatalogTilePreviewIcon(h),groupId:s};});}else{f=[];}D.resolve(f);}else{D.resolve([]);}});return D.promise();};this.getLinkTiles=function(e){return this._getAdapter(e.contentProvider).getLinkTiles(e);};this.addGroupAt=function(s,i){var p,e=i,o=this._getAdapter();if(o.addGroupAt){p=o.addGroupAt(s,i);p.fail(function(){L.error("addGroup "+s+" failed");});}else{var D=new q.Deferred();p=o.addGroup(s);p.done(function(n){var f=this.moveGroup(n,e),h=n;f.done(function(){D.resolve(h);});f.fail(function(){D.reject();});}.bind(this));p.fail(function(){L.error("addGroup "+s+" failed");D.reject();});return D.promise();}return p;};this.addGroup=function(s){var p=this._getAdapter().addGroup(s);p.fail(function(){L.error("addGroup "+s+" failed");});return p;};this.removeGroup=function(e,i){var p=this._getAdapter(e.contentProvider).removeGroup(e,i);p.fail(function(){L.error("Fail to removeGroup "+t.getGroupTitle(e));});return p;};this.resetGroup=function(e,i){var p=this._getAdapter(e.contentProvider).resetGroup(e,i);p.fail(function(){L.error("Fail to resetGroup "+t.getGroupTitle(e));});return p;};this.isGroupRemovable=function(e){return this._getAdapter(e.contentProvider).isGroupRemovable(e);};this.isGroupLocked=function(e){var o=this._getAdapter(e.contentProvider);if(typeof o.isGroupLocked==="function"){return o.isGroupLocked(e);}return false;};this.isGroupFeatured=function(e){var o=this._getAdapter(e.contentProvider);if(typeof o.isGroupFeatured==="function"){return o.isGroupFeatured(e);}return false;};this.moveGroup=function(e,n){var p=this._getAdapter(e.contentProvider).moveGroup(e,n);p.fail(function(){L.error("Fail to moveGroup "+t.getGroupTitle(e));});return p;};this.setGroupTitle=function(e,s){var p=this._getAdapter(e.contentProvider).setGroupTitle(e,s);p.fail(function(){L.error("Fail to set Group title: "+t.getGroupTitle(e));});return p;};this.hideGroups=function(h){var D=new q.Deferred(),o=this._getAdapter();if(typeof o.hideGroups!=="function"){D.reject("hideGroups() is not implemented in the Adapter.");}else{o.hideGroups(h).done(function(){D.resolve();}).fail(function(M){L.error("Fail to store groups visibility."+M);D.reject();});}return D.promise();};this.isGroupVisible=function(e){var o=this._getAdapter(e.contentProvider);if(typeof o.isGroupVisible==="function"){return o.isGroupVisible(e);}return true;};this.addTile=function(e,f){return this._getAdapter(f.contentProvider).addTile(e,f).fail(function(){L.error("Fail to add Tile: "+t.getCatalogTileId(e));});};this.removeTile=function(e,f,i){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("AppState").then(function(h){this._getAdapter(e.contentProvider).removeTile(e,f,i).done(function(){var s=this.getCatalogTileTargetURL(f);this.deleteURLStatesPersistentData(s,h);D.resolve();}.bind(this)).fail(function(j){L.error("Fail to remove Tile: "+this.getTileId(f));D.reject(j);}.bind(this));}.bind(this)).catch(D.reject);return D.promise();};this.moveTile=function(e,s,i,S,f,n){var p=this._getAdapter().moveTile(e,s,i,S,f,n);p.fail(function(){L.error("Fail to move Tile: "+t.getTileId(e));});return p;};this.isLinkPersonalizationSupported=function(e){var s=e&&e.contentProvider,o=this._getAdapter(s);if(typeof o.isLinkPersonalizationSupported==="function"){return o.isLinkPersonalizationSupported(e);}return false;};this.getTileId=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getTileId(e);};this.getTileTitle=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getTileTitle(e);};this.getTileType=function(e){var s=e&&e.contentProvider,o=this._getAdapter(s);if(o.getTileType){return o.getTileType(e);}return"tile";};this.getTileView=function(e){var s=e&&e.contentProvider,D=this._getAdapter(s).getTileView(e);if(!q.isFunction(D.promise)){D=new q.Deferred().resolve(D).promise();}return D;};this.getCardManifest=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCardManifest(e);};this.getAppBoxPressHandler=function(e){var s=e&&e.contentProvider,o=this._getAdapter(s);if(o.getAppBoxPressHandler){return o.getAppBoxPressHandler(e);}return undefined;};this.getTileSize=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getTileSize(e);};this.getTileTarget=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getTileTarget(e);};this.getTileDebugInfo=function(e){var s=e&&e.contentProvider,o=this._getAdapter(s);if(typeof o.getTileDebugInfo==="function"){return o.getTileDebugInfo(e);}return undefined;};this.isTileIntentSupported=function(e){var s=e&&e.contentProvider,o=this._getAdapter(s);if(typeof o.isTileIntentSupported==="function"){return o.isTileIntentSupported(e);}return true;};this.refreshTile=function(e){var s=e&&e.contentProvider;this._getAdapter(s).refreshTile(e);};this.setTileVisible=function(e,n){var s=e&&e.contentProvider;return this._getAdapter(s).setTileVisible(e,n);};this.registerTileActionsProvider=function(p){if(typeof p!=="function"){throw new Error("Tile actions Provider is not a function");}T.push(p);};this.getTileActions=function(e){var f=[],h,s=e&&e.contentProvider,o=this._getAdapter(s);if(typeof o.getTileActions==="function"){h=o.getTileActions(e);if(h&&h.length&&h.length>0){f.push.apply(f,h);}}for(var i=0;i<T.length;i++){h=T[i](e);if(h&&h.length&&h.length>0){f.push.apply(f,h);}}return f;};this.getCatalogs=function(){return this._getAdapter().getCatalogs();};this.isCatalogsValid=function(){return this._getAdapter().isCatalogsValid();};this.getCatalogData=function(e){var l=this._getAdapter();if(typeof l.getCatalogData!=="function"){L.warning("getCatalogData not implemented in adapter",null,"sap.ushell.services.LaunchPage");return{id:this.getCatalogId(e)};}return l.getCatalogData(e);};this.getCatalogError=function(e){return this._getAdapter().getCatalogError(e);};this.getCatalogId=function(e){return this._getAdapter().getCatalogId(e);};this.getCatalogTitle=function(e){return this._getAdapter().getCatalogTitle(e);};this.getCatalogTiles=function(e){var p=this._getAdapter().getCatalogTiles(e);p.fail(function(){L.error("Fail to get Tiles of Catalog: "+t.getCatalogTitle(e));});return p;};this.getCatalogTileId=function(e){return this._getAdapter(e.contentProvider).getCatalogTileId(e);};this.getCatalogTileTitle=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCatalogTileTitle(e);};this.getCatalogTileSize=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCatalogTileSize(e);};this.getCatalogTileViewControl=function(e){var s=e&&e.contentProvider;var l=this._getAdapter(s);if(typeof l.getCatalogTileViewControl==="function"){return l.getCatalogTileViewControl(e);}var D=new q.Deferred();var R=this.getCatalogTileView(e);D.resolve(R);return D.promise();};this.getCatalogTileView=function(e){L.error("Deprecated API call of 'sap.ushell.LaunchPage.getCatalogTileView'. Please use 'getCatalogTileViewControl' instead",null,"sap.ushell.services.LaunchPage");var s=e&&e.contentProvider;var l=this._getAdapter(s);if(l.getCatalogTileView){return l.getCatalogTileView(e);}var f=this.getTileTitle(e)||this.getCatalogTileTitle(e);return this._createErrorTile(f,"The LaunchPageAdapter does not support getCatalogTileView");};this._createErrorTile=function(s,M){var e=new G({state:b.Failed,header:s,subheader:M||""}).addStyleClass("sapUshellTileError");return e;};this.getCatalogTileTargetURL=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCatalogTileTargetURL(e);};this.getCatalogTileTags=function(e){var s=e&&e.contentProvider;var l=this._getAdapter(s);if(typeof l.getCatalogTileTags==="function"){return l.getCatalogTileTags(e);}return[];};this.getCatalogTileKeywords=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCatalogTileKeywords(e);};this.getCatalogTilePreviewTitle=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCatalogTilePreviewTitle(e);};this.getCatalogTilePreviewInfo=function(e){var s=e&&e.contentProvider;if(this._getAdapter(s).getCatalogTilePreviewInfo){return this._getAdapter(s).getCatalogTilePreviewInfo(e);}return"";};this.getCatalogTilePreviewSubtitle=function(e){var s=e&&e.contentProvider;var l=this._getAdapter(s);if(l.getCatalogTilePreviewSubtitle){return l.getCatalogTilePreviewSubtitle(e);}};this.getCatalogTilePreviewIcon=function(e){var s=e&&e.contentProvider;return this._getAdapter(s).getCatalogTilePreviewIcon(e);};this.addBookmark=function(p,e,s){var D=new q.Deferred();if(this._hasRequiredBookmarkParameters(p)){if(e&&this.isGroupLocked(e)){var M="Tile cannot be added, target group ("+this.getGroupTitle(e)+")is locked!";L.error(M);return D.reject(M);}this.changeURLStatesToPersistent(p.url).done(function(n){var f=e&&e.contentProvider;p.url=n;this._getAdapter(f).addBookmark(p,e,s).done(D.resolve).fail(function(){L.error("Fail to add bookmark for URL: "+p.url+" and Title: "+p.title);D.reject();});}.bind(this)).fail(function(f){L.error(f||"Fail to change url states to persistent: "+p.url);D.reject();});}return D.promise();};this.addCustomBookmark=function(B,e,s){var D=new q.Deferred();if(this._hasRequiredBookmarkParameters(B)){if(e&&this.isGroupLocked(e)){var M="Tile cannot be added, target group ("+this.getGroupTitle(e)+")is locked!";L.error(M);return D.reject(M);}this.changeURLStatesToPersistent(B.url).done(function(n){var f=e&&e.contentProvider;B.url=n;this._getAdapter(f).addCustomBookmark(B,e,s).done(D.resolve).fail(function(){L.error("Fail to add bookmark for URL: "+B.url+" and Title: "+B.title);D.reject();});}.bind(this)).fail(function(f){L.error(f||"Fail to change url states to persistent: "+B.url);D.reject();});}return D.promise();};this._hasRequiredBookmarkParameters=function(p){if(!p.title){L.error("Add Bookmark - Missing title");throw new Error("Title missing in bookmark configuration");}if(!p.url){L.error("Add Bookmark - Missing URL");throw new Error("URL missing in bookmark configuration");}return true;};this.countBookmarks=function(u,s){if(!u||typeof u!=="string"){L.error("Fail to count bookmarks. No valid URL");throw new Error("Missing URL");}var p=this._getAdapter().countBookmarks(u,s);p.fail(function(){L.error("Fail to count bookmarks");});return p;};this.countCustomBookmarks=function(i){if(!i.url||!i.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.");}return this._getAdapter().countCustomBookmarks(i);};this.deleteBookmarks=function(u,s){var D=new q.Deferred();if(!u||typeof u!=="string"){return D.reject(new Error("Missing URL")).promise();}sap.ushell.Container.getServiceAsync("AppState").then(function(e){this._getAdapter().deleteBookmarks(u,undefined,s).done(function(i){this.deleteURLStatesPersistentData(u,e);D.resolve(i);}.bind(this)).fail(function(f){L.error("Fail to delete bookmark for: "+u);D.reject(f);});}.bind(this)).catch(D.reject);return D.promise();};this.deleteCustomBookmarks=function(i){if(!i.url||!i.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.");}return this._getAdapter().deleteCustomBookmarks(i);};this.updateBookmarks=function(u,p,s){if(!u||typeof u!=="string"){L.error("Fail to update bookmark. No valid URL");throw new Error("Missing URL");}if(!p||typeof p!=="object"){L.error("Fail to update bookmark. No valid parameters, URL is: "+u);throw new Error("Missing parameters");}var P=new q.Deferred();this.changeURLStatesToPersistent(p.url).done(function(n){p.url=n;this._getAdapter().updateBookmarks(u,p,undefined,s).done(P.resolve).fail(function(){L.error("Fail to update bookmark for: "+u);P.reject();});}.bind(this)).fail(function(M){L.error(M||"Fail to change url states to persistent: "+p.url);P.reject();});return P.promise();};this.updateCustomBookmarks=function(i,B){if(!i.url||!i.vizType||!B){return Promise.reject("updateCustomBookmarks: Some required parameters are missing.");}return this._getAdapter().updateCustomBookmarks(i,B);};this.onCatalogTileAdded=function(s){return this._getAdapter().onCatalogTileAdded(s);};this.changeURLStatesToPersistent=function(u){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("AppState").then(function(f){if(f.getSupportedPersistencyMethods().length===0){D.resolve(u);return;}if(u&&u.length>0){try{f.setAppStateToPublic(u).done(D.resolve).fail(D.reject);}catch(e){L.error("error in converting transient state to personal persistent when bookmark is added",e,"sap.ushell.services.LaunchPage");D.reject();}}else{D.resolve(u);}});return D.promise();};this.deleteURLStatesPersistentData=function(u,f){if(f.getSupportedPersistencyMethods().length===0){return;}if(u&&u.length>0){try{var x=g(u,"sap-xapp-state"),i=g(u,"sap-iapp-state");if(x!==undefined||i!==undefined){this.countBookmarks(u).done(function(h){if(h===0){if(x!==undefined){f.deleteAppState(x);}if(i!==undefined){f.deleteAppState(i);}}});}}catch(e){L.error("error in deleting persistent state when bookmark is deleted",e,"sap.ushell.services.LaunchPage");}}};function g(u,p){var R=new RegExp("(?:"+p+"=)([^&/]+)"),s=R.exec(u),v;if(s&&s.length===2){v=s[1];}return v;}}c.prototype._getAdapter=function(s){return this.oAdapters[s]||this.oAdapters.default;};c.hasNoAdapter=false;return c;},true);
