// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/services/_CrossApplicationNavigation/utils","sap/ushell/utils/type","sap/ushell/TechnicalParameters","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/base/util/isPlainObject","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/merge","sap/ushell/utils","sap/ushell/ApplicationType","sap/ushell/UI5ComponentType","sap/base/Log","sap/ushell/utils/UrlParsing"],function(a,u,t,T,A,i,U,q,O,m,b,c,d,L,e){"use strict";function C(o,p,s){var S;if(s&&s.config){S=s.config;}function g(v,h){var r,j,n,k,l;if(typeof v!=="string"&&!i(v)&&v!==undefined){L.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(v===undefined){return undefined;}r=a.getCurrentApplication();if(h){if(typeof h.getComponentData!=="function"||!i(h.getComponentData())||!h.getComponentData().startupParameters||!i(h.getComponentData().startupParameters)){L.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation");}else{l=h.getComponentData().startupParameters;if(l.hasOwnProperty("sap-system")){j=l["sap-system"][0];}if(l.hasOwnProperty("sap-ushell-next-navmode")){n=l["sap-ushell-next-navmode"][0];}}}else{if(r&&r["sap-system"]){j=r["sap-system"];}else if(r&&r.url){j=new U(r.url).get("sap-system");}if(r&&r["sap-ushell-next-navmode"]){n=r["sap-ushell-next-navmode"];}else if(r&&r.url){n=new U(r.url).get("sap-ushell-next-navmode");}}if(r){k=r.contentProviderId;}var I=u._injectParameters({type:t,inject:{"sap-system":j,"sap-ushell-navmode":n,"sap-app-origin-hint":k},injectEmptyString:{"sap-app-origin-hint":true},args:v});return I;}function f(v){var h,j,k;if(localStorage&&localStorage["sap-ushell-enc-test"]==="false"){return v;}if(!S||!S["sap-ushell-enc-test"]){if(localStorage&&localStorage["sap-ushell-enc-test"]!=="true"){return v;}}if(typeof v!=="string"&&!i(v)&&v!==undefined){L.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(v===undefined){return undefined;}if(i(v)){j=q.extend(true,{},v);if(j.target&&j.target.shellHash){if(typeof j.target.shellHash==="string"){if(j.target.shellHash!=="#"&&j.target.shellHash!==""){j.target.shellHash=f(j.target.shellHash);}}return j;}j.params=j.params||{};j.params["sap-ushell-enc-test"]=["A B%20C"];return j;}k=v;if(!/[?&]sap-system=/.test(k)){h=(k.indexOf("?")>-1)?"&":"?";k+=h+"sap-ushell-enc-test="+encodeURIComponent("A B%20C");}return k;}this._extractInnerAppRoute=function(I){var h=this,P,j;if(typeof I==="string"){P=I.split("&/");j=P.shift();return{intent:j,innerAppRoute:P.length>0?"&/"+P.join("&/"):""};}if(Object.prototype.toString.apply(I)==="[object Object]"){var k=O.get("target.shellHash",I);if(typeof k==="string"){var r=h._extractInnerAppRoute(k);I.target.shellHash=r.intent;return{intent:I,innerAppRoute:r.innerAppRoute};}if(I.hasOwnProperty("appSpecificRoute")){var v=I.appSpecificRoute;delete I.appSpecificRoute;var l=typeof v==="string"&&v.indexOf("&/")!==0&&v.length>0;return{innerAppRoute:l?"&/"+v:v,intent:I};}return{intent:I,innerAppRoute:""};}L.error("Invalid input parameter","expected string or object","sap.ushell.services.CrossApplicationNavigation");return{intent:I};};this._injectInnerAppRoute=function(I,h){var j,k=this;if(!h){return I;}if(typeof I==="string"){return I+h;}if(Object.prototype.toString.apply(I)==="[object Object]"){j=O.get("target.shellHash",I);if(typeof j==="string"){I.target.shellHash=k._injectInnerAppRoute(j,h);return I;}I.appSpecificRoute=h;}return I;};this.hrefForExternal=function(h,j,k){if(k){var D=new q.Deferred();this.hrefForExternalAsync(h,j).then(D.resolve).catch(D.reject);return D.promise();}L.error("Deprecated option 'bAsync=false'. Please use 'bAsync=true' instead",null,"sap.ushell.services.CrossApplicationNavigation");var l=m({},h);var E=this._extractInnerAppRoute(l);var I=E.intent;u.addXAppStateFromParameter(I,"sap-xapp-state-data");l=g(I,j);l=u.injectStickyParameters({args:l,appLifeCycle:A,technicalParameters:T,type:t});l=f(l);l=this._injectInnerAppRoute(l,E.innerAppRoute);var n=sap.ushell.Container.getService("ShellNavigation");if(!n){L.debug("Shell not available, no Cross App Navigation");return"";}return n.hrefForExternal(l,undefined,j,k);};this.hrefForExternalAsync=function(h,j){var k=m({},h);var E=this._extractInnerAppRoute(k);var I=E.intent;return Promise.resolve().then(function(){return u.addXAppStateFromParameterAsync(I,"sap-xapp-state-data");}).then(function(){k=g(I,j);return u.injectStickyParametersAsync({args:k,appLifeCycle:A,technicalParameters:T,type:t});}).then(function(l){k=l;k=f(k);k=this._injectInnerAppRoute(k,E.innerAppRoute);return sap.ushell.Container.getServiceAsync("ShellNavigation");}.bind(this)).then(function(l){return new Promise(function(r,n){l.hrefForExternal(k,undefined,j,true).done(r).fail(n);});}).catch(function(){L.debug("Shell not available, no Cross App Navigation");return"";});};this.expandCompactHash=function(h){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(N){N.expandCompactHash(h).done(D.resolve).fail(D.reject);});return D.promise();};this.backToPreviousApp=function(){return this.isInitialNavigationAsync().then(function(I){if(I){return this.toExternal({target:{shellHash:"#"},writeHistory:false});}this.historyBack();}.bind(this));};this.historyBack=function(h){var j=-1;if(h&&typeof h==="number"){if(h<=0){L.warning("historyBack called with an argument <= 0 and will result in a forward navigation or refresh","expected was an argument > 0","sap.ushell.services.CrossApplicationNavigation#historyBack");}j=h*-1;}window.history.go(j);};this.isInitialNavigation=function(){L.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.isInitialNavigation'. Please use 'isInitialNavigationAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var h=sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation");if(!h){L.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true;}var I=h.isInitialNavigation();if(typeof I==="undefined"){return true;}return I;};this.isInitialNavigationAsync=function(){return sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(h){var I=h.isInitialNavigation();if(typeof I==="undefined"){return true;}return I;}).catch(function(){L.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true;});};this.toExternal=function(h,j){var w=h.writeHistory;var k=m({},h);this._processShellHashWithParams(k);var E=this._extractInnerAppRoute(k);var I=E.intent;return Promise.resolve().then(function(){return u.addXAppStateFromParameterAsync(I,"sap-xapp-state-data");}).then(function(){k=g(I,j);return u.injectStickyParametersAsync({args:k,appLifeCycle:A,technicalParameters:T,type:t});}).then(function(l){k=l;k=f(k);delete k.writeHistory;k=this._injectInnerAppRoute(k,E.innerAppRoute);return sap.ushell.Container.getServiceAsync("ShellNavigation");}.bind(this)).then(function(l){return l.toExternal(k,j,w);}).catch(function(l){L.warning("Shell not available, no Cross App Navigation");});};this.hrefForAppSpecificHash=function(h){L.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.hrefForAppSpecificHash'. Please use 'hrefForAppSpecificHashAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){return sap.ushell.Container.getService("ShellNavigation").hrefForAppSpecificHash(h);}L.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(h);};this.hrefForAppSpecificHashAsync=function(h){return sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(j){return j.hrefForAppSpecificHash(h);}).catch(function(){L.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(h);});};this.getPrimaryIntent=function(h,P){var Q={},j,r=/^#\w+-displayFactSheet(?:$|\?.)/;Q.tags=["primaryAction"];Q.semanticObject=h;if(P){Q.params=P;}return this.getLinks(Q).then(function(l){if(l.length===0){delete Q.tags;Q.action="displayFactSheet";j=function(k,n){var E;if(k.intent===n.intent){return 0;}E=r.test(k.intent)^r.test(n.intent);if(E){return r.test(k.intent)?-1:1;}return k.intent<n.intent?-1:1;};return this.getLinks(Q);}j=function(k,n){if(k.intent===n.intent){return 0;}return k.intent<n.intent?-1:1;};return l;}.bind(this)).then(function(l){return l.length===0?null:l.sort(j)[0];});};this.getSemanticObjectLinks=function(h,P,I,j,k,l){var D=new q.Deferred();Promise.resolve().then(function(){return u.injectStickyParametersAsync({args:{params:P},appLifeCycle:A,technicalParameters:T,type:t});}).then(function(n){n=g(n,j).params;n=f({params:n}).params;var v;if(Array.isArray(h)){v=[];h.forEach(function(r){v.push([{semanticObject:r[0],params:r[1],ignoreFormFactor:!!r[2],ui5Component:r[3],appStateKey:r[4],compactIntents:!!(r[5])}]);});}else{v={semanticObject:h,params:n,ignoreFormFactor:I,ui5Component:j,appStateKey:k,compactIntents:!!l};}return Promise.all([sap.ushell.Container.getServiceAsync("NavTargetResolution"),v]);}).then(function(r){var N=r[0];var v=r[1];b.invokeUnfoldingArrayArguments(N.getLinks.bind(N),[v]).done(D.resolve).fail(D.reject);});return D.promise();};this.getLinks=function(v){var E;E=b.invokeUnfoldingArrayArguments(this._getLinks.bind(this),[v]);return E;};this._getLinks=function(n){var D=new q.Deferred();if(typeof n==="undefined"){n={};}var N=q.extend(true,{},n);N.compactIntents=!!N.compactIntents;N.action=N.action||undefined;N.paramsOptions=u.extractGetLinksParameterOptions(N.params);Promise.resolve().then(function(){return u.injectStickyParametersAsync({args:N,appLifeCycle:A,technicalParameters:T,type:t});}).then(function(h){N=h;var P;if(N.params){P=u.extractGetLinksParameterDefinition(N.params);}else{P=N.params;}var j=g({params:P},N.ui5Component).params;j=f({params:j}).params;if(N.appStateKey){j["sap-xapp-state"]=[N.appStateKey];delete N.appStateKey;}N.params=j;return sap.ushell.Container.getServiceAsync("NavTargetResolution");}).then(function(h){h.getLinks(N).done(D.resolve).fail(D.reject);});return D.promise();};this.getDistinctSemanticObjects=function(){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(N){N.getDistinctSemanticObjects().done(D.resolve).fail(D.reject);});return D.promise();};this.isIntentSupported=function(I,h){var D=new q.Deferred(),j={},k=I.map(function(l){var n=g(l,h);j[n]=l;return n;});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(N){N.isIntentSupported(k).done(function(l){var n={};Object.keys(l).forEach(function(K){n[j[K]]=l[K];});D.resolve(n);}).fail(D.reject.bind(D));});return D.promise();};this.isNavigationSupported=function(I,h){var D=new q.Deferred();var j=I.map(function(k){return g(k,h);});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(N){N.isNavigationSupported(j).done(D.resolve).fail(D.reject);});return D.promise();};this.isUrlSupported=function(h){var D=new q.Deferred();if(typeof h!=="string"){D.reject();return D.promise();}if(e.isIntentUrl(h)){var H=e.getHash(h);this.isIntentSupported(["#"+H]).done(function(r){if(r["#"+H]&&r["#"+H].supported){D.resolve();}else{D.reject();}}).fail(function(){D.reject();});}else{D.resolve();}return D.promise();};this.createComponentInstance=function(I,h,j){var D=new q.Deferred(),k=sap.ushell.Container,M;this.createComponentData(I,h).then(function(l){k.getServiceAsync("Ui5ComponentLoader").then(function(n){return n.modifyComponentProperties(l,d.Application).then(function(r){M=r;return n;});}).then(function(n){if(j){j.runAsOwner(function(){r(M);});}else{r(M);}function r(v){v.loadDefaultDependencies=false;n.instantiateComponent(v).then(function(w){D.resolve(w.componentHandle.getInstance());},function(E){E=E||"";L.error("Cannot create UI5 component: "+E,E.stack,"sap.ushell.services.CrossApplicationNavigation");D.reject(E);});}});},function(E){D.reject(E);});return D.promise();};this.createComponentData=function(I,h){return new Promise(function(r,R){var j=sap.ushell.Container,k,l;if(!h){h={};}else{l=Object.keys(h).length;if(l>1||(l===1&&!h.componentData)){R("`oConfig` argument should either be an empty object or contain only the `componentData` property.");return;}}if(h.componentData){delete h.componentData.startupParameters;delete h.componentData.config;delete h.componentData["sap-xapp-state"];}k=e.constructShellHash(e.parseShellHash(I));if(!k){R("Navigation intent invalid!");return;}j.getServiceAsync("NavTargetResolution").then(function(N){N.resolveHashFragment("#"+k).then(function(n){function v(x){x=q.extend(true,{},x,h);if(!x.ui5ComponentName){if(x.additionalInformation){x.ui5ComponentName=x.additionalInformation.replace(/^SAPUI5\.Component=/,"");}else if(x.name){x.ui5ComponentName=x.name;}}return x;}if(n.applicationType===c.URL.type&&n.appCapabilities&&n.appCapabilities.appFrameworkId==="UI5"&&sap.ushell.Container.inAppRuntime()){sap.ui["require"](["sap/ushell/appRuntime/ui5/services/AppLifeCycleAgent"],function(x){x.getAppInfo(n.appCapabilities.technicalAppComponentId).then(function(y){y=v(y);w({ui5ComponentName:n.appCapabilities.technicalAppComponentId,applicationDependencies:y,url:y.url});});});}else if(n.applicationType!==c.URL.type&&!(/^SAPUI5\.Component=/.test(n.additionalInformation))){R("The resolved target mapping is not of type UI5 component.");}else{w(n);}function w(x){j.getServiceAsync("Ui5ComponentLoader").then(function(y){x=v(x);x.loadDefaultDependencies=false;y.createComponentData(x).then(function(z){r(z);},function(E){E=E||"";L.error("Cannot get UI5 component data: "+E,E.stack,"sap.ushell.services.CrossApplicationNavigation");R(E);});});}});});});};this.createEmptyAppState=function(h,j,P,k){L.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.createEmptyAppState'. Please use 'createEmptyAppStateAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var l=sap.ushell.Container.getService("AppState");if(!(h instanceof sap.ui.core.UIComponent)){throw new Error("The passed oAppComponent must be a UI5 Component.");}return l.createEmptyAppState(h,j,P,k);};this.createEmptyAppStateAsync=function(h,j,P,k){if(!(h instanceof sap.ui.core.UIComponent)){return Promise.reject("The passed oAppComponent must be a UI5 Component.");}return sap.ushell.Container.getServiceAsync("AppState").then(function(l){return l.createEmptyAppState(h,j,P,k);});};this.getStartupAppState=function(h){this._checkComponent(h);var j=h.getComponentData()&&h.getComponentData()["sap-xapp-state"]&&h.getComponentData()["sap-xapp-state"][0];return this.getAppState(h,j);};this._checkComponent=function(h){if(!(h instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}};this.getAppState=function(h,j){var k;var D=new q.Deferred();this._checkComponent(h);sap.ushell.Container.getServiceAsync("AppState").then(function(l){if(typeof j!=="string"){if(j!==undefined){L.error("Illegal Argument sAppStateKey ");}setTimeout(function(){k=l.createEmptyUnmodifiableAppState(h);D.resolve(k);},0);return;}l.getAppState(j).done(D.resolve).fail(D.reject);});return D.promise();};this.getAppStateData=function(h){return b.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[h]);};this._getAppStateData=function(h){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("AppState").then(function(j){if(typeof h!=="string"){if(h!==undefined){L.error("Illegal Argument sAppStateKey ");}setTimeout(function(){D.resolve(undefined);},0);}else{j.getAppState(h).done(function(k){D.resolve(k.getData());}).fail(D.resolve.bind(D,undefined));}});return D.promise();};this.saveMultipleAppStates=function(h){var r=[],D=new q.Deferred();h.forEach(function(j){r.push(j.save());});q.when.apply(this,r).done(function(){D.resolve(r);}).fail(function(){D.reject("save failed");});return D.promise();};this._processShellHashWithParams=function(h){if(h&&h.processParams===true&&h.target&&h.target.shellHash&&h.params){var H=e.parseShellHash(h.target.shellHash);h.target={semanticObject:H.semanticObject,action:H.action,contextRaw:H.contextRaw};h.appSpecificRoute=H.appSpecificRoute;h.params=Object.assign({},h.params,H.params);}};this.getSupportedAppStatePersistencyMethods=function(){L.error("Deprecated API call of 'sap.ushell.CrossApplicationNavigation.getSupportedAppStatePersistencyMethods'. Please use 'getSupportedAppStatePersistencyMethodsAsync' instead",null,"sap.ushell.services.CrossApplicationNavigation");var h=sap.ushell.Cntainer.getService("AppState");return h.getSupportedPersistencyMethods();};this.getSupportedAppStatePersistencyMethodsAsync=function(){return sap.ushell.Container.getServiceAsync("AppState").then(function(h){return h.getSupportedPersistencyMethods();});};this.makeStatePersistent=function(k,P,h){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("AppState").then(function(j){j.makeStatePersistent(k,P,h).done(D.resolve).fail(D.reject);});return D.promise();};this.resolveIntent=function(h){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(N){N.resolveHashFragment(h).then(function(r){D.resolve({url:r.url});}).fail(function(M){D.reject(M);});});return D.promise();};}C.hasNoAdapter=true;return C;},true);
