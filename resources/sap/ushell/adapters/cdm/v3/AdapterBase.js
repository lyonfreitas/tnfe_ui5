// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/base/util/deepClone","sap/base/Log","sap/ushell/UI5ComponentType"],function(r,R,a,G,C,u,b,e,n,o,U,c,V,q,i,d,O,f,g,L,h){"use strict";var l=L.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");var j=L.Level;var S="sap.ushell.components.tiles.cdm.applauncher";var D="sap.ushell.components.tiles.cdm.applauncherdynamic";function A(k,p,m){this.oAdapterConfiguration=m;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link",Card:"card"};}A.prototype.getGroups=function(){var k=new q.Deferred();this._ensureLoaded().done(function(m){U.setPerformanceMark("FLP - homepage groups processed");k.resolve(m);}).fail(function(){k.resolve([]);});return k.promise();};A.prototype._ensureLoaded=function(){var t=this,k;if(this._ensureLoadedDeferred){return this._ensureLoadedDeferred.promise();}k=new q.Deferred();this._ensureLoadedDeferred=k;this._getSiteData().done(function(s){if(!t.isSiteSupported(s)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site");}var I=[];var m=r.getGroupsArrayFromSite(s);m=t._addDefaultGroup(m,s);m.forEach(function(p){I=t._ensureGroupItemsResolved(p,s).concat(I);});t._allPromisesDone(I).done(function(){t._ensureLoadedDeferred.resolve(m);delete t._ensureLoadedDeferred;t._logTileResolutionFailures(t._mFailedResolvedTiles);});}).fail(function(E){l.error("Delivering hompage groups failed - "+E);t._ensureLoadedDeferred.resolve([]);delete t._ensureLoadedDeferred;});return k.promise();};A.prototype._ensureGroupItemsResolved=function(k,s){var p=[],m,t;if(k.payload&&k.payload.tiles){m=this._ensureGroupTilesResolved(k.payload.tiles,s);Array.prototype.push.apply(p,m);}if(k.payload&&k.payload.links){t=this._ensureGroupLinksResolved(k.payload.links,s);Array.prototype.push.apply(p,t);}return p;};A.prototype._ensureGroupTilesResolved=function(k,s){return(k||[]).map(function(t,I){return this._resolveGroupTile(t,s).then(function(m){m.isLink=false;return m;});},this);};A.prototype._ensureGroupLinksResolved=function(k,s){return(k||[]).map(function(m){return this._resolveGroupTile(m,s).then(function(p){p.isLink=true;return p;});},this);};A.prototype._resolveGroupTile=function(t,s){var m=this._mResolvedTiles;var F=this._mFailedResolvedTiles;var k;function p(x){m[t.id]=x;if(F[t.id]){delete F[t.id];}return x;}function v(t){var T=t.target;return T&&T.semanticObject==="Shell"&&T.action==="launchURL";}if(m[t.id]){return(new q.Deferred()).resolve(m[t.id]).promise();}if(t.target&&t.target.url){k=q.when(this._getTileForUrl(t));}else if(t.isBookmark&&t.vizType===undefined){k=this._resolveTileByIntent(t,s);}else if(v(t)){k=this._resolveTileByIntent(t,s);}else{k=this._resolveTileByVizId(t,s);}var w=new q.Deferred();k.done(function(x){w.resolve(p(x));}).fail(function(x){F[t.id]=x;w.reject(x);});return w.promise();};A.prototype._resolveTileByVizId=function(t,s){var v,k,m,p,w,x,I,M,N,y,H,z,E;function B(T,W){return new q.Deferred().reject({logLevel:T,message:W}).promise();}var F=new q.Deferred();if(!i(s)){return B(j.ERROR,"Cannot resolve tile: oSite must be an object");}if(!i(t)){return B(j.ERROR,"Cannot resolve tile: oTile must be an object");}k=t.vizId;v=g(R.get(s,k||"")||{});p=t.vizType||R.getTypeId(v);m=R.getType(s,p);if(!m){return B(j.ERROR,"Cannot resolve tile '"+t.id+"': no visualization type found for vizTypeId '"+p+"'");}w=R.getAppId(v);if(w){x=R.getAppDescriptor(s,w);if(!x){return B(j.INFO,"Tile '"+t.id+"' filtered from result: no app descriptor found for appId '"+w+"' (dangling app reference)");}I=r.getInbound(x,R.getTarget(v).inboundId);if(!I){return B(j.ERROR,"Cannot resolve tile '"+t.id+"': app '"+w+"' has no navigation inbound");}M=c.mapOne(I.key,I.inbound,x,v,m,s);var J=M.resolutionResult.applicationType,K=M.resolutionResult.additionalInformation,P=b.last("/core/navigation/enableInPlaceForClassicUIs"),Q=P?P[J]:false;N=n.computeNavigationModeForHomepageTiles(J,K,Q);z=R.getOutbound(v,I.inbound);H=this._toHashFromOutbound(z);}else{v.vizConfig=f({},v.vizConfig,t.vizConfig);M=c.mapOne(undefined,undefined,undefined,v,m,s);if(R.startsExternalUrl(v)){E=U.getMember(v.vizConfig,"sap|flp.target.url");}}y=M.tileResolutionResult;y.navigationMode=N;y.isLink=false;if(!this._isFormFactorSupported(y)){return B(j.INFO,"Tile '"+t.id+"' filtered from result: form factor not supported");}if(E||H){F.resolve({tileResolutionResult:y,tileIntent:E||H});}else{if(!this._oUrlParsingPromise){this._oUrlParsingPromise=sap.ushell.Container.getServiceAsync("URLParsing");}this._oUrlParsingPromise.then(function(T){if(t.target){var W=g(t.target);H=c.toHashFromTarget(a.harmonizeTarget(W),T);}F.resolve({tileResolutionResult:y,tileIntent:H});});}return F.promise();};A.prototype._isFormFactorSupported=function(k){var s=U.getFormFactor();return r.supportsFormFactor(k,s);};A.prototype._getFirstInbound=function(k){var F=Object.keys(k["sap.app"].crossNavigation.inbounds).shift(),I=k["sap.app"].crossNavigation.inbounds[F];return{key:F,inbound:I};};A.prototype._resolveTileByIntent=function(t){var H=this._prepareTileHash(t);return this._getTileFromHash(H);};A.prototype._allPromisesDone=function(p){var k=new q.Deferred(),m;if(p.length===0){k.resolve([]);}else{var N=p.map(function(P){m=new q.Deferred();P.always(m.resolve.bind(m));return m.promise();});q.when.apply(this,N).done(function(){var s=Array.prototype.slice.call(arguments);k.resolve(s);});}return k.promise();};A.prototype._logTileResolutionFailures=function(F){var m={};if(!F){return;}Object.keys(j).filter(function(s){var k=j[s];return k>=j.FATAL&&k<=j.ALL;}).forEach(function(s){m[j[s]]="";});Object.keys(F).forEach(function(s){var k=F[s];if(k.logLevel){m[k.logLevel]=m[k.logLevel].concat(k.message).concat("\n");}});if(m[j.FATAL]){l.fatal(m[j.FATAL]);}if(m[j.ERROR]){l.error(m[j.ERROR]);}if(m[j.WARNING]){l.warning(m[j.WARNING]);}if(m[j.INFO]){l.info(m[j.INFO]);}if(m[j.DEBUG]){l.debug(m[j.DEBUG]);}if(m[j.TRACE]){l.trace(m[j.TRACE]);}};A.prototype._isValidTitle=function(t){return typeof t==="string"&&t;};A.prototype._isGroupPreset=function(k){return r.isGroupPreset(k);};A.prototype._isGroupLocked=function(k){return r.isGroupLocked(k);};A.prototype.getGroupTitle=function(k){return r.getGroupTitle(k);};A.prototype.getGroupId=function(k){return r.getGroupId(k);};A.prototype.isGroupVisible=function(k){return r.isGroupVisible(k);};A.prototype.getTileTitle=function(t){return r.getTileTitle(this._mResolvedTiles,t);};A.prototype.getTileContentProviderId=function(t){return r.getContentProviderId(t);};A.prototype.getTileSubtitle=function(t){return r.getTileSubtitle(this._mResolvedTiles,t);};A.prototype.getTileIcon=function(t){return r.getTileIcon(this._mResolvedTiles,t);};A.prototype.getTileInfo=function(t){return r.getTileInfo(this._mResolvedTiles,t);};A.prototype.getTileIndicatorDataSource=function(t){var k=this._mResolvedTiles[t.id],m={},p;if(t.indicatorDataSource){m.indicatorDataSource=f({},t.indicatorDataSource);if(t.dataSource){m.dataSource=f({},t.dataSource);}return m;}if(!k){return m;}p=k.tileResolutionResult;if(p.indicatorDataSource){m.indicatorDataSource=f({},p.indicatorDataSource);if(p.indicatorDataSource.hasOwnProperty("dataSource")){var s=p.indicatorDataSource.dataSource,v=p.dataSources;if(v&&v.hasOwnProperty(s)){m.dataSource=f({},v[s]);}else{L.warning("datasource referenced but not found for tile: "+k.tileIntent);}}if(U.getMember(p,"runtimeInformation.componentProperties.url")){var P=U.getMember(m,"indicatorDataSource.path");var w=U.getMember(m,"dataSource.uri");var x=U.getMember(p,"runtimeInformation.componentProperties.url");var T=u(P,w,x,this.getWindowLocationHref());if(!T.error){if(P){m.indicatorDataSource.path=T.uri;}if(w){m.dataSource.uri=T.uriParent;}}}}return m;};A.prototype.getWindowLocationHref=function(){return window.location.href;};A.prototype.isGroupRemovable=function(k){return!this._isGroupPreset(k);};A.prototype.isGroupLocked=function(k){return this._isGroupLocked(k);};A.prototype.getGroupTiles=function(k){return r.getGroupTiles(k).concat(r.getGroupLinks(k));};A.prototype.getTileType=function(I){if(r.isLink(this._mResolvedTiles,I)){return this.TileType.Link;}if(r.isCard(this._mResolvedTiles,I)){return this.TileType.Card;}return this.TileType.Tile;};A.prototype.getTileId=function(t){return r.getTileId(t);};A.prototype.getTileSize=function(t){return r.getTileSize(this._mResolvedTiles,t)||"1x1";};A.prototype.getTileTarget=function(t){var T=r.getTileId(t),k=this._mResolvedTiles[T];if(t.target&&t.target.url){return t.target.url;}if(k){return k.tileIntent;}L.warning("Could not find a target for Tile with id '"+T+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};A.prototype.isTileIntentSupported=function(t){return(this._mFailedResolvedTiles[t.id]===undefined);};A.prototype.setTileVisible=function(t,N){var k=this._mResolvedTiles[t.id];if(k){if(k.tileComponent){this._notifyTileAboutVisibility(k.tileComponent,N,k.visibility);}k.visibility=N;}};A.prototype.getCardManifest=function(k){var m,p=this._mResolvedTiles[k.id];m=p.tileResolutionResult;return m.tileComponentLoadInfo;};A.prototype._getTileUiComponentContainer=function(t,k,I){var m=this,p,s,N,T,v,w,x=new q.Deferred();sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(y){s=y;var z=this._createTileComponentData(t,I,k);return z;}.bind(this)).then(function(y){return this._enhanceTileComponentData(t,y);}.bind(this)).then(function(y){p=k.tileResolutionResult;if(k.isLink){N=p.navigationMode;x.resolve(m._createLinkInstance(t,I,N,G,o));return;}var z=this._createTileComponentProperties(y,p.tileComponentLoadInfo);if(!z.name){return Promise.reject("Cannot find name of tile component for tile with id: '"+t.id+"'");}if(z.manifest){y.properties=y.properties||{};y.properties.manifest=z.manifest;}w=this._isCustomTileComponent(z.name);var B=function(E){var k;T=E.componentHandle.getInstance();v=new C({component:T,height:"100%"});if(!I){k=m._mResolvedTiles[t.id];k.tileComponent=T;if(typeof k.visibility==="boolean"){m._notifyTileAboutVisibility(T,k.visibility);}}return v;};var _=function(){return s.createComponent({loadCoreExt:w,loadDefaultDependencies:false,componentData:y,url:z.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:z,ui5ComponentName:z.name},{},[],h.Visualization).then(B);};if(w){e.once("CoreResourcesComplementLoaded").do(function(){_().then(function(v){x.resolve(v);}).fail(function(E){x.reject(E);});});}else{_().then(function(v){x.resolve(v);}).fail(function(E){x.reject(E);});}}.bind(this)).catch(function(E){x.reject(E);});return x.promise();};A.prototype._createTileComponentProperties=function(t,T){var k={};if(!T||d(T)){if(t.properties.indicatorDataSource&&t.properties.indicatorDataSource.path){k.name=D;}else{k.name=S;}}else{k=T.componentProperties||{};k.name=T.componentName;}return k;};A.prototype.getTileView=function(k){var t=this;return new q.Deferred(function(m){return t._getTileView(k,false).then(function(T){m.resolve(T);},function(s){var E="Tile with ID '"+k.id+"' could not be initialized"+(s?":\n"+s:".");L.error(E,null,k.tileType);m.reject(E);});}).promise();};A.prototype._getTileView=function(k){var m,E,p=new q.Deferred();if(typeof k!=="object"||!k.id){E="Invalid input parameter passed to _getTileView: "+k;L.error(E);return p.reject(E).promise();}m=this._mResolvedTiles[k.id];if(!m){E="No resolved tile found for tile ID: "+k.id;L.error(E);return p.reject(E).promise();}return this._getTileUiComponentContainer(k,m,false);};A.prototype._createTileComponentData=function(t,I,k){var T=I?this.getCatalogTileTitle(t):this.getTileTitle(t),s=I?this.getCatalogTilePreviewSubtitle(t):this.getTileSubtitle(t),m=I?this.getCatalogTilePreviewIcon(t):this.getTileIcon(t),p=I?this.getCatalogTilePreviewInfo(t):this.getTileInfo(t),v=I?this.getCatalogTileTargetURL(t):this.getTileTarget(t),w=this.getTileIndicatorDataSource(t),N=t.numberUnit||k.tileResolutionResult.numberUnit,x={properties:{},startupParameters:{}};if(k.tileResolutionResult.isCustomTile===true&&k.tileResolutionResult.startupParameters){x.startupParameters=k.tileResolutionResult.startupParameters;}if(T){x.properties.title=T;}if(p){x.properties.info=p;}if(s){x.properties.subtitle=s;}if(m){x.properties.icon=m;}if(v){x.properties.targetURL=v;}if(N){x.properties.numberUnit=N;}if(w.indicatorDataSource){x.properties.indicatorDataSource=w.indicatorDataSource;if(w.dataSource){x.properties.dataSource=w.dataSource;}}if(k.tileResolutionResult){x.properties.navigationMode=k.tileResolutionResult.navigationMode;x.properties.contentProviderId=k.tileResolutionResult.contentProviderId||"";}return x;};A.prototype._enhanceTileComponentData=function(t,k){var p=Promise.resolve();var s=this.getTileContentProviderId(t);if(s){p=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(m){return m.getSystemContext(s);}).then(function(m){k.properties.indicatorDataSource.path=m.getFullyQualifiedXhrUrl(k.properties.indicatorDataSource.path);}).catch(function(){L.error("System Context not available");});}return p.then(function(){return k;});};A.prototype._isGroupTile=function(t){return r.isGroupTile(t);};A.prototype._isCatalogTile=function(t){return!!(t&&t.isCatalogTile);};A.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(t)]);};A.prototype.getCatalogTileId=function(k){if(this._isGroupTile(k)){if(this._isFailedGroupTile(k)){return undefined;}if(k.isBookmark&&O.get("target.url",k)){return k.target.url;}return k.vizId||(k.target&&k.target.url);}if(this._isCatalogTile(k)){return k.id;}return undefined;};A.prototype.getCatalogTilePreviewTitle=function(k){if(this._isGroupTile(k)){return this.getTileTitle(k);}return(k.tileResolutionResult&&k.tileResolutionResult.title)||"";};A.prototype.getCatalogTileTargetURL=function(k){if(!k){throw new Error("The given tile is falsy");}if(this._isCatalogTile(k)){if(k.tileResolutionResult&&k.tileResolutionResult.isCustomTile){if(!k.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(k.tileResolutionResult.targetOutbound);}return k.tileIntent||"";}return this.getTileTarget(k);};A.prototype.isGroupFeatured=function(k){return!!k.isFeatured;};A.prototype._getMember=function(k,s){return U.getMember(k,s);};A.prototype.getCdmVersionsSupported=function(){return{min:V("3.0.0"),max:V("3.1.0")};};A.prototype.isSiteSupported=function(s){if(!s._version||V(s._version).compareTo(this.getCdmVersionsSupported().min)<0||V(s._version).compareTo(this.getCdmVersionsSupported().max)>0){L.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false;}return true;};A.prototype._isCustomTileComponent=function(s){return!(s===S||s===D);};return A;},true);
