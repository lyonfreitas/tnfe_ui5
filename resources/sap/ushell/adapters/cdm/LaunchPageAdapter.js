// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/_LaunchPage/readHome","sap/ushell/adapters/cdm/_LaunchPage/modifyHome","sap/ushell/adapters/cdm/_LaunchPage/readCatalogs","sap/m/GenericTile","sap/m/library","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/utilsCdm","sap/ushell/utils/WindowUtils","sap/ushell/utils/UrlParsing","sap/ushell/components/tiles/utilsRT","sap/base/util/Version","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/UI5ComponentType"],function(r,m,R,G,M,C,u,a,E,n,o,U,b,W,c,d,V,J,q,f,i,g,O,L,h){"use strict";var j=M.GenericTileMode;var l=L.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),k=L.Level;function p(s,P,A){var _,S="sap.ushell.components.tiles.cdm.applauncher",D="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};Promise.all([sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("CommonDataModel")]).then(function(e){this.oURLParsingService=e[0];this.oCDMService=e[1];}.bind(this));this.getCdmVersionsSupported=function(){return{min:V("0"),max:V("2.0.0")};};this.isSiteSupported=function(e){if(!!e._version&&V(e._version).compareTo(this.getCdmVersionsSupported().max)>0){L.fatal("Invalid CDM site version: Only sites up to version 2.0.0 are supported");return false;}return true;};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var e=new q.Deferred();this._assureLoaded().done(function(K){U.setPerformanceMark("FLP - homepage groups processed");e.resolve(K);}).fail(function(){e.resolve([]);});return e.promise();};this._getTileFromHashInContextOfSite=function(e,K,N){var Q=new q.Deferred(),T=K[N];if(!T){T=e(N);K[N]=T;}T.done(function(X){var Y={tileIntent:N,tileResolutionResult:X};Q.resolve(Y);}).fail(function(X){Q.reject("Hash '"+N+"' could not be resolved to a tile. "+X);});return Q.promise();};this._getTileFromHash=function(e){var K=new q.Deferred();sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(N){var Q=N.resolveTileIntent.bind(N);this._getTileFromHashInContextOfSite(Q,this._mCatalogTilePromises,e).done(K.resolve).fail(K.reject);}.bind(this));return K.promise();};this._getTileForUrl=function(T){var e=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:e,isCustomTile:false}};};this._assureGroupItemsResolved=function(e,K){var N=[],Q,T;if(e.payload&&e.payload.tiles){Q=this._assureGroupTilesResolved(e.payload.tiles,K);Array.prototype.push.apply(N,Q);}if(e.payload&&e.payload.links){T=this._assureGroupLinksResolved(e.payload.links,K);Array.prototype.push.apply(N,T);}return N;};this._assureGroupTilesResolved=function(e,K){return(e||[]).map(function(T,N){return this._resolveGroupTile(T,K).then(function(Q){Q.isLink=false;return Q;});},this);};this._assureGroupLinksResolved=function(e,K){return(e||[]).map(function(N){return this._resolveGroupTile(N,K).then(function(Q){Q.isLink=true;return Q;});},this);};this._resolveGroupTile=function(T,e){var K=this._mResolvedTiles;var N=this._mFailedResolvedTiles;var Q;function X(Z){K[T.id]=Z;if(N[T.id]){delete N[T.id];}return Z;}function Y(T){var Z=T.target;return Z&&Z.semanticObject==="Shell"&&Z.action==="launchURL";}if(K[T.id]){return(new q.Deferred()).resolve(K[T.id]).promise();}if(T.target&&T.target.url){Q=q.when(this._getTileForUrl(T));}else if(T.isBookmark){Q=this._resolveTileByIntent(T,e);}else if(Y(T)){Q=this._resolveTileByIntent(T,e);}else{Q=this._resolveTileByAppId(T,e);}Q.done(function(Z){X(Z);}).fail(function(Z){N[T.id]=Z;});return Q;};this._resolveTileByAppId=function(T,e){var K,N,Q,X,Y;function Z(e1,f1){return new q.Deferred().reject({logLevel:e1,message:f1}).promise();}if(!i(T)){return Z(k.ERROR,"Cannot resolve tile: oTile must be an object");}if(!i(e)){return Z(k.ERROR,"Cannot resolve tile: oSite must be an object");}K=T.appId||T.appIDHint;if(!K){return Z(k.ERROR,["Cannot resolve tile '",T.id,"': either appId or appIDHint must be specified"].join(""));}N=e.applications&&e.applications[K];if(!N){return Z(k.INFO,["Tile '",T.id,"' filtered from result: no app found for appId '",K,"' (dangling app reference)"].join(""));}Q=this._getFirstInbound(N);if(!Q){return Z(k.ERROR,["Cannot resolve tile '",T.id,"': app '",K,"' has no navigation inbound"].join(""));}var $=b.mapOne(Q.key,Q.inbound,N),a1=$.resolutionResult.applicationType,b1=$.resolutionResult.additionalInformation,c1=a.last("/core/navigation/enableInPlaceForClassicUIs"),d1=c1?c1[a1]:false;X=$.tileResolutionResult;X.navigationMode=n.computeNavigationModeForHomepageTiles(a1,b1,d1);X.isLink=false;if(!this._isFormFactorSupported(X)){return Z(k.INFO,["Tile '",T.id,"' filtered from result: form factor not supported"].join(""));}Y=this._toHashFromInbound(Q.inbound);return q.when({tileResolutionResult:X,tileIntent:Y});};this._isFormFactorSupported=function(e){var K=U.getFormFactor();return r.supportsFormFactor(e,K);};this._getFirstInbound=function(e){var K=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),N=e["sap.app"].crossNavigation.inbounds[K];return{key:K,inbound:N};};this._resolveTileByIntent=function(T,e){var K=this._prepareTileHash(T);return this._getTileFromHash(K);};this._prepareTileHash=function(T){var e={},K,N;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)&&T.target){N=T.target.parameters||[];N.forEach(function(Q){if(Q.name&&Q.value){e[Q.name]=[Q.value];}});K={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:e,appSpecificRoute:T.target.appSpecificRoute};return"#"+c.constructShellHash(K);}return undefined;};this._allPromisesDone=function(e){var K=new q.Deferred(),N;if(e.length===0){K.resolve([]);}else{var Q=e.map(function(T){N=new q.Deferred();T.always(N.resolve.bind(N));return N.promise();});q.when.apply(this,Q).done(function(){var T=Array.prototype.slice.call(arguments);K.resolve(T);});}return K.promise();};this._assureLoaded=function(){var e=this,K;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}K=new q.Deferred();this._assureLoadedDeferred=K;sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(N){N.getSite().done(function(Q){if(!e.isSiteSupported(Q)){throw new Error("Invalid CDM site version: Check configuration of launchpage adapter and version of FLP site");}var T=[];var X=r.getGroupsArrayFromSite(Q);var Y=r.getDefaultGroup(X);if(!Y){Y=m.createDefaultGroup(U.generateUniqueId(r.getGroupIdsFromSite(Q)));Q=m.addGroupToSite(Q,Y,0);X=r.getGroupsArrayFromSite(Q);}_=Y;X.forEach(function(Z){T=e._assureGroupItemsResolved(Z,Q).concat(T);});e._allPromisesDone(T).done(function(){e._assureLoadedDeferred.resolve(X);delete e._assureLoadedDeferred;e._logTileResolutionFailures(e._mFailedResolvedTiles);});}).fail(function(Q){L.error("Delivering hompage groups failed - "+Q);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});});return K.promise();};this._logTileResolutionFailures=function(e){var K={};if(!e){return;}Object.keys(k).filter(function(N){var Q=k[N];return Q>=k.FATAL&&Q<=k.ALL;}).forEach(function(N){K[k[N]]="";});Object.keys(e).forEach(function(N){var Q=e[N];if(Q.logLevel){K[Q.logLevel]=K[Q.logLevel].concat(Q.message).concat("\n");}});if(K[k.FATAL]){l.fatal(K[k.FATAL]);}if(K[k.ERROR]){l.error(K[k.ERROR]);}if(K[k.WARNING]){l.warning(K[k.WARNING]);}if(K[k.INFO]){l.info(K[k.INFO]);}if(K[k.DEBUG]){l.debug(K[k.DEBUG]);}if(K[k.TRACE]){l.trace(K[k.TRACE]);}};this.getDefaultGroup=function(){var e=new q.Deferred(),K;if(!_){K=this._assureLoaded();}if(K){K.done(function(){e.resolve(_);}).fail(function(N){e.reject("Failed to access default group. "+N);});}else{e.resolve(_);}return e.promise();};this._isValidTitle=function(T){if(typeof T!=="string"||!T){return false;}return true;};this._isGroupPreset=function(e){return r.isGroupPreset(e);};this._isGroupLocked=function(e){return r.isGroupLocked(e);};this.addGroup=function(T){var e=new q.Deferred(),K=this.oCDMService,N,Q,X=this;if(!this._isValidTitle(T)){return e.reject("No valid group title").promise();}Q="Failed to add the group with title '"+T+"' to the homepage. ";K.getSite().done(function(Y){N=U.generateUniqueId(r.getGroupIdsFromSite(Y));m.addGroupToSite(Y,m.createEmptyGroup(N,T));K.save().done(function(){delete X._assureLoadedDeferred;e.resolve(Y.groups[N],N);}).fail(function(Z){e.reject(Z);});}).fail(function(Y){e.reject(Q+Y);});return e.promise();};this.getGroupTitle=function(e){return r.getGroupTitle(e);};this.setGroupTitle=function(e,N){var K=this,Q=new q.Deferred(),T=this.oCDMService,X,Y;if(typeof e!=="object"||!r.getGroupId(e)){return Q.reject("Unexpected group value").promise();}if(!K._isValidTitle(N)){return Q.reject("Unexpected oGroup title value").promise();}Y="Failed to set new title for group with id '"+r.getGroupId(e)+"'. ";X=r.getGroupTitle(e);T.getSite().done(function(Z){if(e){m.setGroupTitle(e,N);}T.save().done(function(){Q.resolve();}).fail(function($){L.error($);Q.reject(X);});}).fail(function(Z){Q.reject(X,Y+Z);});return Q.promise();};this.getGroupId=function(e){return r.getGroupId(e);};this.hideGroups=function(e){var K=new q.Deferred(),N=this.oCDMService,Q;if(e&&Array.isArray(e)){Q="Failed to hide group. ";N.getSite().done(function(T){r.getGroupsArrayFromSite(T).forEach(function(X){m.setGroupVisibility(X,e&&Array.prototype.indexOf.call(e,r.getGroupId(X))===-1);});N.save().done(function(){K.resolve();}).fail(function(X){K.reject("Hiding of groups did not work as expected - "+X);});}).fail(function(T){K.reject(Q+T);});}else{K.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return K.promise();};this.isGroupVisible=function(e){return r.isGroupVisible(e);};this.moveGroup=function(e,K){var N=new q.Deferred(),Q=this.oCDMService,T,X;if(!e||!r.getGroupId(e)||K<0){return N.reject("Unable to move groups - invalid parameters").promise();}X="Failed to move group with id '"+e.identification.id+"'. ";Q.getSite().done(function(Y){var Z=r.getGroupIdsFromSite(Y),$=r.getGroupId(e);if(!Z){return N.reject("groupsOrder not found - abort operation of adding a group.");}else if(Z.indexOf($)===K){return N.resolve();}T=U.moveElementInsideOfArray(Z,Z.indexOf($),K);if(!T){return N.reject("invalid move group operation - abort.");}m.setGroupsOrder(Y,T);Q.save().done(function(){N.resolve();}).fail(function(a1){N.reject(a1);});return undefined;}).fail(function(Y){N.reject(X+Y);});return N.promise();};this.removeGroup=function(e){var K=new q.Deferred(),N=this.oCDMService,Q,T;if(typeof e!=="object"){return K.reject("invalid group parameter").promise();}T=r.getGroupId(e);if(!T){return K.reject("group without id given").promise();}Q="Failed to remove group with id '"+T+"'. ";N.getSite().done(function(X){m.removeGroupFromSite(X,e);N.save().done(function(){K.resolve();}).fail(function(Y){K.reject(Y);});}).fail(function(X){K.reject(Q+X);});return K.promise();};this.resetGroup=function(e){var K=new q.Deferred(),N=this.oCDMService,Q=[],T=this,X,Y;if(typeof e==="object"&&r.getGroupId(e)){Y=r.getGroupId(e);X="Failed to reset group with id '"+Y+"'. ";N.getSite().done(function(Z){q.extend(true,Q,r.getGroupsArrayFromSite(Z));if(T.isGroupRemovable(e)===false){N.getGroupFromOriginalSite(Y).done(function($){if(typeof Z==="object"&&r.getGroupFromSite(Z,Y)){m.overwriteGroup(Z,$,Y);}N.save().done(function(){K.resolve($);}).fail(function(a1){K.reject("Group could not be reset - "+a1,Q);});}).fail(function($){K.reject("Group could not be reset - "+$,Q);});}else{K.reject("Group could not be reset as it was created by the user",Q);}}).fail(function(Z){K.reject(X+Z,[]);});}return K.promise();};this.getTileTitle=function(T){return r.getTileTitle(this._mResolvedTiles,T);};this.getTileSubtitle=function(T){return r.getTileSubtitle(this._mResolvedTiles,T);};this.getTileIcon=function(T){return r.getTileIcon(this._mResolvedTiles,T);};this.getTileInfo=function(T){return r.getTileInfo(this._mResolvedTiles,T);};this.getTileIndicatorDataSource=function(T){var e=this._mResolvedTiles[T.id],K={},N;if(T.indicatorDataSource){K.indicatorDataSource=f({},T.indicatorDataSource);if(T.dataSource){K.dataSource=f({},T.dataSource);}return K;}if(!e){return K;}N=e.tileResolutionResult;if(N.indicatorDataSource){K.indicatorDataSource=f({},N.indicatorDataSource);if(N.indicatorDataSource.hasOwnProperty("dataSource")){var Q=N.indicatorDataSource.dataSource,X=N.dataSources;if(X&&X.hasOwnProperty(Q)){K.dataSource=f({},X[Q]);}else{L.warning("datasource referenced but not found for tile: "+e.tileIntent);}}if(U.getMember(N,"runtimeInformation.componentProperties.url")){var Y=U.getMember(K,"indicatorDataSource.path");var Z=U.getMember(K,"dataSource.uri");var $=U.getMember(N,"runtimeInformation.componentProperties.url");var a1=u(Y,Z,$,this.getWindowLocationHref());if(!a1.error){if(Y){K.indicatorDataSource.path=a1.uri;}if(Z){K.dataSource.uri=a1.uriParent;}}}}return K;};this.getWindowLocationHref=function(){return window.location.href;};this.isGroupRemovable=function(e){return!this._isGroupPreset(e);};this.isGroupLocked=function(e){return this._isGroupLocked(e);};this.getGroupTiles=function(e){return r.getGroupTiles(e).concat(r.getGroupLinks(e));};this.getLinkTiles=function(e){return r.getGroupLinks(e);};this.getTileType=function(T){if(r.isLink(this._mResolvedTiles,T)){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return r.getTileId(T);};this.getTileSize=function(T){return r.getTileSize(this._mResolvedTiles,T)||"1x1";};this.getTileTarget=function(T){var e,K=r.getTileId(T),N=this._mResolvedTiles[K],Q;if(T.target&&T.target.url){return T.target.url;}if(N&&N.tileResolutionResult){e=N.tileResolutionResult;if(e.isCustomTile!==true){return N.tileIntent;}if(e&&typeof e.targetOutbound==="object"){Q=this._toHashFromOutbound(e.targetOutbound);if(Q){return Q;}}}L.warning("Could not find a target for Tile with id '"+K+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined);};this._notifyTileAboutRefresh=function(T){if(typeof T.tileRefresh==="function"){T.tileRefresh();}};this.refreshTile=function(T){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutRefresh(e.tileComponent);}}};this._notifyTileAboutVisibility=function(T,N,e){if(typeof T.tileSetVisible==="function"&&e!==N){T.tileSetVisible(N);}};this.setTileVisible=function(T,N){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutVisibility(e.tileComponent,N,e.visibility);}e.visibility=N;}};this.getTileView=function(e){var K=this;return new q.Deferred(function(N){return K._getTileView(e,false).then(function(T){N.resolve(T);},function(Q){var T="Tile with ID '"+e.id+"' could not be initialized"+(Q?":\n"+Q:".");L.error(T,null,e.tileType);N.reject(T);});}).promise();};this._getTileUiComponentContainerSync=function(T,e,K){var N=this,Q,X,Y,Z,$={};if(K===true){X=N._createTileComponentData(T,true,e);}else{X=N._createTileComponentData(T,false,e);}Q=e.tileResolutionResult;if(e.isLink){Y=Q.navigationMode;return N._createLinkInstance(T,K,Y,G,o);}if(typeof Q.tileComponentLoadInfo==="string"){if(X.properties.indicatorDataSource&&X.properties.indicatorDataSource.path){$.name="sap.ushell.components.tiles.cdm.applauncherdynamic";}else{$.name="sap.ushell.components.tiles.cdm.applauncher";}}else if(typeof Q.tileComponentLoadInfo==="object"&&Q.tileComponentLoadInfo!==null){$=Q.tileComponentLoadInfo.componentProperties||{};$.name=Q.tileComponentLoadInfo.componentName;}$.componentData=X;if($.manifest){$.componentData.properties=$.componentData.properties||{};$.componentData.properties.manifest=$.manifest;}if($.name){$.async=false;var a1;try{Z=sap.ui.component($);}catch(b1){L.error(b1.message+"\n-- An error occurred while instantiating "+"the tile component for "+$.name,b1.stack?b1.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}a1=new C({component:Z,height:"100%"});if(!K){N._mResolvedTiles[T.id].tileComponent=Z;}return a1;}return null;};this._getTileUiComponentContainer=function(T,e,K){var N=this,Q,X,Y,Z,$,a1,b1=new q.Deferred();if(K===true){X=N._createTileComponentData(T,true,e);}else{X=N._createTileComponentData(T,false,e);}Q=e.tileResolutionResult;if(e.isLink){Y=Q.navigationMode;b1.resolve(N._createLinkInstance(T,K,Y,G,o));return b1.promise();}var c1=this._createTileComponentProperties(X,Q.tileComponentLoadInfo);if(!c1.name){return b1.reject("Cannot find name of tile component for tile with id: '"+T.id+"'").promise();}if(c1.manifest){X.properties=X.properties||{};X.properties.manifest=c1.manifest;}a1=this.isCustomTile(c1.name);var d1=function(h1){var e;Z=h1.componentHandle.getInstance();$=new C({component:Z,height:"100%"});if(!K){e=N._mResolvedTiles[T.id];e.tileComponent=Z;if(typeof e.visibility==="boolean"){N._notifyTileAboutVisibility(Z,e.visibility);}}return $;};var e1=function(h1){return h1.createComponent({loadCoreExt:a1,loadDefaultDependencies:false,componentData:X,url:c1.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:c1,ui5ComponentName:c1.name},{},[],h.Visualization).then(d1);};var f1=function(){var h1={componentData:X,url:c1.url,name:c1.name,async:false};Z=sap.ui.component(h1);var i1={componentHandle:{getInstance:function(){return Z;}}};return d1(i1);};if(a1){E.once("CoreResourcesComplementLoaded").do(function(){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(h1){e1(h1).then(function($){b1.resolve($);}).fail(function(i1){b1.reject(i1);});});});}else{var g1=f1();b1.resolve(g1);}return b1.promise();};this._createTileComponentProperties=function(T,e){var K={};if(typeof e==="string"){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){K.name=D;}else{K.name=S;}return K;}if(typeof e==="object"&&e!==null){K=e.componentProperties||{};K.name=e.componentName;}return K;};this._getTileView=function(e){var K,N,Q=new q.Deferred();if(typeof e!=="object"||!e.id){N="Invalid input parameter passed to _getTileView: "+e;L.error(N);return Q.reject(N).promise();}K=this._mResolvedTiles[e.id];if(K){return this._getTileUiComponentContainer(e,K,false);}N="No resolved tile found for tile ID: "+e.id;L.error(N);return Q.reject(N).promise();};this._getCatalogTileView=function(e){if(typeof e!=="object"){throw new Error(e);}return this._getTileUiComponentContainerSync(e,e,true);};this._getCatalogTileViewControl=function(e){var K=new q.Deferred();if(typeof e!=="object"){var N="Invalid input parameter passed to _getCatalogTileView: "+e;L.error(N);return K.reject(N).promise();}return this._getTileUiComponentContainer(e,e,true);};this._createTileComponentData=function(T,e,K){var N=e?this.getCatalogTileTitle(T):this.getTileTitle(T),Q=e?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),X=e?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),Y=e?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),Z=e?this.getCatalogTileTargetURL(T):this.getTileTarget(T),$=this.getTileIndicatorDataSource(T),a1={properties:{},startupParameters:{}};if(K.tileResolutionResult.isCustomTile===true&&K.tileResolutionResult.startupParameters){a1.startupParameters=K.tileResolutionResult.startupParameters;}if(N){a1.properties.title=N;}if(Y){a1.properties.info=Y;}if(Q){a1.properties.subtitle=Q;}if(X){a1.properties.icon=X;}if(Z){a1.properties.targetURL=Z;}if($.indicatorDataSource){a1.properties.indicatorDataSource=$.indicatorDataSource;if($.dataSource){a1.properties.dataSource=$.dataSource;}}if(K.tileResolutionResult){a1.properties.navigationMode=K.tileResolutionResult.navigationMode;}return a1;};this._createLinkInstance=function(T,e,N,K,o){var Q,X,Y,Z=this.getTileSubtitle(T);var G=K;if(e===true){Q=this.getCatalogTileTitle(T);}else{Q=this.getTileTitle(T);}X=new G({mode:j.LineMode,subheader:Z,header:Q,url:W.getLeanURL(this.getTileTarget(T)),press:function($){this._genericTilePressHandler(T,$);}.bind(this)});if(N){Y=o.i18n.getText(N+"NavigationMode");X.setAriaLabel(Y+" "+Q+" "+Z);}this._mResolvedTiles[T.id].linkTileControl=X;return X;};this._genericTilePressHandler=function(T,e){var K;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){K=this.getTileTarget(T);if(K){if(K[0]==="#"){hasher.setHash(K);}else{W.openURL(K,"_blank");}}}};this._addTileToSite=function(e,K,N,Q){var T=this,X=new q.Deferred(),Y=c.parseShellHash(N.properties.targetURL),Z={id:T.getTileId(N),target:{semanticObject:Y.semanticObject,action:Y.action,parameters:I(Y.params)}};e.groups[K.identification.id].payload.tiles.push(Z);Q.save().done(function(){X.resolve(Z);}).fail(function($){X.reject($);});return X.promise();};this.addTile=function(e,K){var N=new q.Deferred(),Q,T=this.oCDMService,X;if(!K){K=_;}if(e.contentProviderId){if(e.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(e),K);}return N.reject("Extension Tile without URL").promise();}X=w();X.appId=e.tileResolutionResult.appId;this._mResolvedTiles[X.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};T.getSite().done(function(Y){Y.groups[K.identification.id].payload.tiles.push(X);T.save().done(function(){N.resolve(X);}).fail(function(Z){N.reject(Z);});}).fail(function(Y){Q="Failed to add tile with id '"+X.id+"' to group with id '"+K.identification.id+"'. ";N.reject(Q+Y);});return N.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var K={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){K.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;K.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return K;};this.removeTile=function(K,T,N){var Q=this.oCDMService,X,Y=new q.Deferred(),Z=this;if(!K||typeof K!=="object"||!K.identification||!K.identification.id||!T||typeof T!=="object"||!T.id){return Y.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}X="Failed to remove tile with id '"+T.id+"' from group with id '"+K.identification.id+"'. ";Q.getSite().done(function($){var a1,b1;N=+N;try{a1=$.groups[K.identification.id].payload;}catch(e){Y.reject($.groups[K.identification.id],X);}b1=Z.getTileType(T)===Z.TileType.Link?"links":"tiles";if(Z.getTileType(T)===Z.TileType.Link){N-=a1.tiles.length;}if(N>=0){a1[b1].splice(N,1);}else{a1[b1]=a1[b1].filter(function(c1){return c1.id!==T.id;});}Q.save().done(function(){Y.resolve();}).fail(function(c1){L.error(c1);Y.reject($.groups[K.identification.id],c1);});}).fail(function(e){Y.reject({},X+e);});return Y.promise();};this.moveTile=function(T,e,K,N,Q,X){var Y=new q.Deferred(),Z=this.oCDMService,$=this,a1;if(!T||g(T)||e===undefined||e<0||K===undefined||K<0||!N||!N.identification||!N.identification.id||!Q||!Q.identification||!Q.identification.id){return Y.reject("Invalid input parameters").promise();}a1="Failed to move tile with id '"+T.id+"'. ";Z.getSite().done(function(b1){var c1,d1,e1=$.getTileType(T)===$.TileType.Link?"links":"tiles";if(!X){X=$._mResolvedTiles[T.id].isLink?"link":"tile";}c1=X==="link"?"links":"tiles";if(e1!==c1&&$._mResolvedTiles[T.id]){$._mResolvedTiles[T.id].isLink=X==="link";}if(c1==="links"){K-=b1.groups[Q.identification.id].payload.tiles.length;}if(e1==="links"){e-=b1.groups[N.identification.id].payload.tiles.length;}if(N.identification.id===Q.identification.id){if(e!==K||e1!==c1){d1=b1.groups[Q.identification.id].payload;d1[e1].splice(e,1);d1[c1].splice(K,0,T);}else{return Y.resolve(T).promise();}}else{b1.groups[N.identification.id].payload[e1].splice(e,1);b1.groups[Q.identification.id].payload[c1].splice(K,0,T);}Z.save().done(function(){Y.resolve(T);}).fail(function(f1){L.error(a1+f1);Y.reject(a1+f1);});return undefined;}).fail(function(b1){L.error(a1+b1);Y.reject(a1+b1);});return Y.promise();};this._compareCatalogs=function(e,K){if(e.identification.id>K.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,K=new q.Deferred(),N=[];function Q(T,X,N,Y,Z,$){var a1=T.catalogs[X];if(Z&&$){a1.contentProviderId=Z;$.catalogsMap[X]=a1;}N.push(a1);Y.notify(a1);}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(T){T.getSite().done(function(X){Object.keys(X.catalogs).forEach(function(Y){Q(X,Y,N,K);});T.getExtensionSites().progress(function(Y){var Z=Y.providerId;var $=Y.site;var a1=Promise.resolve($);var b1={sitePromise:a1,site:$,catalogsMap:{}};Object.keys($.catalogs).forEach(function(c1){e._mContentProviders[Z]=b1;Q($,c1,N,K,Z,b1);});}).done(function(Y){Y.filter(function(Z){return!Z.success;}).forEach(function(Z,$){N.push({identification:{id:Z.providerId},contentProviderId:Z.providerId,error:"The following content providers could not provide catalogs: "+Z.providerId+(Z.error?" -> "+Z.error:"")});});K.resolve(N.sort(e._compareCatalogs));});});},0);return K.promise();};this._isStartableInbound=function(e){var N=["Shell-plugin","Shell-bootConfig"],K;if(!e.semanticObject||!e.action){return false;}if(N.indexOf(e.semanticObject+"-"+e.action)>-1){return false;}if(!O.get("signature.parameters",e)){return true;}K=Object.keys(e.signature.parameters).every(function(P){return!e.signature.parameters[P].filter||(!!e.signature.parameters[P].launcherValue||P==="sap-external-url");});return K;};this._isHiddenInbound=function(e){return!!e.hideLauncher;};this._toHashFromInbound=function(e){var K=b.toHashFromInbound(e);if(!K){return undefined;}return"#"+K;};this._getExternalUrlFromInbound=function(e){return O.get("signature.parameters.sap-external-url.launcherValue.value",e)||null;};this._toHashFromOutbound=function(e){var K=b.toHashFromOutbound(e);if(!K){return undefined;}return"#"+K;};this._isCustomTile=function(e){if(U.getMember(e,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(e){var K=this,N=new q.Deferred();if(typeof e!=="object"||e===null){return N.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise();}if(e.contentProviderId&&this._mContentProviders[e.contentProviderId]){this._mContentProviders[e.contentProviderId].sitePromise.then(function(Q){t.call(K,e,Q).done(N.resolve).fail(N.reject);},function(Q){N.reject("Failed to get site: "+Q);});}else{K.oCDMService.getSite().done(function(Q){t.call(K,e,Q).done(N.resolve).fail(N.reject);}).fail(function(Q){N.reject("Failed to get site: "+Q);});}return N.promise();};this.isCustomTile=function(e){return!(e===S||e===D);};function t(e,K){var N=this,Q=new q.Deferred();setTimeout(function(){var T=((e.payload&&e.payload.appDescriptors)||[]).reduce(function(X,Y){var Z=K.applications[Y.id],$,a1,b1,c1,d1,e1,f1,g1,h1,i1,j1,k1;if(!Z){return X;}$=N._getMember(Z,"sap|app.crossNavigation.inbounds");if(!$||Object.keys($).length===0){return X;}b1=Object.keys($)[0];c1=$[b1];if(N._isStartableInbound(c1)&&!N._isHiddenInbound(c1)){d1=b.mapOne(b1,c1,Z);if(!d1||!d1.tileResolutionResult){return X;}h1=d1.resolutionResult.applicationType;k1=a.last("/core/navigation/enableInPlaceForClassicUIs");j1=k1?k1[h1]:false;i1=d1.resolutionResult.additionalInformation;d1.tileResolutionResult.navigationMode=n.computeNavigationModeForHomepageTiles(h1,i1,j1);e1=d1.tileResolutionResult;a1=N._toHashFromInbound(c1);if(e.contentProviderId){g1=N._getMember(Z,"sap|app.crossNavigation.inbounds.Shell-launchURL.signature.parameters.sap-external-url.launcherValue.value");}f1={id:g1||a1,tileIntent:g1||a1,tileResolutionResult:e1,isCatalogTile:true};if(e.contentProviderId&&g1){f1.contentProviderId=e.contentProviderId;f1.externalUrl=g1;}X.push(f1);}return X;},[]);Q.resolve(T);},0);return Q.promise();}this.getCatalogError=function(e){if(e.error){return e.error;}return undefined;};this.getCatalogId=function(e){return R.getCatalogId(e);};this.getCatalogTitle=function(e){return R.getCatalogTitle(e);};this._isGroupTile=function(T){return r.isGroupTile(T);};this._isCatalogTile=function(T){return!!(T&&T.isCatalogTile);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(T)]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[r.getTileId(T)]);};this.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined;}if(e.isBookmark&&O.get("target.url",e)){return e.target.url;}return(this._mResolvedTiles[r.getTileId(e)]||{}).tileIntent;}if(this._isCatalogTile(e)){return e.id;}return undefined;};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return"";}return this._mResolvedTiles[e.id].tileResolutionResult.title;}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined;}return e.tileResolutionResult.title;}return undefined;};this.getCatalogTileSize=function(e){return e.tileResolutionResult.size||"1x1";};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewControl(e);};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy");}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound);}return e.tileIntent||"";}return this.getTileTarget(e);};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e);}return(e.tileResolutionResult&&e.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e);}return(e.tileResolutionResult&&e.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(e){var K=[],N=e;if(!N){L.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return K;}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){N=this._mResolvedTiles[e.id];}if(N&&N.tileResolutionResult&&N.tileResolutionResult.title){K.push(N.tileResolutionResult.title);}if(N&&N.tileResolutionResult&&N.tileResolutionResult.subTitle){K.push(N.tileResolutionResult.subTitle);}return K;};this._visitBookmarks=function(e,K){var N=this.oCDMService;var Q;var T=c.parseShellHash(e);if(T){Q=H(T);}else{Q=F(e);}return N.getSite().then(function(X){var Y=X.groups;var Z=Object.keys(Y).filter(function($){return!Y[$].payload.locked;}).map(function($){return Y[$].payload.tiles.filter(function(a1){return a1.isBookmark&&y(Q,a1.target);});}).reduce(function($,a1){Array.prototype.push.apply($,a1);return $;},[]);if(!K){return Z.length;}return q.when(Z.map(K)).then(function(){return Z.length;});});};this.addBookmark=function(e,K){var N=this;return new q.Deferred(function(Q){var T=N.oCDMService;q.when(K||N.getDefaultGroup(),T.getSite()).done(function(K,X){var Y,Z,$=c.parseShellHash(e.url),a1,b1=false;if(!$){Z=F(e.url);b1=true;}else{Z=H($);}Y=v(e,Z);if(b1){a1=new q.Deferred();a1.resolve(N._getTileForUrl(Y));}else{a1=N._getTileFromHash(e.url);}a1.done(function(c1){c1.isLink=false;N._mResolvedTiles[Y.id]=c1;X.groups[K.identification.id].payload.tiles.push(Y);T.save().done(function(){Q.resolve(Y);}).fail(function(d1){Q.reject(d1);});}).fail(function(c1){Q.reject("Bookmark creation failed because: "+c1);});}).fail(function(X){Q.reject(X);});}).promise();};this.countBookmarks=function(e){return this._visitBookmarks(e);};this.updateBookmarks=function(e,K){var N=this.oCDMService;var Q=this._mResolvedTiles;function T(X){return new q.Deferred(function(Y){var Z,$;var a1;var b1=false;var c1={};if(K.url||K.url===""){Z=c.parseShellHash(K.url);if(!Z){$=F(K.url);}else{$=H(Z);}}if(X.icon!==K.icon){c1.icon=K.icon;b1=true;}if(X.title!==K.title){c1.title=K.title;b1=true;}if(X.subTitle!==K.subtitle){c1.subtitle=K.subtitle;b1=true;}if(K.url&&e!==K.url){c1.targetURL=K.url;b1=true;}if(X.info!==K.info){c1.info=K.info;b1=true;}x(X,K,$);if(b1&&Q[X.id]){a1=Q[X.id].tileComponent;if(a1){a1.tileSetVisualProperties(c1);}}Y.resolve(X);}).promise();}return this._visitBookmarks(e,T).then(function(X){return N.save().then(function(){return X;});});};this.deleteBookmarks=function(e){var K=this.oCDMService;var N=c.parseShellHash(e);var Q;if(N){Q=H(N);}else{Q=F(e);}return K.getSite().then(function(T){var X=T.groups;var Y=Object.keys(X).map(function(Z){var $=X[Z].payload;var a1=0;$.tiles=$.tiles.filter(function(b1){if(b1.isBookmark&&y(Q,b1.target)){++a1;return false;}return true;});return a1;}).reduce(function(Z,$){Z+=$;return Z;},0);return K.save().then(function(){return Y;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,e){var K=new q.Deferred(),N,Q,X,Y,Z,$,a1;if(!T||!T.id||!e){return K.reject().promise();}Q=e.oTitleInput.getValue();Y=e.oSubTitleInput.getValue();X=e.oInfoInput.getValue();Z=this.getTileTitle(T);$=this.getTileInfo(T);a1=this.getTileSubtitle(T);if(Z===Q&&a1===Y&&$===X){return K.resolve().promise();}N={};if(Z!==Q){N.title=Q;T.title=Q;}if(a1!==Y){N.subtitle=Y;T.subTitle=Y;}if($!==X){N.info=X;T.info=X;}if(this._mResolvedTiles[T.id].tileComponent){this._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(N);}else if(this._mResolvedTiles[T.id].linkTileControl){if(N.title){this._mResolvedTiles[T.id].linkTileControl.setHeader(N.title);}if(N.subtitle){this._mResolvedTiles[T.id].linkTileControl.setSubheader(N.subtitle);}if((N.title)||(N.subtitle)){this._mResolvedTiles[T.id].linkTileControl.rerender();}}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(b1){b1.save().fail(function(c1){L.error(c1);K.reject("Could not save personalization changes: "+c1);}).done(function(){K.resolve();});});return K.promise();};this.getTileActions=function(T){var e=[],K,N;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){N=new J({config:{display_title_text:this.getTileTitle(T),display_subtitle_text:this.getTileSubtitle(T),display_info_text:this.getTileInfo(T)}});K=d.getTileSettingsAction(N,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(K);}return e;};function v(e,T){var K=w(e,T);K.isBookmark=true;return K;}function w(e,T){var K={id:U.generateUniqueId([])};x(K,e,T);return K;}function x(T,e,K){e=q.extend(true,{},e);if(K){T.target=K;}if(e.title||e.title===""){T.title=e.title;}if(e.icon||e.icon===""){T.icon=e.icon;}if(e.subtitle||e.subtitle===""){T.subTitle=e.subtitle;}if(e.info||e.info===""){T.info=e.info;}if(e.dataSource){T.dataSource={};q.extend(true,T.dataSource,e.dataSource);delete e.serviceUrl;}else if(e.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete e.serviceUrl;}if((e.dataSource||T.dataSource)&&e.serviceUrlPath){T.indicatorDataSource={path:e.serviceUrlPath};}if(e.serviceUrl||e.serviceUrl===""){if(T.dataSource){L.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:e.serviceUrl};}else if(e.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(e.serviceRefreshInterval||e.serviceRefreshInterval===0){T.indicatorDataSource.refresh=e.serviceRefreshInterval;}}function y(T,e){if(T&&e){if(T.url){return T.url===e.url;}return T.semanticObject===e.semanticObject&&T.action===e.action&&z(T.parameters,e.parameters)&&T.appSpecificRoute===e.appSpecificRoute;}return T===e;}function z(e,K){var N,Q;e=e||[];K=K||[];if(e.length===K.length){N=B(e);Q=B(K);return N===Q;}return false;}function B(e){return e.map(function(K){return K.name+K.value;}).sort().join();}function F(e){return{url:e};}function H(e){var T={semanticObject:e.semanticObject,action:e.action,parameters:I(e.params)};if(e.appSpecificRoute){T.appSpecificRoute=e.appSpecificRoute;}return T;}function I(e){return Object.keys(e).map(function(K){var N=e[K]&&e[K][0];return{name:K,value:N||""};});}}p.prototype._getMember=function(e,A){return U.getMember(e,A);};return p;},true);
