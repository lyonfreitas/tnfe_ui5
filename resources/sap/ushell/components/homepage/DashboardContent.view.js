// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/m/MessageStrip","sap/m/Page","sap/ui/core/AccessibleLandmarkRole","sap/ui/core/Component","sap/ui/core/mvc/View","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/thirdparty/jquery","sap/ushell/components/ComponentKeysHandler","sap/ushell/components/homepage/DashboardGroupsBox","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/ushell/resources","sap/ushell/ui/launchpad/AnchorItem","sap/ushell/ui/launchpad/AnchorNavigationBar","sap/ushell/utils","sap/ushell/components/homepage/DashboardContent.controller"],function(m,M,P,A,C,V,D,F,a,q,b,c,d,E,e,r,f,g,u,h){"use strict";return V.extend("sap.ushell.components.homepage.DashboardContent",{createContent:function(o){this.oModel=this.getController().getOwnerComponent().getModel();var i=this.oModel.getProperty("/personalization");var j=this.oModel.getProperty("/enableTileActionsIcon");this.isCombi=D.system.combi;this.isTouch=this.isCombi?false:(D.system.phone||D.system.tablet);this.parentComponent=C.getOwnerComponentFor(this);this.addStyleClass("sapUshellDashboardView");this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.bIsHomeIntentRootIntent=u.isFlpHomeIntent(this.oRenderer.getShellConfig().rootIntent);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","contentRefresh",this._onDashboardShown,this);sap.ui.getCore().getEventBus().subscribe("launchpad","dashboardModelContentLoaded",this._onDashboardShown,this);this.oDoable=E.once("CoreResourcesComplementLoaded").do(function(){this.oAnchorNavigationBar.setOverflowEnabled(true);if(i||j){sap.ui.require(["sap/ushell/components/homepage/ActionMode"],function(n){n.init(this.oModel);}.bind(this));}if(i){this._createFooter();this._createActionModeButton();}}.bind(this));this.oFilterSelectedGroup=new F("isGroupSelected",a.EQ,true);this.oRenderer.getRouter().getRoute("home").attachMatched(this._onHomeNavigation,this);this.oAnchorNavigationBar=this._getAnchorNavigationBar(o);var p=[];if(d.last("/core/home/gridContainer")){var k=new M({type:"Warning",text:r.i18n.getText("gridModeWarning"),showIcon:true,showCloseButton:true});k.addStyleClass("sapUiMediumMarginBeginEnd");k.addStyleClass("sapUiMediumMarginTopBottom");p.push(k);}var l=new c();this.oDashboardGroupsBox=l.createGroupsBox(o,this.oModel);p.push(this.oDashboardGroupsBox);this.oPage=new P("sapUshellDashboardPage",{customHeader:this.oAnchorNavigationBar,landmarkInfo:{headerRole:A.Navigation,headerLabel:r.i18n.getText("Dashboard.Page.Header.AriaLabel"),contentRole:sap.ui.core.AccessibleLandmarkRole.Region,contentLabel:r.i18n.getText("Dashboard.Page.Content.AriaLabel"),rootRole:A.None},floatingFooter:true,content:p});this.oPage.addEventDelegate({onAfterRendering:function(){var n=this.getDomRef(),s=n.getElementsByTagName("section");q(s[0]).off("scrollstop",o.handleDashboardScroll);q(s[0]).on("scrollstop",o.handleDashboardScroll);}.bind(this)});return this.oPage;},getAnchorItemTemplate:function(){var t=this;var o=new f({index:"{index}",title:"{title}",groupId:"{groupId}",defaultGroup:"{isDefaultGroup}",helpId:"{helpId}",selected:false,isGroupRendered:"{isRendered}",visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(i,j,v){if(!v[i?1:0]){return false;}return j||i;}},locked:"{isGroupLocked}",isGroupDisabled:{parts:["isGroupLocked","/isInDrag","/homePageGroupDisplay"],formatter:function(i,I,s){return i&&I&&s==="tabs";}},press:function(i){t.oAnchorNavigationBar.handleAnchorItemPress(i);}});o.attachBrowserEvent("focus",function(){this.setNavigationBarItemsVisibility();}.bind(this.oAnchorNavigationBar));return o;},_getAnchorNavigationBar:function(o){var i=new g("anchorNavigationBar",{selectedItemIndex:"{/topGroupInViewPortIndex}",itemPress:[function(j){this._handleAnchorItemPress(j);},o],overflowEnabled:false});if(D.system.desktop){b.getInstance().then(function(j){i.addEventDelegate({onBeforeFastNavigationFocus:function(k){if(q(".sapUshellAnchorItem").is(":visible")){k.preventDefault();j.goToSelectedAnchorNavigationItem();}},onsapenter:function(k){k.srcControl.getDomRef().click();},onsapspace:function(k){k.srcControl.getDomRef().click();}});});}i.addStyleClass("sapContrastPlus");return i;},_actionModeButtonPress:function(){this.oDashboardGroupsBox.getBinding("groups").filter([]);var j=this.oDashboardGroupsBox.getGroups();sap.ushell.components.homepage.ActionMode.toggleActionMode(this.oModel,"Menu Item",j);this._updateAnchorNavigationBarVisibility();if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){if(this.oModel.getProperty("/tileActionModeActive")){var G=this.oModel.getProperty("/groups"),s;for(var i=0;i<G.length;i++){if(G[i].isGroupSelected){s=i;break;}}this.getController()._scrollToGroup("launchpad","scrollToGroup",{group:{getGroupId:function(){return G[s].groupId;}},groupChanged:false,focus:true});}else{this.getController()._deactivateActionModeInTabsState();}}},_createActionModeButton:function(){var o={id:"ActionModeBtn",text:r.i18n.getText("activateEditMode"),tooltip:r.i18n.getText("activateEditMode"),icon:"sap-icon://edit",press:this._actionModeButtonPress.bind(this)};var i=this.oRenderer.getShellConfig().moveEditHomePageActionToShellHeader;if(i){this._createActionModeButtonInHeader(o);}else{this._createActionModeButtonInUserMenu(o);}},_createActionModeButtonInHeader:function(o){sap.ui.require(["sap/ushell/ui/shell/ShellHeadItem"],function(S){this.oTileActionsButton=new S(o);if(d.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}if(!this.bIsHomeIntentRootIntent){this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),true);}else{this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),false,["home"]);}}.bind(this));},_createActionModeButtonInUserMenu:function(o){var i={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:o,bIsVisible:true,aStates:["home"]};if(!this.bIsHomeIntentRootIntent){i.aStates=null;i.bCurrentState=true;}this.oRenderer.addUserAction(i).done(function(j){this.oTileActionsButton=j;if(d.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}}.bind(this));},_handleEditModeChange:function(){if(this.oTileActionsButton){this.oTileActionsButton.toggleStyleClass("sapUshellAcionItemActive");}},_createFooter:function(){sap.ui.require(["sap/m/Bar","sap/m/Button","sap/m/ToolbarSpacer"],function(B,i,T){var o=new B("sapUshellDashboardFooter",{visible:"{/tileActionModeActive}",contentRight:[new T()]});var j=new i("sapUshellDashboardFooterDoneBtn",{type:m.ButtonType.Emphasized,text:r.i18n.getText("closeEditMode"),tooltip:r.i18n.getText("exitEditMode"),press:this._actionModeButtonPress.bind(this)});if(D.system.desktop){b.getInstance().then(function(k){j.addEventDelegate({onsapskipforward:function(l){l.preventDefault();e.setIsFocusHandledByAnotherHandler(true);e.sendFocusBackToShell(l);},onsapskipback:function(l){l.preventDefault();e.setIsFocusHandledByAnotherHandler(true);k.goToFirstVisibleTileContainer();},onsaptabprevious:function(l){l.preventDefault();e.setIsFocusHandledByAnotherHandler(true);k.goToFirstVisibleTileContainer();},onsaptabnext:function(l){l.preventDefault();e.setIsFocusHandledByAnotherHandler(true);e.sendFocusBackToShell(l);}});});}o.addContentRight(j);this.oPage.setFooter(o);}.bind(this));},_onDashboardShown:function(){var i=this.oRenderer&&this.oRenderer.getCurrentCoreView()==="home";if(i){if(!D.system.phone){this.oRenderer.showRightFloatingContainer(false);}this._updateAnchorNavigationBarVisibility();this.getController().resizeHandler();u.refreshTiles();if(D.system.desktop){b.getInstance().then(function(j){j.goToTileContainer();});}if(E.last("firstSegmentCompleteLoaded")){E.emit("CloseFesrRecord",Date.now());}}},_onHomeNavigation:function(){this._onDashboardShown();if(!this.bIsHomeIntentRootIntent){if(this.oRenderer.getShellConfig().moveEditHomePageActionToShellHeader){this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),true);}else{this.oRenderer.showActionButton(this.oTileActionsButton.getId(),true);}}},_updateAnchorNavigationBarVisibility:function(){var o=this.oPage.getShowHeader(),j=this.getModel().getObject("/tileActionModeActive"),v=this.getModel().getProperty("/groups").filter(function(l){if(j){return l.isGroupVisible&&l.visibilityModes[1];}return l.isGroupVisible&&l.visibilityModes[0];}),k=v.length>1;this.oPage.setShowHeader(k);if(k&&!o){var G=this.getModel().getProperty("/groups"),s=this.getModel().getProperty("/iSelectedGroup");for(var i=0;i<v.length;i++){if(v[i].getGroupId&&v[i].getGroupId()===G[s].groupId){this.oAnchorNavigationBar.setSelectedItemIndex(i);break;}}}},getControllerName:function(){return"sap.ushell.components.homepage.DashboardContent";},exit:function(){V.prototype.exit.apply(this,arguments);if(this.oAnchorNavigationBar){this.oAnchorNavigationBar.handleExit();this.oAnchorNavigationBar.destroy();}if(this.oTileActionsButton){this.oTileActionsButton.destroy();}if(this.oDoable){this.oDoable.off();}if(this.oDoneBtnLabel){this.oDoneBtnLabel.destroy();}sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRefresh",this._onDashboardShown,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","dashboardModelContentLoaded",this._onDashboardShown,this);}});});
