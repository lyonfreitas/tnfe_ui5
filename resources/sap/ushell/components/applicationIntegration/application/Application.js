// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/container/ApplicationContainer","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/UI5ComponentType","sap/base/Log","sap/base/util/ObjectPath"],function(A,P,u,q,U,a,L,O){"use strict";var o,B,b=A.getMetadata().getJSONKeys();function c(){var t=this;this.handleMessageEvent=function(C,m,M){var d=m.data;if(typeof d==="string"){try{d=JSON.parse(m.data);}catch(e){L.debug("Message received from origin '"+m.origin+"' cannot be parsed: "+e,d,"sap.ushell.components.container.ApplicationContainer");return;}}if(d.action==="pro54_setGlobalDirty"&&localStorage.getItem(C.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!A.prototype._isTrustedPostMessageSource(C,m)){L.warning("Received message from untrusted origin: "+m.origin,d,"sap.ushell.components.container.ApplicationContainer");return;}L.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+C.globalDirtyStorageKey+" value: "+d.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");u.localStorageSetItem(C.globalDirtyStorageKey,d.parameters.globalDirty,true);}else{t.handleServiceMessageEvent(C,m,d,M);}};this.handleServiceMessageEvent=function(C,m,M,d){var p=O.get("sap-ushell-config.services.PostMessage.config")||O.create("sap-ushell-config.services.PostMessage.config"),s=M&&M.service,S,f,g,h,i=false,j=P.getAPIs(),I;L.debug("Received post message request from origin '"+m.origin+"': "+JSON.stringify(M),null,"sap.ushell.components.container.ApplicationContainer");if(M.type!=="request"||!s){return;}for(var E in j){if(j.hasOwnProperty(E)){if(s.indexOf(E)!==-1){f=j[E];g=E;i=true;break;}}}if(i===false){d.bApiRegistered=false;return;}I=(s.indexOf("user.postapi.")===0);S=s.split(".")[3];if(p&&p.enabled===false){L.warning("Received message for "+S+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return;}if(!A.prototype._isTrustedPostMessageSource(C,m)){L.warning("Received message from untrusted origin '"+m.origin+"': "+JSON.stringify(m.data),null,"sap.ushell.components.container.ApplicationContainer");return;}function k(e,I){var x;if(I===true){x={oMessage:m,oMessageData:M};}else{x={matchesLocalSid:w,getLocalSystemInSidForma:v,storeSapSystemData:r,executeSetBackNavigationService:n,sendResponseMessage:l,oMessage:m,oMessageData:M,oContainer:C};}try{e(x).done(function(R){l("success",{result:R});}).fail(function(z){l("error",{message:z});});}catch(y){l("error",{message:y.message});}}function l(e,x){var R=JSON.stringify({type:"response",service:M.service,request_id:M.request_id,status:e,body:x});L.debug("Sending post message response to origin ' "+m.origin+"': "+R,null,"sap.ushell.components.container.ApplicationContainer");if(typeof m.source!=="object"||m.source===null){L.debug("Cannot send response message to origin ' "+m.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return;}m.source.postMessage(R,m.origin);}function n(m,M){var D=new q.Deferred(),e;if(M.body&&M.body.callbackMessage&&M.body.callbackMessage.service){e=A.prototype._backButtonPressedCallback.bind(null,m.source,M.body.callbackMessage.service,m.origin);}D.resolve(C.getShellUIService().setBackNavigation(e));return D.promise();}function r(x,y){var K,z,D,F=[x.id];if(arguments.length>1){F.unshift(y);}try{D=JSON.stringify(x);}catch(e){L.error("Cannot stringify and store expanded system data: "+e);}if(D){z=u.getLocalStorage();K=u.generateLocalStorageKey("sap-system-data",F);z.setItem(K,D);}}function v(){var e=sap.ushell.Container.getLogonSystem();var x=e.getName();var y=e.getClient();return"sid("+x+"."+y+")";}function w(e){return v().toLowerCase()===e.toLowerCase();}h=f.oServiceCalls[M.service.replace(g+".","")];if(h&&h.executeServiceCallFn){k(h.executeServiceCallFn,I);}else{l("error",{message:"Unknown service name: '"+M.service+"'"});}};this.init=function(i){B=i;};this.restoreArray=function(d){var e=[],i=0;while(d[i]){e.push(d[i]);i++;}return e;};this._createWaitForRendererCreatedPromise=function(){var p,r;r=sap.ushell.Container.getRenderer();if(r){L.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[];}p=new Promise(function(d,e){var f;f=function(){L.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");d();sap.ushell.Container.detachRendererCreatedEvent(f);};r=sap.ushell.Container.getRenderer();if(r){L.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");d();}else{sap.ushell.Container.attachRendererCreatedEvent(f);}});return[p];};this.createComponent=function(r,p){var t=this,d=new q.Deferred();sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(e){e.createComponent(r,p,t._createWaitForRendererCreatedPromise(),a.Application).then(d.resolve,d.reject);});return d.promise();};this.stripURL=function(s){var n=s.indexOf("?"),d=s.indexOf("#"),e;if(n>=0){e=s.substr(0,n);}else if(d>=0){e=s.substr(0,d);}else{e=s;}return e;};this.createApplicationContainer=function(s,r){var T={};this._cleanTargetResolution(r,T);o=new A("application"+s,r);this._restoreTargetResolution(r,T);if(r.appCapabilities){o.setProperty("frameworkId",r.appCapabilities.appFrameworkId,true);}o.setHandleMessageEvent(this.handleMessageEvent);B.setAppCapabilities(o,r);return o;};this.active=function(d){if(d){if(d.active){d.active();}}};this.restore=function(d){var D;if(d.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveActivate",d.appTarget);if(d.app.getUrl){D=d.app.getUrl();o=B.get(this.stripURL(D));if(o){B.restoreApp(o.sApplication);}}if(d.app.isKeepAliveSupported&&d.app.isKeepAliveSupported()===true){d.app.activate();}else{if(d.app.restore){d.app.restore();}if(d.app.getRouter&&d.app.getRouter()&&d.app.getRouter().initialize){d.app.getRouter().initialize();}if(d.app.setInitialConfiguration){d.app.setInitialConfiguration();}}o=d.app;}};this.store=function(d){var D;if(d.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveDeactivate",d.appTarget);if(d.app.getUrl){D=d.app.getUrl();o=B.get(this.stripURL(D));if(o){B.storeApp(o.sApplication);}}if(d.app.isKeepAliveSupported&&d.app.isKeepAliveSupported()===true){d.app.deactivate();}else{if(d.app.suspend){d.app.suspend();}if(d.app.getRouter&&d.app.getRouter()){d.app.getRouter().stop();}}}};this.destroy=function(d){var D,o,e=false;if(d){if(d.getUrl){D=d.getUrl();o=B.get(this.stripURL(D));if(B.isStatefulContainerSupported(o)){e=true;B.destroyApp(o.sApplication);}}if(d.destroy&&e===false){d.destroy();}}};this.setActiveAppContainer=function(C){o=C;};this.getActiveAppContainer=function(){return o;};}c.prototype._cleanTargetResolution=function(r,t){var k;if(r){for(k in r){if(b[k]===undefined){t[k]=r[k];delete r[k];}}}};c.prototype._restoreTargetResolution=function(r,t){var k;if(r){for(k in t){r[k]=t[k];}}};c.prototype.getResponseHandler=function(s,i){return P.getResponseHandler(s,i);};c.prototype.isActiveOnly=function(s,i){return P.isActiveOnly(s,i);};c.prototype.isAppTypeSupported=function(C,s,i){var d=P._getPostMesageInterface(s,i);return this.isAppTypeSupportedByPolicy(C,d);};c.prototype.isAppTypeSupportedByPolicy=function(C,p){if(C&&C.getAdditionalInformation&&C.getAdditionalInformation().startsWith("SAPUI5.Component=")){return false;}var d=p;if(!d||!d.distributionType){return false;}if(d.distributionType.indexOf("all")>=0){return true;}if(d.distributionType.indexOf("URL")>=0){return false;}if(C.getApplicationType&&d.distributionType.indexOf(C.getApplicationType())>=0){return true;}return false;};c.prototype.postMessageToIframeApp=function(C,s,i,m,w){var S=s+"."+i,M=this.createPostMessageRequest(S,m);return this.postMessageToIframe(M,C,w);};c.prototype.createPostMessageRequest=function(s,m){var r=Date.now().toString();return{"type":"request","request_id":r,"service":s,"body":m};};c.prototype.postMessageToIframe=function(m,C,w){var r=m.request_id,i=C._getIFrame();return new Promise(function(n,N){function p(E){var f;try{f=JSON.parse(E.data);if(r!==f.request_id){return;}if(f.status==="success"){n(f);}else{N(f);}window.removeEventListener("message",p);}catch(e){n();L.warning("Obtained bad response from framework in response to message "+m.request_id);L.debug("Underlying framework returned invalid response data: '"+E.data+"'");}}var M=JSON.stringify(m);L.debug("Sending postMessage "+M+" to application container '"+C.getId()+"'");var d,t;if(!i){n();}else if(w){window.addEventListener("message",p,false);d=new U(C._getIFrameUrl(i));t=d.protocol()+"://"+d.host();i.contentWindow.postMessage(M,t);}else{d=new U(C._getIFrameUrl(i));t=d.protocol()+"://"+d.host();i.contentWindow.postMessage(M,t);n();}});};c.prototype.registerShellCommunicationHandler=function(C){P.registerShellCommunicationHandler(C);};c.prototype._getPostMesageInterface=function(s,i){return P._getPostMesageInterface(s,i);};return new c();},true);
